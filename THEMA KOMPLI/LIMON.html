<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deutsch B2 Prüfung - Komplett</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    :root {
      --primary-color: #1e3a5f;
      --secondary-color: #2c5282;
      --accent-color: #4da6ff;
      --light-color: #ebf8ff;
      --text-color: #2d3748;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--white);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    button {
      cursor: pointer;
    }
    
    /* ===== START PAGE STYLES ===== */
    .start-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      min-height: 100vh;
    }
    
    .start-content {
      max-width: 600px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo {
      margin-bottom: 20px;
    }
    
    .logo-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 18px;
      margin-bottom: 30px;
      opacity: 0.9;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      color: var(--text-color);
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .card p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-color);
      outline: none;
      background-color: var(--white);
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }
    
    .timer-container {
      margin: 25px 0;
    }
    
    .timer-label {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-color);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar {
      height: 8px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress {
      height: 100%;
      width: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transform: scaleX(1);
      transform-origin: left;
      transition: transform 1s linear;
    }
    
    .info-text {
      font-size: 14px;
      margin-top: 20px;
      opacity: 0.8;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn:hover {
      background-color: #3399ff;
    }
    
    /* ===== EXAM PAGE STYLES ===== */
    .exam-body {
      background: #f5f5f5;
      color: #333;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Header Styles */
    header.topbar {
      background: #1e3a5f;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-height: 80px;
    }

    .brand {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .brand .logo {
      width: 80px;
      height: 40px;
      background: #e74c3c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }

    .meta .main-title {
      font-weight: 800;
      font-size: 18px;
    }

    .meta .sub-title {
      font-size: 13px;
      opacity: 0.9;
    }

    .timer {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      margin: 0 20px;
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 10px 20px;
    }

    .exam-btn {
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      background: #4da6ff;
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
      min-width: 150px;
      text-align: center;
    }

    .exam-btn:hover {
      background: #336fbf;
    }
    
    .exam-btn.save {
      background: #4da6ff;
      color: #000;
    }
    
    .exam-btn.save:hover {
      background: #3399ff;
    }
    
    .exam-btn.submit {
      background: #4da6ff;
    }
    
    .exam-btn.submit:hover {
      background: #3399ff;
    }
    
    .exam-btn.result {
      background: #4da6ff;
    }
    
    .exam-btn.result:hover {
      background: #3399ff;
    }
    
    .exam-btn.next {
      background: #4da6ff;
      color: #fff;
    }
    
    .exam-btn.next:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset {
      background: #4da6ff;
    }
    
    .exam-btn.reset:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset-section {
      background: #d35400;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
    }
    
    .exam-btn.reset-section:hover {
      background: #e67e22;
    }
    
    .exam-btn.no-match {
      background: #95a5a6;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
      margin-top: 5px;
    }
    
    .exam-btn.no-match:hover {
      background: #7f8c8d;
    }
    
    .exam-btn.no-match.selected {
      background: #e74c3c;
    }
    
    /* Top Tiles */
    .top-tiles {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1e3a5f;
      border-bottom: 1px solid #0f223a;
    }
    
    .tile {
      flex: 1;
      max-width: 180px;
      text-align: center;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #3b4a63;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    
    .tile:hover {
      background: #4a5b78;
    }
    
    .tile.active {
      background: #ffffff;
      color: #000;
      border-color: #bbb;
    }
    
    .tile.done {
      background: #2ecc71;
      color: #fff;
      border-color: #27ae60;
    }
    
    .tile.done::after {
      content: " ✅";
      margin-left: 5px;
    }
    
    .tile .points {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .tile.active .points {
      background: #e9eefc;
      color: #2c3e50;
    }
    
    /* Container Styles */
    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-full {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .left-panel {
      background: white;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .left-panel .passage {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.8;
    }
    
    .left-panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .right-panel {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 76vh;
      overflow: auto;
    }
    
    .main-panel {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1e3a5f;
      font-weight: 700;
    }
    
    /* Question Styles */
    .question-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .question-body {
      margin-top: 8px;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .option {
      background: #fbfdff;
      border: 1px solid #e1e8f6;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .option:hover {
      background: #f0f6ff;
    }
    
    .option.selected {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .option .radio {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #cfdff6;
      background: #fff;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .option.selected .radio {
      background: #3498db;
      border-color: #3498db;
      box-shadow: inset 0 -3px 0 rgba(0,0,0,0.05);
    }
    
    .text-container {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
      position: relative;
      min-height: 120px;
    }
    
    .text-container:hover {
      background: #f0f6ff;
    }
    
    .text-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    
    .text-content {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .title-slot {
      min-height: 40px;
      margin-top: 10px;
      padding: 8px;
      border: 2px dashed #c8d9f6;
      border-radius: 6px;
      background: #f8fbff;
    }
    
    .title-slot.has-title {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .title-slot.has-x {
      background: #f8d7da;
      border-color: #e74c3c;
      color: #c0392b;
      font-weight: bold;
    }
    
    .headings-bank {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 0;
    }
    
    .heading-item {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 8px;
      background: #f8fbff;
      cursor: grab;
    }
    
    .heading-item:hover {
      background: #e9f0ff;
    }
    
    .heading-item.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .result-correct {
      color: #27ae60;
      font-weight: bold;
    }
    
    .result-incorrect {
      color: #c0392b;
      font-weight: bold;
    }
    
    .result-item {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .instructions {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 15px;
      color: #2c3e50;
    }
    
    .all-questions {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .question-block {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .texts-list, .situations-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .text-item, .situation-item {
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .text-letter {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .situation-number {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .fill-blank-container {
      margin: 20px 0;
    }
    
    .blank-word {
      display: inline-block;
      min-width: 120px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      cursor: pointer;
      position: relative;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
    }
    
    .blank-word.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .options-popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 150px;
    }
    
    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f4fb;
    }
    
    .option-item:hover {
      background: #f0f6ff;
    }
    
    .option-item:last-child {
      border-bottom: none;
    }
    
    .horizontal-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .option-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .option-number {
      font-weight: bold;
      color: #2c3e50;
      min-width: 30px;
    }
    
    .option-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .option-btn {
      padding: 8px 16px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option-btn:hover {
      background: #e9f0ff;
    }
    
    .option-btn.selected {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    .word-bank-vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .bank-word-vertical {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      text-align: center;
      cursor: grab;
    }
    
    .bank-word-vertical.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .blank-slot {
      display: inline-block;
      min-width: 100px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      min-height: 30px;
      vertical-align: middle;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .blank-slot.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .footer-buttons {
      display: flex;
      gap: 10px;
    }
    
    .situation-item.used {
      opacity: 0.7;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #333;
    }
    
    /* Listening Section Styles */
    .listening-task {
      margin-bottom: 10px;
    }
    
    .true-false-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .true-false-table th {
      background: #3498db;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    
    .true-false-table td {
      padding: 15px;
      border-bottom: 1px solid #e1e8f6;
      vertical-align: top;
    }
    
    .true-false-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .true-false-table tr:hover {
      background: #e3f2fd;
    }
    
    .answer-options {
      display: flex;
      gap: 25px;
    }
    
    .answer-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 4px;
      transition: background 0.2s;
      font-weight: 500;
    }
    
    .answer-option:hover {
      background: #e3f2fd;
    }
    
    .answer-option input {
      margin: 0;
      transform: scale(1.2);
    }

    .correct-answer {
      background: #d4edda !important;
      border-left: 4px solid #28a745;
    }
    
    .incorrect-answer {
      background: #f8d7da !important;
      border-left: 4px solid #dc3545;
    }
    
    /* Writing Section Styles */
    .writing-task {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .writing-prompt {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .writing-requirements {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      margin-bottom: 15px;
    }
    
    .writing-requirements h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }
    
    .writing-requirements ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .writing-requirements li {
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    .writing-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .writing-textarea {
      flex: 1;
      min-height: 500px;
      padding: 15px;
      border: 2px solid #e1e8f6;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    
    .writing-textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .word-counter {
      margin-top: 10px;
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
      padding: 8px 0;
    }
    
    .word-counter .count {
      font-weight: bold;
      color: #2c3e50;
    }
    
    /* Results Page Styles */
    .results-body {
      background: #f7fafc;
      color: #0f1724;
      line-height: 1.6;
    }
    
    .results-header {
      background: #1e3a5f;
      color: #fff;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .results-logo {
      background: #fff;
      color: #1e3a5f;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 800;
    }
    
    .results-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .results-container {
      max-width: 1100px;
      margin: 22px auto;
      padding: 20px;
    }
    
    .results-tiles {
      display: flex;
      gap: 12px;
      margin: 18px 0;
    }
    
    .results-tile {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      border-left: 6px solid #1e3a5f;
    }
    
    .results-tile h3 {
      margin: 0;
      font-size: 16px;
      color: #1e3a5f;
    }
    
    .results-tile .score {
      font-size: 20px;
      font-weight: 800;
      margin-top: 8px;
    }
    
    .section-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .section-table th,
    .section-table td {
      padding: 8px;
      border-bottom: 1px solid #e6eef8;
      text-align: left;
      font-size: 14px;
    }
    
    .summary {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .summary .left {
      font-weight: 700;
    }
    
    .summary .right {
      text-align: right;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    
    .results-btn {
      background: #4da6ff;
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .results-btn:hover {
      background: #3a8ce0;
    }
    
    .button-like {
      text-decoration: none;
    }
    
    .small-muted {
      color: #6b7280;
      font-size: 13px;
    }
    
    input[type="number"] {
      width: 90px;
      padding: 8px;
      border: 1px solid #d7e6fb;
      border-radius: 6px;
    }
    
    .note {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    /* Footer */
    footer.controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e1e8f6;
      margin-top: 20px;
    }
    
    .status {
      font-size: 14px;
      color: #7f8c8d;
    }
    
    .ghost {
      background: transparent;
      border: 2px solid #2c3e50;
      color: #2c3e50;
    }
    
    .ghost:hover {
      background: #2c3e50;
      color: white;
    }

    /* Responsive Styles */
    @media (max-width: 980px) {
      .container {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .container-split {
        grid-template-columns: 1fr;
      }
      
      .right-panel {
        order: 2;
      }
      
      .top-tiles {
        padding-left: 8px;
        padding-right: 8px;
      }
      
      header.topbar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .answer-options {
        flex-direction: column;
        gap: 10px;
      }
      
      footer.controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .results-tiles {
        flex-direction: column;
      }
      
      .summary {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 600px) {
      .start-content {
        padding: 25px 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .card {
        padding: 20px 15px;
      }
    }
  </style>
</head>
<body id="body">
  <!-- Start Page -->
  <div id="start-page" class="start-container">
    <div class="start-content">
      <div class="logo">
        <div class="logo-icon">📝</div>
        <h1>Deutsch B2 Prüfung</h1>
        <div class="subtitle">Bereiten Sie sich auf Ihre Prüfung vor</div>
      </div>
      <div class="card">
        <h2>Prüfungsbereich auswählen</h2>
        <p>Wählen Sie bitte den Bereich aus, den Sie üben möchten. Die Prüfung startet automatisch in <span id="time-display">30</span> Sekunden.</p>
        <select id="sectionSelect">
          <option value="lesen">Lesen</option>
          <option value="hoeren">Hören</option>
          <option value="schreiben">Schreiben</option>
        </select>
        <div class="button-container">
          <button id="cancelBtn" class="btn">Abbrechen</button>
          <button id="startBtn" class="btn">Jetzt starten</button>
        </div>
      </div>
      <div class="timer-container">
        <div class="timer-label">Die Prüfung startet in:</div>
        <div class="timer" id="countdown">30</div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
      </div>
      <div class="info-text">Stellen Sie sicher, dass Sie in einer ruhigen Umgebung sind und genügend Zeit haben.</div>
    </div>
  </div>

  <!-- Lesen Page -->
  <div id="lesen-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Lesen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-lesen" class="timer" aria-live="polite">Verbleibende Zeit: 90:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-lesen" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-lesen" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-lesen" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-lesen" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-lesen">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-lesen" role="navigation" aria-label="Sections overview"></div>

    <div class="container">
      <main class="left-panel" id="leftPanel-lesen">
        <div class="passage" id="passage-lesen">
          <h2 id="passageTitle-lesen">Aufgabe</h2>
          <div id="passageContent-lesen"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-lesen" aria-labelledby="questionTitle-lesen">
        <div class="question-head">
          <div>
            <div id="sectionName-lesen" style="font-weight:800"></div>
            <div id="questionTitle-lesen" style="font-size:13px;color:#55607a">Frage</div>
          </div>
          <button id="resetSectionBtn-lesen" class="exam-btn reset-section" style="display:none;">Teil zurücksetzen</button>
        </div>
        <div class="question-body" id="questionBody-lesen"></div>
        <div id="headingsBankContainer-lesen"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-lesen" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-lesen" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-lesen">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Hören Page -->
  <div id="hoeren-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Hörverstehen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-hoeren" class="timer" aria-live="polite">Verbleibende Zeit: 17:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-hoeren" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-hoeren" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-hoeren" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-hoeren" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-hoeren">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-hoeren" role="navigation" aria-label="Sections overview"></div>

    <div class="container-full">
      <main class="main-panel" id="mainPanel-hoeren">
        <div id="contentContainer-hoeren"></div>
      </main>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-hoeren" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-hoeren" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-hoeren">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Schreiben Page -->
  <div id="schreiben-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Schreiben — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-schreiben" class="timer" aria-live="polite">Verbleibende Zeit: 30:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-schreiben" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-schreiben" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-schreiben" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-schreiben" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-schreiben">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-schreiben" role="navigation" aria-label="Sections overview"></div>

    <div class="container-split">
      <main class="left-panel" id="leftPanel-schreiben">
        <div class="passage" id="passage-schreiben">
          <h2 id="passageTitle-schreiben">Aufgabe</h2>
          <div id="passageContent-schreiben"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-schreiben">
        <div id="writingContainer-schreiben"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-schreiben" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-schreiben" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-schreiben">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Ergebnisse Page -->
  <div id="ergebnisse-page" class="results-page" style="display: none;">
    <header class="results-header">
      <div class="results-logo">telc</div>
      <div class="results-title">Gesamtergebnis — Deutsch B2</div>
    </header>

    <div class="results-container">
      <div class="results-tiles" id="topTiles-ergebnisse"></div>
      <div id="details-ergebnisse"></div>
      <div class="summary" id="finalSummary-ergebnisse"></div>
      <div class="controls">
        <a class="button-like" href="#" id="backBtn-ergebnisse">
          <button class="results-btn">🔁 Zurück zur Startseite</button>
        </a>
        <button id="calcBtn-ergebnisse" class="results-btn">✅ Ergebnisse anzeigen</button>
      </div>
      <div class="note">Hinweis: Schreiben (45 Punkte) wird manuell eingegeben, falls nicht automatisch vorhanden.</div>
    </div>
  </div>

  <script>
    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      // Hide all pages
      document.getElementById('start-page').style.display = 'none';
      document.getElementById('lesen-page').style.display = 'none';
      document.getElementById('hoeren-page').style.display = 'none';
      document.getElementById('schreiben-page').style.display = 'none';
      document.getElementById('ergebnisse-page').style.display = 'none';
      
      // Change body class based on page
      document.getElementById('body').className = '';
      if (pageId === 'ergebnisse-page') {
        document.getElementById('body').className = 'results-body';
      } else if (pageId !== 'start-page') {
        document.getElementById('body').className = 'exam-body';
      }
      
      // Show selected page
      document.getElementById(pageId).style.display = 'block';
      
      // Initialize the page if needed
      if (pageId === 'lesen-page' && typeof initLesenPage === 'function') {
        initLesenPage();
      } else if (pageId === 'hoeren-page' && typeof initHoerenPage === 'function') {
        initHoerenPage();
      } else if (pageId === 'schreiben-page' && typeof initSchreibenPage === 'function') {
        initSchreibenPage();
      } else if (pageId === 'ergebnisse-page' && typeof initErgebnissePage === 'function') {
        initErgebnissePage();
      }
    }

    // ===== START PAGE FUNCTIONALITY =====
    let initialCounter = 30;
    let counter = initialCounter;
    let countdownInterval;
    let countdownRunning = false;
    let examStarted = false;
    const timerEl = document.getElementById("countdown");
    const timeDisplayEl = document.getElementById("time-display");
    const progressEl = document.getElementById("progress");
    const selectEl = document.getElementById("sectionSelect");
    const startBtn = document.getElementById("startBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function startCountdown() {
      // prevent double-starts or starting after exam already began
      if (countdownRunning || examStarted) return;
      countdownRunning = true;
      // disable start button while counting
      try { startBtn.disabled = true; startBtn.setAttribute('aria-disabled','true'); } catch(e){}
      // reset counter & UI
      counter = initialCounter;
      timerEl.textContent = counter;
      timeDisplayEl.textContent = counter;
      progressEl.style.transform = "scaleX(0)";
      timerEl.style.color = "";

      countdownInterval = setInterval(() => {
        counter--;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
        const progressValue = (initialCounter - counter) / initialCounter;
        progressEl.style.transform = `scaleX(${progressValue})`;
        if (counter <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRunning = false;
          progressEl.style.transform = "scaleX(1)";
          // ensure exam starts only once
          if (!examStarted) {
            examStarted = true;
            startExam();
          }
          // safety: re-enable start button (page usually navigates away)
          try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
        }
      }, 1000);
    }

    function stopCountdown(reset = true) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownRunning = false;
      try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
      progressEl.style.transform = "scaleX(0)";
      if (reset) {
        counter = initialCounter;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
      } else {
        timerEl.textContent = "Gestoppt";
      }
    }

    function startExam() {
      // guard to ensure startExam is triggered once
      if (!examStarted) examStarted = true;
      const selectedSection = selectEl.value;
      if (selectedSection === 'lesen') {
        showPage('lesen-page');
      } else if (selectedSection === 'hoeren') {
        showPage('hoeren-page');
      } else if (selectedSection === 'schreiben') {
        showPage('schreiben-page');
      }
    }

    // wire buttons: start will now start the countdown (not the exam directly)
    startBtn.addEventListener('click', startCountdown);

    cancelBtn.addEventListener('click', () => {
      stopCountdown(true);
      timerEl.textContent = "Abgebrochen";
      timerEl.style.color = "#e53e3e";
    });

    // ===== LESEN PAGE FUNCTIONALITY =====
    function initLesenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-001",
        durationSec: 90 * 60,
        sections: [
          { 
            id: "s1", 
            title: "Leseverstehen, Teil 1", 
            points: 25,
            passageTitle: "Aufgabe: Ziehen Sie die passenden Überschriften auf die Texte.",
            passage: "",
            questions: [],
            texts: [
              {
                id: "text1",
                content: "Möchten Sie Kraft, Jugend und Gesundheit aus der Flasche? Dann suchen Sie bei Ihren nächsten Einkauf im Supermarkt nach Sauerstoff-Mineralwasser. Für den etwa doppelten Preis eines normalen Mineralwassers erhalten Sie dann ein Getränk, von dem die Hersteller versprechen, dass es Ihnen natürlich nur, wenn Sie es regelmäßig trinken magische Kräfte verleiht. In einer Umfrage wurden Schülerinnen und Schüler in Bayern nach ihren Erfahrungen mit den Sauerstoffkraftdrink befragt. Die meisten fanden, dass es nicht anders schmeckt als andere Mineralwässer auch. Das Deutsche Institut für Ernährungsforschung in Potsdam hält es für Unsinn, Wasser mit Sauerstoff anzureichern. Der menschliche Körper nimmt Sauerstoff hauptsächlich über die Atemluft auf, höchsten 0,3 % können auch über den Magen-Darm-Trakt aufgenommen werden. Möchten Sie innere Kraft, Jugend und Gesundheit? Dann gehen Sie doch einfach mehr an die frische Luft. Und die ist kostenlos.",
                correctAnswer: "e"
              },
              {
                id: "text2", 
                content: "Wenn es regnet, dann fließt das Regenwasser in den Erdboden, der es wie ein Schwamm aufsaugt. Langsam sickert das Wasser dann in immer tiefere Erdschichten, in denen es gefiltert und gereinigt wird. Aus dem Regenwasser ist Trinkwasser geworden. Schließlich sammelt es sich in einer Schicht aus Sandstein, wo es sich mit älterem Wasser vermischt. Mehrere tausend Jahre lang kann das Trinkwasser so in den Tiefen der Erde ruhen. Durch Brunnen, die bis in die tiefen Sandsteinschichten reichen, kann dann Mineralwasser gewonnen werden. 10,6 Milliarden Liter Mineralwasser sind im letzten Jahr in Deutschland verkauft und getrunken worden. Gesteinsschichten wie Ton oder Kalk schützen es seit Jahrtausenden vor Verunreinigungen. Jedoch gelangt in den letzten Jahrzehnten Nitrat durch übermäßige Düngung in der Landwirtschaft vermehrt in das Trinkwasser und stellt langfristig eine Gesundheitsbedrohung für die Menschen dar.",
                correctAnswer: "j"
              },
              {
                id: "text3",
                content: "Nach den Unwettern der letzten Sommer sprechen Meteorologen in ganz Europa davon, dass sich das Klima weltweit dramatisch verändert. Stabile Sommer mit Sonnenschein pur von Juni bis August sollen selbst am Mittelmeer in Zukunft passé sein. Die durch Treibhausgase aufgeheizte Atmosphäre hat sich erwärmt, mehr Wasser verdunstet durch die höheren Temperaturen aus den Ozeanen und prasselt in extrem starken Unwettern mit Donner, Blitz und Hagel auf die Erde. Dort kann die Erde nicht mehr solche Mengen Wassers aufnehmen wie in kürzester Zeit fallen. Die Folge davon sind Überschwemmungen. Kurze Sonnenscheinperioden werden sich mit Unwetterfronten abwechseln und vielen Menschen den Badespaß an den Stränden nicht nur des Mittelmeeres gründlich verderben. Doch auch den Landwirten bereiten die stärkeren Unwetter Sorgen. Denn die starken Niederschläge mit Hagel zerstören nicht selten einen großen Teil der Ernte und bescheren so manchen landwirtschaftlichen Betrieben große finanzielle Probleme.",
                correctAnswer: "g"
              },
              {
                id: "text4",
                content: "Wozu noch Kästen mit Mineralwasserflaschen nach Hause schleppen, wenn es sich doch bequem zu Hause zubereiten lässt. Tatsächlich ist das Leitungswasser, das aus den Wasserhähnen in deutschen Wohnungen fließt, von guter bis sehr guter Qualität. Einzig das Prickeln auf der Zunge, das durch das Hinzufügen von Kohlensäure in viele Mineralwässer entsteht, fehlt bei dem Leitungswasser. Doch auch hier gibt es bereits eine preiswerte Möglichkeit, dies selbst zu tun: mit einer Sodamaschine. Damit lassen sich Sprudel und Limonaden selbst herstellen, ganz nach dem individuellen Geschmack des Nutzers: mal mit mehr, mal mit weniger Prickeln, mal süßer, mal fruchtiger. Und das Wasser kommt wie von selbst ins Haus, das Tragen und Stapeln von Getränkekästen ist für den cleveren Selbsthersteller Vergangenheit.",
                correctAnswer: "h"
              },
              {
                id: "text5",
                content: "\"Wasser ist zum Waschen da\" lautete ein deutscher Schlager Mitte der 1950er, in dem es weiter hieß: \"Auch zum Zähneputzen kann man es benutzen.\" Wasser zu trinken schien damals manchen Leuten nicht in die neue Wohlstandswelt zu passen. Süße Limonaden galten als besser als einfach nur Wasser. Dabei raten heute die meisten Ärzte zum Wassertrinken: \"Trinken Sie täglich mindestens 2,5 Liter davon\", steht auch in nahezu allen medizinischen Ratgebern von heute. Mineralwasser hat, wie man heute wieder weiß, durch seine mineralischen Inhaltsstoffe Natrium, Kalium, Magnesium, Calzium und Spurenelemente für den menschlichen Körper viele Vorteile: Es gleicht den Mineral- und Flüssigkeitenverlust beim Schwitzen aus, es fördert die Verdauung und das alles ohne den Körper belastenden Zucker und ohne Kalorien. Ob aus der Heimat oder - wie in den jetzt modischen Wasserbars - von der Insel Hawaii oder vom Südpol: Wasser ist wieder zum Trinken da.",
                correctAnswer: "i"
              }
            ],
            headings: [
              {id: "a", text: "Limonade aus dem Wasserhahn"},
              {id: "b", text: "Limonade ist moderner als Wasser"},
              {id: "c", text: "Sommer bedeutet in Zukunft nicht unbedingt Sonne"},
              {id: "d", text: "Mehr Sauerstoff im Wasser macht müde Menschen fit"},
              {id: "e", text: "Viel Wasser trinken - Gesundheit tanken"},
              {id: "f", text: "Frische Luft macht stark"},
              {id: "g", text: "Die Sonne macht Landwirten Probleme"},
              {id: "h", text: "Sprudel hausgemacht – Zeit des Flaschen-Tragens ist vorbei"},
              {id: "i", text: "Alarm: Nitrat im Regenwasser bedroht die Gesundheit"},
              {id: "j", text: "Vom Regen zum Mineralwasser"}
            ]
          },
          { 
            id: "s2", 
            title: "Leseverstehen, Teil 2", 
            points: 25,
            passageTitle: "Krista, der tierische Star",
            passage: `Krista ist die schönste Kuh Deutschlands. Und jetzt auch noch ein Kinostar. Am letzten Donnerstag kam ein Film über die schwarz-weiß gefleckte Kuh und ihre Besitzer in einige norddeutsche Kinos. Wovon der Film handelt? Von Kristas Leben auf dem Hof der Familie Seeger in Bissel, einem kleinen Dorf in Norddeutschland.

Antje Schneider und Carsten Waldbauer sind Filmemacher. Vor einigen Jahren hatten sie die Idee, eine Dokumentation über Kühe zu machen, genauer gesagt über Holstein-Rinder. Die Holstein-Rinder sind eine der wichtigsten Rinderrassen weltweit, kommen aber trotz des deutschen Namens aus Nordamerika. Diese Kühe werden überwiegend als Milchvieh gehalten. Die Holstein-Rinder sind so verbreitet, dass sie inzwischen andere Rassen fast vollständig verdrängt haben.

Das gilt vor allem für die vielen Bauernhöfe in Deutschland, die ausschließlich Milch produzieren. Auf einem dieser Höfe wollten Antje Schneider und Carsten Waldbauer Aufnahmen für ihre Dokumentation machen, und die Wahl fiel auf den Hof der Familie Seeger. Doch als die beiden Filmemacher mit den Dreharbeiten beginnen wollten, sahen sie plötzlich – Krista. Krista änderte alles. Die Schönheit vom Lande beeindruckte Schneider und Waldbauer so sehr, dass sie den Plan für ihre Dokumentation gegen den Willen ihres Senders komplett änderten. Im Mittelpunkt sollte nun Krista stehen, die schönste Holstein-Kuh Deutschlands.

Krista gehört zur Weltelite. Auf Veranstaltungen wird sie immer wieder ausgezeichnet. Bei einer Tierschau in Italien erhielt sie zwar nicht den ersten Preis, aber trotzdem war sie unter den schönsten Kühen Europas. Kristas Besitzer Jörg Seeger ist begeistert von seinem Star im Stall.

Jörg und Janine Seeger erlauben dem Kinozuschauer interessante Einblicke in ihren Alltag auf dem Bauernhof. Die Kamera verfolgt zwar immer den Weg von Kuh Krista, aber zu sehen ist dabei natürlich auch die Arbeit der gesamten Familie auf dem Hof. Manchmal ist das auch ein romantisches Leben, es ist aber vor allem immer sehr arbeitsintensiv.

"Für mich sind Kühe nicht nur Nutztiere", sagt die Bäuerin Janine Seeger. Schon als Kind hätten ihr die Tiere Geborgenheit, manchmal Trost gespendet. Aber sie weiß, dass die Kühe Geld bringen müssen, entweder durch möglichst viel Milch oder durch viel Nachwuchs. Die kleinen Kälber lassen sich zu recht guten Preisen verkaufen, das lohnt sich für die Seegers.

Krista kann zunächst aus gesundheitlichen Gründen keine Kälber bekommen. Auch diese Problematik wird im Film gezeigt. Der Zuschauer merkt, dass Jörg Seeger enttäuscht ist: Seine beste Kuh kann kein Kalb bekommen. Aber es geht gut aus, denn Krista wird operiert und nach Ende der Dreharbeiten klappt es dann doch mit dem Nachwuchs für die Kuh.

Während der jahrelangen Dreharbeiten hat sich auch die Familie entwickelt. Mittlerweile haben die Seegers zwei Kinder. "Deshalb verändert sich im Film mein Gewicht etwas", erzählt Janine Seeger und lacht. Und wie ist es so, vor der Kamera zu stehen? "Erst ungewohnt, dann irgendwie vertraut", sagt die 32-Jährige. Zu den Filmemachern habe sich ein freundschaftliches Verhältnis entwickelt. "Wie schön, Carsten und Antje sind wieder da", habe es dann nur noch geheißen, wenn das Team anrückte.

Der Film zeigt aber auch, wie sich im Laufe der Jahre das Leben auf dem Hof der Seegers verändert hat und wie schwierig es auch hier geworden ist, mit Milchkühen Geld zu verdienen. Der Markt ist hart umkämpft und die Preise sinken immer weiter, denn die Verbraucher im Supermarkt greifen gerne zum günstigsten Produkt. Für viele ist es da nicht wichtig, wie die Milch produziert wurde. Auch das zeigt der Film, wenngleich eher nebenbei.

Familie Seeger ist stolz drauf, dass ein Film über ihren Hof und über die schöne Kuh Krista gedreht wurde. So heißt nun übrigens auch der Film: "Die schöne Krista". Am vergangenen Wochenende haben die Seegers den Film bei einem Hoffest gezeigt. Familie und Freunde sowie Nachbarn waren zu Gast, und alle haben sich über den Film gefreut.

"Die schöne Krista" ist auch in die Auswahl für den Deutschen Filmpreis gekommen, als einer der fünfzehn besten Dokumentarfilme. Die 500 Filmkritiker, die diese 15 Filme ausgewählt haben, waren begeistert. Schwieriger sei es, so die Produktionsfirma, die Kinobetreiber vom Film zu überzeugen. "Was sollen wir mit einer Kuh?", sei eine häufige Reaktion. Vielleicht würden sie ihre Meinung ändern, wenn Sie Krista einmal auf dem Hof gesehen hätten.`,
            questions: [
              {
                id: "s2q1",
                type: "single",
                text: "Holstein-Rinder",
                options: [
                  {id: "s2q1o1", text: "dominieren als Rinderrasse die Milchviehwirtschaft."},
                  {id: "s2q1o2", text: "sind für die Milchproduktion wenig geeignet."},
                  {id: "s2q1o3", text: "wurden ursprünglich in Norddeutschland gezüchtet."}
                ],
                correctAnswer: "s2q1o1"
              },
              {
                id: "s2q2",
                type: "single", 
                text: "Die Kuh Krista",
                options: [
                  {id: "s2q2o1", text: "hat bereits einige Preise gewonnen."},
                  {id: "s2q2o2", text: "war Siegerin bei einer Veranstaltung in Italien."},
                  {id: "s2q2o3", text: "wurde zur schönsten Kuh Europas gewählt."}
                ],
                correctAnswer: "s2q2o1"
              },
              {
                id: "s2q3",
                type: "single",
                text: "Während der Filmaufnahmen",
                options: [
                  {id: "s2q3o1", text: "bekam Krista ein Nachwuchs."},
                  {id: "s2q3o2", text: "wäre Krista fast gestorben."},
                  {id: "s2q3o3", text: "wurde Krista ärztlich behandelt."}
                ],
                correctAnswer: "s2q3o3"
              },
              {
                id: "s2q4",
                type: "single",
                text: "Die wirtschaftlichen Probleme von Milchbetrieben",
                options: [
                  {id: "s2q4o1", text: "betreffen die Familie Seeger nicht."},
                  {id: "s2q4o2", text: "sind eine Folge des Verbraucherverhaltens."},
                  {id: "s2q4o3", text: "werden im Film ausführlich behandelt."}
                ],
                correctAnswer: "s2q4o2"
              },
              {
                id: "s2q5", 
                type: "single",
                text: "\"Die schöne Krista\"",
                options: [
                  {id: "s2q5o1", text: "begeistert Kinobetreiber bislang nicht."},
                  {id: "s2q5o2", text: "könnte die Kritiker nicht überzeugen."},
                  {id: "s2q5o3", text: "wurde für den Deutschen Filmpreis nominiert."}
                ],
                correctAnswer: "s2q5o1"
              }
            ]
          },
          { 
            id: "s3", 
            title: "Leseverstehen, Teil 3", 
            points: 25,
            passageTitle:"Aufgabe: Lesen Sie die zehn Situationen (11-20) und die zwölf Texte (A-L). Welcher Text passt zu welcher Situation? Sie können jeden Text nur einmal verwenden. Manchmal passt kein Text. Wählen Sie dann 'x'.",
            passage: "",
            questions:[],
            texts: [
              {id: "A", text: "Sport, Theater & mehr... ...bieten wir ihnen in unserem Online-Kartenshop. Wir sind spezialisiert auf Tickets für Sportveranstaltungen in Deutschland, Theaterkarten (auch im europäischen Ausland) und bieten Ihnen darüber hinaus auch Eintrittskarten zu bekannten Fernseh-Talkshows an. Sicher haben wir auch für Sie das passende Angebot. Wählen Sie Ihre Wunschplätze einfach im Internet aus und nur zwei Tage später erhalten Sie Ihre Karten mit der Post. Bequem, sicher, schnell. Selbstverständlich bieten wir Ihnen aber auch eine persönliche Beratung unter einer kostenfreien Rufnummer an. Schauen Sie doch gleich online vorbei! www.ticketprofis.eu", correctAnswer: "14"},
              {id: "B", text: "Die Veranstaltungsprofis Seit mehr als zwanzig Jahren organisieren wir Messen (Buchmessen, Verbrauchermessen, Fahrradmessen, Automessen, Spielemessen) in ganz Europa. Wenn auch Sie sich für eine Tätigkeit im Bereich Messeorganisation und -durchführung interessieren, haben wir ein interessantes Angebot für Sie: Ab Herbst suchen wir für unser Junges motiviertes Team Verstärkung. Wenn Sie eine abgeschlossene Ausbildung im Veranstaltungs- oder Logistiksektor haben, neben Ihrer Muttersprache noch mindestens eine weitere Sprache fließend beherrschen und reiserfreudig sind, melden Sie sich bei uns! Weitere Informationen finden Sie auch auf unserer Website oder sprechen Sie unsere zuständige Mitarbeiterin, Frau Klimke, direkt an. www.die-veranstaltungsprofis.de", correctAnswer: "15"},
              {id: "C", text: "Die Zahl der Arbeitslosen in Deutschland ist im vergangenen Monat auf den niedrigsten Stand seit 20 Jahren gesunken. Die Arbeitslosenquote liegt jetzt bei 5,8 Prozent. Das ist ein Rückgang um 0,3 Prozentpunkte im Vergleich zum Vormonat. Besonders erfreulich ist die Entwicklung in den neuen Bundesländern, wo die Arbeitslosigkeit stärker als im Westen zurückgeht. Die Bundesagentur für Arbeit führt diesen positiven Trend auf die gute Konjunktur und die gestiegene Zahl der sozialversicherungspflichtigen Beschäftigungsverhältnisse zurück.", correctAnswer: null},
              {id: "D", text: "Sie möchten sich beruflich weiterbilden? Sie suchen nach einem passenden Angebot? Dann sind Sie bei uns genau richtig. Wir bieten Ihnen ein breites Spektrum an Weiterbildungsmöglichkeiten in den Bereichen Wirtschaft, Sprachen, Technik und Gesundheit. Unsere Kurse finden in kleinen Gruppen statt und werden von erfahrenen Dozenten geleitet. Wir beraten Sie gerne persönlich und helfen Ihnen, den für Sie passenden Kurs zu finden. Rufen Sie uns an oder kommen Sie einfach vorbei. Wir freuen uns auf Sie!", correctAnswer: "16"},
              {id: "E", text: "Sie suchen einen Job im Bereich Veranstaltungsmanagement? Dann sind Sie bei uns richtig. Wir vermitteln Fachkräfte in den Bereichen Eventmanagement, Messebau und Veranstaltungstechnik. Unsere Kunden sind namhafte Unternehmen aus der Veranstaltungsbranche. Wir bieten Ihnen eine umfassende Beratung und Unterstützung bei der Stellensuche. Melden Sie sich bei uns und vereinbaren Sie einen Termin für ein persönliches Gespräch. Wir freuen uns auf Ihre Bewerbung!", correctAnswer: "17"},
              {id: "F", text: "Sie planen eine Veranstaltung und benötigen Unterstützung? Wir bieten Ihnen ein umfassendes Servicepaket für Ihre Veranstaltung. Von der Planung über die Organisation bis hin zur Durchführung stehen wir Ihnen zur Seite. Unser Team besteht aus erfahrenen Eventmanagern, die bereits zahlreiche Veranstaltungen erfolgreich umgesetzt haben. Wir kümmern uns um alles - Sie können sich zurücklehnen und Ihre Veranstaltung genießen. Kontaktieren Sie uns für ein unverbindliches Angebot!", correctAnswer: "18"},
              {id: "G", text: "Sie suchen nach einer Möglichkeit, Ihre Sprachkenntnisse zu verbessern? Dann sind unsere Sprachkurse genau das Richtige für Sie. Wir bieten Kurse in verschiedenen Sprachen und auf unterschiedlichen Niveaustufen an. Unsere Kurse finden in kleinen Gruppen statt und werden von muttersprachlichen Dozenten geleitet. Wir legen Wert auf eine kommunikative Unterrichtsmethode, bei der Sie von der ersten Stunde an die Sprache aktiv anwenden. Melden Sie sich noch heute für einen Kurs an!", correctAnswer: "19"},
              {id: "H", text: "Sie interessieren sich für Kunst und Kultur? Dann besuchen Sie doch unsere Ausstellung \"Kunst im Wandel der Zeit\". Wir zeigen Werke von bekannten Künstlern aus verschiedenen Epochen. Die Ausstellung ist dienstags bis sonntags von 10 bis 18 Uhr geöffnet. Führungen finden jeden Samstag um 15 Uhr statt. Weitere Informationen finden Sie auf unserer Website. Wir freuen uns auf Ihren Besuch!", correctAnswer: null},
              {id: "I", text: "Sie suchen nach einer neuen beruflichen Herausforderung? Dann sollten Sie sich über unsere Stellenangebote informieren. Wir suchen regelmäßig motivierte Mitarbeiter für verschiedene Bereiche. Auf unserer Website finden Sie alle aktuellen Stellenausschreibungen. Wir bieten attraktive Arbeitsbedingungen und gute Entwicklungsmöglichkeiten. Bewerben Sie sich jetzt online oder senden Sie Ihre Bewerbungsunterlagen per Post. Wir freuen uns auf Sie!", correctAnswer: "20"},
              {id: "J", text: "Sie möchten sich über Weiterbildungsmöglichkeiten im Bereich Veranstaltungsmanagement informieren? Dann sind Sie bei uns richtig. Wir bieten verschiedene Seminare und Workshops zu Themen wie Eventplanung, Budgetierung und Marketing. Unsere Dozenten sind erfahrene Praktiker, die ihr Wissen gerne an Sie weitergeben. Die Kurse finden an Wochenenden statt, so dass Sie sie berufsbegleitend besuchen können. Melden Sie sich jetzt an!", correctAnswer: "11"},
              {id: "K", text: "Sie planen eine Reise und suchen nach günstigen Flugtickets? Dann sind Sie bei uns genau richtig. Wir bieten Ihnen Flüge zu Top-Preisen in alle Welt. Ob Städtereise, Strandurlaub oder Geschäftsreise - wir finden den passenden Flug für Sie. Buchen Sie einfach online oder rufen Sie uns an. Unser freundliches Team berät Sie gerne und findet das beste Angebot für Sie. Wir freuen uns auf Ihre Buchung!", correctAnswer: "12"},
              {id: "L", text: "Sie suchen nach einer Möglichkeit, Ihre Veranstaltung bekannt zu machen? Dann sollten Sie unsere Werbemöglichkeiten nutzen. Wir bieten Ihnen verschiedene Werbeformate, um Ihre Veranstaltung optimal zu bewerben. Ob Online-Werbung, Print-Anzeigen oder Plakatierung - wir haben das passende Medium für Sie. Kontaktieren Sie uns für eine persönliche Beratung und ein unverbindliches Angebot. Wir helfen Ihnen, Ihre Veranstaltung zum Erfolg zu führen!", correctAnswer: "13"}
            ],
            situations: [
              {id: "11", text: "Sie möchten ein Seminar zum Thema Eventplanung besuchen."},
              {id: "12", text: "Sie suchen einen preiswerten Flug für Ihren nächsten Urlaub."},
              {id: "13", text: "Sie wollen für Ihre Veranstaltung Werbung machen."},
              {id: "14", text: "Sie möchten Karten für eine Sportveranstaltung kaufen."},
              {id: "15", text: "Sie suchen eine Stelle im Bereich Messeorganisation."},
              {id: "16", text: "Sie wollen sich beruflich weiterbilden."},
              {id: "17", text: "Sie suchen einen Job im Veranstaltungsmanagement."},
              {id: "18", text: "Sie planen eine Veranstaltung und benötigen Unterstützung."},
              {id: "19", text: "Sie möchten Ihre Sprachkenntnisse verbessern."},
              {id: "20", text: "Sie suchen nach einer neuen beruflichen Herausforderung."}
            ]
          },
          { 
            id: "s4", 
            title: "Sprachbausteine, Teil 1", 
            points: 15,
            passageTitle:"Aufgabe: Ergänzen Sie den Text. Wählen Sie für jede Lücke das passende Wort.",
            passage: "",
            questions:[],
            fillBlanks: [
              {
                id: "21",
                options: ["allergrößte", "allergrößtem", "allergrößten"],
                correctAnswer: "allergrößten"
              },
              {
                id: "22",
                options: ["dass", "ob", "wenn"],
                correctAnswer: "dass"
              },
              {
                id: "23",
                options: ["aber", "denn", "und"],
                correctAnswer: "und"
              },
              {
                id: "24",
                options: ["kann", "können", "könnte"],
                correctAnswer: "könnte"
              },
              {
                id: "25",
                options: ["begann", "beging", "belieb"],
                correctAnswer: "begann"
              },
              {
                id: "26",
                options: ["durch ein Jahr", "ein jahr lang", "seit einem Jahr"],
                correctAnswer: "ein jahr lang"
              },
              {
                id: "27",
                options: ["entdeckte", "erfand", "merkte"],
                correctAnswer: "entdeckte"
              },
              {
                id: "28",
                options: ["Dabei", "Inzwischen", "Während"],
                correctAnswer: "Während"
              },
              {
                id: "29",
                options: ["sowohl... als auch", "teils... teils", "weder... noch"],
                correctAnswer: "sowohl... als auch"
              },
              {
                id: "30",
                options: ["auf Ihre Anzeige antworten", "auf ihre anzeige zu antworten", "auf Ihre Anzeige zu antworten"],
                correctAnswer: "auf Ihre Anzeige zu antworten"
              }
            ],
            fillText: `Sehr geehrter Herr Dr. Moosberger,

mit (21) ________ Interesse habe ich Ihr Stellenangebot in der Essener Zeitung gelesen, (22) ________ Sie eine Teilzeit-Mitarbeiterin in Ihrem Antiquitätengeschäft suchen. Es reizt mich, eine verantwortungsvolle Aufgabe in einem renommierten Geschäft wie dem Ihrigen zu übernehmen, (23) ________ ich mich deshalb bewerbe.

Nach dem Abitur am Kreisgymnasium in Velbert (24) ________ ich eine dreijährige Schreinerlehre bei der Firma Eichelbohrer & Co und besuchte die Kreisberufsschule in Velbert. Nach erfolgreichem Abschluss meiner Berufsausbildung arbeitete ich (25) ________ bei Stutz & Partner - Möbeldesign in Düsseldorf. Danach schrieb ich mich an der Fachhochschule Köln im Fachbereich Möbeldesign ein und (26) ________ meine Liebe zu antiquarischen Möbelstücken.

Meine Spezialität ist das stilgenaue Restaurieren und Aufarbeiten antiquarischer Möbel, insbesondere aus dem Biedermeier und dem Jugendstil. (27) ________ meiner Berufstätigkeit und meines Studiums konnte ich umfangreiche Kenntnisse erwerben, was Möbelstile und die Herstellungskunst in den verschiedensten Epochen (28) ________ in Nord- (28) ________ in Südeuropa angeht.

Mein Studium lässt mir genügend Zeit, eine Teilzeitstelle zu übernehmen, die darüber hinaus meinen beruflichen Fähigkeiten und Neigungen entspricht. Aus diesem Grund habe ich mich entschlossen, (29) ________, und bewerbe mich um die von Ihnen angebotene Teilzeitstelle.

Ich freue mich auf ein persönliches Gespräch.

Mit freundlichen Grüßen, Sabine Holzinger`
          },
          { 
            id: "s5", 
            title: "Sprachbausteine, Teil 2", 
            points: 15,
            passageTitle:"Aufgabe: Lesen Sie den Text und entscheiden Sie, welches Wort in welche Lücke passt. Sie können jedes Wort nur einmal verwenden. Nicht alle Wörter passen in den Text.",
            passage: "",
            questions:[],
            fillBlanks2: [
              {
                id: "31",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "KAUM"
              },
              {
                id: "32", 
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "AUF"
              },
              {
                id: "33",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "VORBEI"
              },
              {
                id: "34",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "STATT"
              },
              {
                id: "35",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "INNERHALB"
              },
              {
                id: "36",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "MÜSSEN"
              },
              {
                id: "37",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "AN"
              },
              {
                id: "38",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "SOLLEN"
              },
              {
                id: "39",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "DANN"
              },
              {
                id: "40",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "DENN"
              }
            ],
            fillText2: `Das Fahrrad: ernsthafte Konkurrenz fürs Auto?

Welches Fortbewegungsmittel, denken Sie, wird in Deutschland am häufigsten benutzt? Natürlich das Automobil. Volkswagen, Porsche, Mercedes Benz, BMW, Audi: In (31) ________ einem anderen Land gibt es so viele Automobilfabriken wie in Deutschland, spielt die Automobilindustrie eine so große Rolle. Nahezu jeder Haushalt verfügt über mindestens ein Auto, das Auto spielt im Leben der Deutschen eine große Rolle, sowohl als Fortbewegungsmittel zum Arbeitsplatz oder in den Urlaub als auch als Statussymbol: Zeig mir dein Auto und ich weiß, wer du bist.

Doch hat das Autofahren auch Schattenseiten. Mangelnde Bewegungsmöglichkeiten, gesundheitliche Probleme und Stress bringen zumindest in den Großstädten immer more Autofahrer dazu, sich vom Automobil freizumachen und (32) ________ ein anderes Verkehrsmittel umzusteigen, das in dem Ruf steht, gesünder zu sein als das Auto: das Fahrrad. Nicht nur in der Freizeit, sondern auch auf dem Weg zum Arbeitsplatz wird das Rad benutzt. "Ich habe keine Lust, Morgen für Morgen im Stau zu stehen und Zeit zu verlieren", sagt Bettina Meier (25): "Da ist es viel entspannender, auf den zumeist gut ausgebauten Fahrradwegen an den im Stau wartenden Fahrzeugen (33) ________ und ausgeruht am Arbeitsplatz anzukommen."

Dass Fahrradfahren um einiges gesünder ist, als hinter dem Lenkrad zu sitzen, bestätigen auch die Mediziner. Wer Fahrrad fährt (34) ________ zu sitzen, bringt seinen Blutkreislauf in Schwung, stärkt die Abwehrkräfte des Körpers und trainiert seinen Körper. Auch die Bewegung an der frischen Luft tut Menschen gut, die sich sonst die meiste Zeit (35) ________ geschlossener Räume in Büros, Schulen oder Fabriken aufhalten (36) ________.

Auch die Geschäftswelt hat die Fahrradfahrer als Kunden entdeckt. Ein breites Angebot (37) ________ Zubehör für Fahrräder von schicken Radfelgen über sportliche Mehrganggetriebe, mit denen Berge kein Problem mehr darstellen, bis zur Designer-Trinkflasche machen aus dem einfachen Fahrrad ein exlusives Fahrzeug. Und natürlich darf bei keinem Fahrradfahrer eine aufwändige Sicherheitsausstattung more fehlen: Schutzhelme, Ellenbogen- und Knieschützer, die das Fahrrad im Falle eines Unfalls fast so sicher wie einen Panzer machen (38) ________.

Nur wenn es regnet - und das passiert in Deutschland leider nicht so selten -, (39) ________ sind die Autoschlangen wieder länger. (40) ________ einen praktischen Wetterschutz für Radfahrer haben die Geschäfte noch nicht im Angebot.`
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        questionIndex: 0, 
        answers: {}, 
        marked: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      const topTiles = document.getElementById('topTiles-lesen');
      const passageTitleEl = document.getElementById('passageTitle-lesen');
      const passageContentEl = document.getElementById('passageContent-lesen');
      const sectionNameEl = document.getElementById('sectionName-lesen');
      const questionTitleEl = document.getElementById('questionTitle-lesen');
      const questionBodyEl = document.getElementById('questionBody-lesen');
      const headingsBankContainer = document.getElementById('headingsBankContainer-lesen');
      const timerEl = document.getElementById('timer-lesen');
      const statusText = document.getElementById('statusText-lesen');
      const resultBtn = document.getElementById('resultBtn-lesen');
      const resetBtn = document.getElementById('resetBtn-lesen');
      const resetSectionBtn = document.getElementById('resetSectionBtn-lesen');

      /* ===== Timer Functions ===== */
      function startTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(()=>{
          if(state.remaining <= 0){
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay(){
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Reset Section Function ===== */
      function resetCurrentSection() {
        const currentSection = exam.sections[state.sectionIndex];
        
        if (confirm(`Möchten Sie wirklich den Teil "${currentSection.title}" zurücksetzen? Alle Antworten in diesem Teil werden gelöscht.`)) {
          if (currentSection.id === 's1') {
            currentSection.texts.forEach(text => {
              delete state.answers[text.id];
            });
          } else if (currentSection.id === 's2') {
            currentSection.questions.forEach(question => {
              delete state.answers[question.id];
            });
          } else if (currentSection.id === 's3') {
            currentSection.situations.forEach(situation => {
              delete state.answers[situation.id];
            });
          } else if (currentSection.id === 's4') {
            currentSection.fillBlanks.forEach(blank => {
              delete state.answers[blank.id];
            });
          } else if (currentSection.id === 's5') {
            currentSection.fillBlanks2.forEach(blank => {
              delete state.answers[blank.id];
            });
          }
          
          renderAll();
        }
      }

      /* ===== Render ===== */
      function renderTopTiles(){ 
        topTiles.innerHTML=''; 
        exam.sections.forEach((sec,idx)=>{ 
          const div=document.createElement('div'); 
          div.className='tile'+(idx===state.sectionIndex?' active':'')+(isSectionDone(sec)?' done':''); 
          div.innerHTML=`<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick=()=>{state.sectionIndex=idx; state.questionIndex=0; state.showResults=false; renderAll();}; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section){
        if(section.id==='s1') return section.texts.every(t=>state.answers[t.id]);
        if(section.id==='s2') return section.questions.every(q=>state.answers[q.id]);
        if(section.id==='s3') return section.situations.every(h=>state.answers[h.id] || state.answers[h.id] === 'X');
        if(section.id==='s4') return section.fillBlanks.every(b=>state.answers[b.id]);
        if(section.id==='s5') return section.fillBlanks2.every(b=>state.answers[b.id]);
        return false;
      }

      function renderAll(){
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        sectionNameEl.textContent = section.title;
        passageTitleEl.textContent = section.passageTitle;
        
        resetSectionBtn.style.display = 'block';
        
        if(state.showResults){
          renderResults();
          return;
        }
        
        if(section.id === 's1'){
          renderPart1();
        } else if(section.id === 's2'){
          renderPart2();
        } else if(section.id === 's3'){
          renderPart3();
        } else if(section.id === 's4'){
          renderSprachbausteine1();
        } else if(section.id === 's5'){
          renderSprachbausteine2();
        }
      }

      function renderPart1(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `<div class="instructions">Ziehen Sie die passenden Überschriften auf die Texte. Sie können jede Überschrift nur einmal verwenden.</div>`;
        
        section.texts.forEach((text, idx) => {
          const letter = String.fromCharCode(97 + idx);
          const selectedHeading = state.answers[text.id];
          
          textsHTML += `
            <div class="text-container">
              <div class="text-title">Text ${letter.toUpperCase()}</div>
              <div class="text-content">${text.content}</div>
              <div class="title-slot ${selectedHeading ? 'has-title' : ''}" data-text-id="${text.id}">
                ${selectedHeading ? getHeadingTextById(selectedHeading) : 'Ziehen Sie hier eine Überschrift hin'}
              </div>
            </div>
          `;
        });
        
        passageContentEl.innerHTML = textsHTML;
        
        let headingsHTML = `<div class="headings-bank">`;
        section.headings.forEach(heading => {
          const isUsed = section.texts.some(text => state.answers[text.id] === heading.id);
          
          headingsHTML += `
            <div class="heading-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-heading-id="${heading.id}">
              ${heading.id}) ${heading.text}
            </div>
          `;
        });
        
        headingsHTML += `</div>`;
        
        headingsBankContainer.innerHTML = headingsHTML;
        
        setupDragAndDrop();
        
        questionBodyEl.innerHTML = '';
        questionTitleEl.textContent = '';
      }

      function getHeadingTextById(id){
        const section = exam.sections[state.sectionIndex];
        const heading = section.headings.find(h => h.id === id);
        return heading ? `${heading.id}) ${heading.text}` : '';
      }

      function setupDragAndDrop(){
        const headingItems = document.querySelectorAll('.heading-item:not(.used)');
        const titleSlots = document.querySelectorAll('.title-slot');
        
        headingItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.headingId);
          });
        });
        
        titleSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            slot.style.background = slot.classList.contains('has-title') ? '#e8fbe9' : '#f8fbff';
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const headingId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === headingId) {
                delete state.answers[key];
              }
            });
            
            state.answers[textId] = headingId;
            renderAll();
          });
        });
      }

      function renderPart2(){
        const section = exam.sections[state.sectionIndex];
        
        passageContentEl.innerHTML = `<div class="passage">${section.passage}</div>`;
        
        let questionsHTML = `<div class="all-questions">`;
        
        section.questions.forEach((question, idx) => {
          const questionNumber = idx + 1;
          const userAnswer = state.answers[question.id];
          
          questionsHTML += `
            <div class="question-block">
              <div class="question-text">${questionNumber}. ${question.text}</div>
              <div class="options">
                ${question.options.map(opt => `
                  <div class="option ${userAnswer === opt.id ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectOption('${question.id}', '${opt.id}')">
                    <div class="radio"></div>
                    <div>${opt.text}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = questionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function renderPart3(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `
          <div class="instructions">Ziehen Sie die passenden Situationen auf die Texte. Sie können jede Situation nur einmal verwenden. Manchmal passt keine Situation.</div>
          <div class="texts-list">
            <h3>Texte (A-L)</h3>
        `;
        
        section.texts.forEach(text => {
          const userAnswer = Object.keys(state.answers).find(key => state.answers[key] === text.id);
          const selectedSituation = userAnswer ? section.situations.find(h => h.id === userAnswer) : null;
          
          textsHTML += `
            <div class="text-item" data-text-id="${text.id}">
              <div class="text-letter">${text.id})</div>
              <div class="text-content">${text.text}</div>
              <div class="title-slot ${userAnswer ? 'has-title' : ''} ${userAnswer === 'X' ? 'has-x' : ''}" data-text-id="${text.id}">
                ${selectedSituation ? selectedSituation.text : (userAnswer === 'X' ? 'X - Keine passende Situation' : 'Ziehen Sie hier eine Situation hin')}
              </div>
            </div>
          `;
        });
        
        textsHTML += `</div>`;
        
        passageContentEl.innerHTML = textsHTML;
        
        let situationsHTML = `
          <div class="situations-list">
            <h3>Situationen (11-20)</h3>
        `;
        
        section.situations.forEach((situation, idx) => {
          const situationNumber = parseInt(situation.id);
          const isUsed = state.answers[situation.id];
          const isX = state.answers[situation.id] === 'X';
          
          situationsHTML += `
            <div class="situation-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-situation-id="${situation.id}">
              <div class="situation-number">${situationNumber}.</div>
              <div class="situation-text">${situation.text}</div>
              ${!isUsed ? `<button class="exam-btn no-match ${isX ? 'selected' : ''}" onclick="window.lesenApp.markNoMatch('${situation.id}')">X - Kein passender Text</button>` : ''}
            </div>
          `;
        });
        
        situationsHTML += `</div>`;
        
        questionBodyEl.innerHTML = situationsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
        
        setupPart3DragAndDrop();
      }

      function markNoMatch(situationId) {
        Object.keys(state.answers).forEach(key => {
          if(state.answers[key] === situationId) {
            delete state.answers[key];
          }
        });
        
        state.answers[situationId] = 'X';
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function setupPart3DragAndDrop(){
        const situationItems = document.querySelectorAll('.situation-item:not(.used)');
        const textSlots = document.querySelectorAll('.text-item .title-slot');
        
        situationItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.situationId);
          });
        });
        
        textSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            const hasTitle = slot.classList.contains('has-title');
            const hasX = slot.classList.contains('has-x');
            slot.style.background = hasTitle ? '#e8fbe9' : (hasX ? '#f8d7da' : '#f8fbff');
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const situationId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === situationId) {
                delete state.answers[key];
              }
            });
            
            state.answers[situationId] = textId;
            renderAll();
          });
        });
      }

      function renderSprachbausteine1(){
        const section = exam.sections[state.sectionIndex];
        
        let textWithBlanks = section.fillText;
        
        const blankPlaceholders = [];
        section.fillBlanks.forEach(blank => {
          blankPlaceholders.push(`BLANK_${blank.id}`);
        });
        
        let tempText = textWithBlanks;
        blankPlaceholders.forEach((placeholder, index) => {
          tempText = tempText.replace('________', placeholder);
        });
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          const displayText = userAnswer ? userAnswer : '________';
          tempText = tempText.replace(`BLANK_${blank.id}`, `<span class="blank-word ${userAnswer ? 'has-answer' : ''}" data-blank-id="${blank.id}">${displayText}</span>`);
        });
        
        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können die Lücken in beliebiger Reihenfolge ausfüllen.</div>
          <div class="fill-blank-container">${tempText}</div>
        `;
        
        document.querySelectorAll('.blank-word').forEach(blank => {
          blank.addEventListener('click', (e) => {
            showOptionsPopup(e.target);
          });
        });
        
        let optionsHTML = `<div class="horizontal-options" style="gap: 8px;">`;
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          
          optionsHTML += `
            <div class="option-row" style="padding: 8px; margin-bottom: 5px;">
              <div class="option-number">${blank.id}</div>
              <div class="option-buttons">
                ${blank.options.map(opt => `
                  <div class="option-btn ${userAnswer === opt ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectSprachbausteine1('${blank.id}', '${opt}')" 
                       style="padding: 6px 12px; font-size: 12px;">
                    ${opt}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        optionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = optionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function showOptionsPopup(blankElement){
        const existingPopup = document.querySelector('.options-popup');
        if(existingPopup) {
          existingPopup.remove();
        }
        
        const blankId = blankElement.getAttribute('data-blank-id');
        const section = exam.sections.find(s => s.id === 's4');
        const blank = section.fillBlanks.find(b => b.id === blankId);
        
        if(!blank) return;
        
        const popup = document.createElement('div');
        popup.className = 'options-popup';
        
        blank.options.forEach(opt => {
          const optionItem = document.createElement('div');
          optionItem.className = 'option-item';
          optionItem.textContent = opt;
          optionItem.onclick = () => {
            selectSprachbausteine1(blankId, opt);
            popup.remove();
          };
          popup.appendChild(optionItem);
        });
        
        blankElement.appendChild(popup);
      }

      function selectSprachbausteine1(blankId, answer){
        state.answers[blankId] = answer;
        renderAll();
      }

      function renderSprachbausteine2(){
        const section = exam.sections[state.sectionIndex];
        // Build text but replace blanks with unique placeholders first (prevents ambiguous replacements)
        let textWithPlaceholders = section.fillText2;
        const placeholders = [];
        section.fillBlanks2.forEach(blank => {
          const ph = `BLANK_${blank.id}`;
          placeholders.push({id: blank.id, ph});
          // replace first occurrence of the visual underline with placeholder
          textWithPlaceholders = textWithPlaceholders.replace('________', ph);
        });

        // Now replace placeholders with actual span elements showing current answer (or underscore)
        placeholders.forEach(item => {
          const userAnswer = state.answers[item.id];
          const displayText = userAnswer ? userAnswer : '________';
          const span = `<span class="blank-slot ${userAnswer ? 'has-answer' : ''}" data-blank-id="${item.id}">${displayText}</span>`;
          textWithPlaceholders = textWithPlaceholders.replace(item.ph, span);
        });

        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können jedes Wort nur einmal verwenden.</div>
          <div class="fill-blank-container">${textWithPlaceholders}</div>
        `;

        // attach click handlers to slots
        document.querySelectorAll('.blank-slot').forEach(slot => {
          slot.addEventListener('click', (e) => {
            // use the element itself to open popup
            showSprachbausteine2Options(slot);
          });
        });

        // Build word bank on the right
        let wordBankHTML = `<div class="word-bank-vertical" style="gap: 8px;">`;
        const usedWords = Object.values(state.answers);
        // Use section.wordBank if present, otherwise derive from fillBlanks2 options
        const bank = section.fillBlanks2[0] ? section.fillBlanks2[0].options : [];
        bank.forEach(word => {
          const isUsed = usedWords.includes(word);
          wordBankHTML += `
            <div class="bank-word-vertical ${isUsed ? 'used' : ''}" 
                 draggable="${!isUsed}" 
                 data-word="${word}"
                 ${!isUsed ? `onclick="window.lesenApp.selectSprachbausteine2FromBank('${word}')"` : ''}>
              ${word}
            </div>
          `;
        });
        wordBankHTML += `</div>`;
        questionBodyEl.innerHTML = wordBankHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';

        setupSprachbausteine2DragAndDrop();
      }

      // --- Added functions to handle drag/drop and clicks for Sprachbausteine Teil 2 ---
      let lastClickedSprachSlot = null;

      function setupSprachbausteine2DragAndDrop(){
        // bank words: make draggable if not used, attach dragstart
        const bankWords = Array.from(document.querySelectorAll('.bank-word-vertical'));
        bankWords.forEach(el => {
          const word = el.dataset.word;
          if(!el.classList.contains('used')){
            el.setAttribute('draggable','true');
          } else {
            el.setAttribute('draggable','false');
          }
          // ensure single attached listener
          el.removeEventListener('dragstart', el._dstart);
          el._dstart = (e) => {
            e.dataTransfer.setData('text/plain', word);
            // also set an indicator
            e.dataTransfer.setData('source', 'bank');
          };
          el.addEventListener('dragstart', el._dstart);

          // keep onclick behavior (select into clicked slot)
          el.removeEventListener('click', el._onclick);
          el._onclick = () => {
            if(el.classList.contains('used')) return;
            selectSprachbausteine2FromBank(word);
          };
          el.addEventListener('click', el._onclick);
        });

        // blank slots: allow drop
        const slots = Array.from(document.querySelectorAll('.blank-slot'));
        slots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', (e) => {
            slot.classList.remove('drag-over');
          });
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            slot.classList.remove('drag-over');
            const word = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html');
            if(!word) return;
            // Determine blank id
            const blankId = slot.dataset.blankId;
            if(!blankId) return;
            // If this word is already used in another slot, free it
            Object.keys(state.answers).forEach(k => {
              if(state.answers[k] === word){
                delete state.answers[k];
              }
            });
            // If slot had a previous answer, free that bank word
            const prev = state.answers[blankId];
            if(prev){
              const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
              if(prevEl){
                prevEl.classList.remove('used');
                prevEl.setAttribute('draggable','true');
                prevEl.addEventListener('click', prevEl._onclick);
              }
            }
            // mark bank word used
            const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
            if(bankEl){
              bankEl.classList.add('used');
              bankEl.setAttribute('draggable','false');
              // remove click to prevent double-placing
              bankEl.removeEventListener('click', bankEl._onclick);
            }
            // assign to state and re-render
            state.answers[blankId] = word;
            renderAll();
          });
        });
      }

      function showSprachbausteine2Options(slot){
        // highlight selected slot so click from bank knows target
        document.querySelectorAll('.blank-slot').forEach(s => s.classList.remove('selected-sprach'));
        slot.classList.add('selected-sprach');
        lastClickedSprachSlot = slot;
      }

      function selectSprachbausteine2FromBank(word){
        // choose target slot: prefer lastClicked, otherwise first empty
        let slot = lastClickedSprachSlot;
        if(!slot){
          slot = Array.from(document.querySelectorAll('.blank-slot')).find(s => {
            const id = s.dataset.blankId;
            return !state.answers[id];
          });
        }
        if(!slot) {
          // if none available, do nothing
          return;
        }
        const blankId = slot.dataset.blankId;
        // free previous occurrence of word
        Object.keys(state.answers).forEach(k => {
          if(state.answers[k] === word){
            delete state.answers[k];
          }
        });
        // free previous word in target slot
        const prev = state.answers[blankId];
        if(prev){
          const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
          if(prevEl){
            prevEl.classList.remove('used');
            prevEl.setAttribute('draggable','true');
            if(prevEl._onclick) prevEl.addEventListener('click', prevEl._onclick);
          }
        }
        // mark selected bank word as used
        const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
        if(bankEl){
          bankEl.classList.add('used');
          bankEl.setAttribute('draggable','false');
          if(bankEl._onclick) try{ bankEl.removeEventListener('click', bankEl._onclick); }catch(e){}
        }
        // assign value
        state.answers[blankId] = word;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        lastClickedSprachSlot = null;
        renderAll();
      }

      function selectOption(questionId, optionId){
        state.answers[questionId] = optionId;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function renderResults(){
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        let totalCorrect = 0;
        let totalQuestions = 0;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="result-item"><h3>${section.title}</h3>`;
          
          if(section.id === 's1'){
            section.texts.forEach(text => {
              totalQuestions++;
              const userAnswer = state.answers[text.id];
              const isCorrect = userAnswer === text.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Text ${text.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's2'){
            section.questions.forEach(question => {
              totalQuestions++;
              const userAnswer = state.answers[question.id];
              const isCorrect = userAnswer === question.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>${question.text}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's3'){
            section.situations.forEach(situation => {
              totalQuestions++;
              const userAnswer = state.answers[situation.id];
              const correctText = section.texts.find(t => t.correctAnswer === situation.id);
              const isCorrect = userAnswer === (correctText ? correctText.id : null);
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Situation ${situation.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's4'){
            section.fillBlanks.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's5'){
            section.fillBlanks2.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          }
          
          resultsHTML += `</div>`;
        });
        
        const percentage = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        resultsHTML += `<div class="result-item"><h3>Gesamtergebnis: ${totalCorrect}/${totalQuestions} (${percentage}%)</h3></div>`;
        
        passageContentEl.innerHTML = resultsHTML;
        questionBodyEl.innerHTML = '';
        sectionNameEl.textContent = 'Ergebnisse';
        questionTitleEl.textContent = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex > 0){
          state.sectionIndex--;
          state.questionIndex = 0;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex < exam.sections.length - 1){
          state.sectionIndex++;
          state.questionIndex = 0;
          renderAll();
        }
      });

      resultBtn.addEventListener('click', ()=>{
        state.showResults = !state.showResults;
        renderAll();
      });

      resetBtn.addEventListener('click', ()=>{
        if(confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')){
          state.answers = {};
          state.marked = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      resetSectionBtn.addEventListener('click', resetCurrentSection);

      document.getElementById('saveBtn-lesen').addEventListener('click', ()=>{
        statusText.textContent = 'Gespeichert';
        setTimeout(()=>{statusText.textContent = 'Nicht gespeichert'}, 2000);
      });

      document.getElementById('submitBtn-lesen').addEventListener('click', ()=>{
        if(confirm('Möchten Sie die Prüfung wirklich abgeben?')){
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        showPage('hoeren-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
      window._lesenState = state;
      window.lesenApp = {
        selectOption,
        markNoMatch,
        selectSprachbausteine1,
        selectSprachbausteine2FromBank
      };
    }

    // ===== HÖREN PAGE FUNCTIONALITY =====
    function initHoerenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-hörverstehen",
        durationSec: 17 * 60, // 17 minutes in seconds
        sections: [
          { 
            id: "hörverstehen1", 
            title: "Hörverstehen, Teil 1", 
            points: 25,
            correctAnswers: { "41": "falsch", "42": "richtig", "43": "richtig", "44": "falsch", "45": "richtig" },
            questions: [
              {
                id: "41",
                text: "Sie wurden nicht zur Preisverleihung eingeladen."
              },
              {
                id: "42", 
                text: "Die alte Brücke ist wieder befahrbar."
              },
              {
                id: "43",
                text: "Der Wanderer wurde verarztet und in Sicherheit gebracht."
              },
              {
                id: "44",
                text: "Im Unternehmen wurden Kündigungen ausgesprochen."
              },
              {
                id: "45",
                text: "Nach der Registrierung kann man am Gruppenlauf teilnehmen."
              }
            ]
          },
          { 
            id: "hörverstehen2", 
            title: "Hörverstehen, Teil 2", 
            points: 25,
            correctAnswers: { "46": "richtig", "47": "falsch", "48": "richtig", "49": "richtig", "50": "richtig", "51": "falsch", "52": "falsch", "53": "falsch", "54": "richtig", "55": "falsch" },
            questions: [
              {
                id: "46",
                text: "Der Berufseinstieg in anderen Ländern ist für Carina nicht leicht."
              },
              {
                id: "47",
                text: "Carina ist ihr Privatleben wichtiger als ihr Beruf."
              },
              {
                id: "48", 
                text: "Carina hat sich mit einem Film präsentiert."
              },
              {
                id: "49",
                text: "Carina musste ihr Gewicht stark verändern für einen Film."
              },
              {
                id: "50",
                text: "Carina bevorzugt gefühlvolle Filme vor Action-Filmen."
              },
              {
                id: "51",
                text: "Carina hatte Probleme mit dem Schuldirektor."
              },
              {
                id: "52",
                text: "Carinas Eltern haben sie von Anfang an unterstützt."
              },
              {
                id: "53",
                text: "Der Wechsel zwischen Schule und Dreharbeiten war für Carina leicht."
              },
              {
                id: "54",
                text: "Bei Dialogen darf man nichts erfinden."
              },
              {
                id: "55",
                text: "Carina empfiehlt, andere Schauspieler zu beobachten."
              }
            ]
          },
          { 
            id: "hörverstehen3", 
            title: "Hörverstehen, Teil 3", 
            points: 25,
            correctAnswers: { "56": "richtig", "57": "falsch", "58": "falsch", "59": "falsch", "60": "richtig" },
            questions: [
              {
                id: "56",
                text: "Am \"Tag des Ehrenamts\" kann man probeweise helfen."
              },
              {
                id: "57",
                text: "Die Skateboard-Vorführung fällt aus."
              },
              {
                id: "58",
                text: "Es gibt eine Warnung vor Passwort-Programmen."
              },
              {
                id: "59",
                text: "Es wird empfohlen, mit dem Fahrrad zum Volkspark zu fahren."
              },
              {
                id: "60",
                text: "Vor dem Training muss man Bescheid sagen."
              }
            ]
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-hoeren');
      const contentContainer = document.getElementById('contentContainer-hoeren');
      const timerEl = document.getElementById('timer-hoeren');
      const statusText = document.getElementById('statusText-hoeren');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        const answers = state.answers[section.id];
        if (!answers) return false;
        
        // تحقق إذا تمت الإجابة على جميع الأسئلة في هذا القسم
        const answeredQuestions = Object.keys(answers).length;
        const totalQuestions = section.questions.length;
        
        return answeredQuestions === totalQuestions;
      }

      function renderAll() {
        renderTopTiles();
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderListeningSection();
      }

      function renderListeningSection() {
        const section = exam.sections[state.sectionIndex];
        const currentAnswers = state.answers[section.id] || {};
        
        let contentHTML = `
          <div class="panel-title">${section.title}</div>
          <div class="instructions">
            Sie hören die Nachrichten. Entscheiden Sie beim Hören, ob die Aussagen richtig oder falsch sind. 
            Sie hören die Nachrichten nur einmal. Sie haben jetzt 30 Sekunden, um die Aussagen zu lesen.
          </div>
          
          <div class="listening-task">
            <table class="true-false-table">
              <thead>
                <tr>
                  <th style="width: 10%">Nr.</th>
                  <th style="width: 60%">Aussage</th>
                  <th style="width: 30%">Ihre Antwort</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        section.questions.forEach((question, index) => {
          const currentAnswer = currentAnswers[question.id] || '';
          contentHTML += `
            <tr>
              <td><strong>${question.id}</strong></td>
              <td class="question-text">${question.text}</td>
              <td>
                <div class="answer-options">
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="richtig" 
                      ${currentAnswer === 'richtig' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Richtig
                  </label>
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="falsch" 
                      ${currentAnswer === 'falsch' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Falsch
                  </label>
                </div>
              </td>
            </tr>
          `;
        });
        
        contentHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        contentContainer.innerHTML = contentHTML;
      }

      function updateListeningAnswer(sectionId, questionId, answer) {
        if (!state.answers[sectionId]) {
          state.answers[sectionId] = {};
        }
        state.answers[sectionId][questionId] = answer;
        try{ localStorage.setItem('hoerenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        
        // إعادة عرض البلاطات لتحديث حالة "تم"
        renderTopTiles();
      }

      function renderResults() {
        let resultsHTML = `<div class="panel-title">Ergebnisse - Hörverstehen</div>`;
        
        exam.sections.forEach(section => {
          const userAnswers = state.answers[section.id] || {};
          let correctCount = 0;
          
          resultsHTML += `
            <div class="listening-task">
              <h3>${section.title} (${section.points} Punkte)</h3>
              <table class="true-false-table">
                <thead>
                  <tr>
                    <th style="width: 10%">Nr.</th>
                    <th style="width: 50%">Aussage</th>
                    <th style="width: 15%">Ihre Antwort</th>
                    <th style="width: 15%">Richtige Antwort</th>
                    <th style="width: 10%">Punkte</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          section.questions.forEach((question) => {
            const userAnswer = userAnswers[question.id] || '-';
            const correctAnswer = section.correctAnswers[question.id];
            const gotCorrect = userAnswer === correctAnswer;
            const points = gotCorrect ? "1" : "0";
            
            if (gotCorrect) correctCount++;
            
            const rowClass = gotCorrect ? 'correct-answer' : 'incorrect-answer';
            
            resultsHTML += `
              <tr class="${rowClass}">
                <td><strong>${question.id}</strong></td>
                <td class="question-text">${question.text}</td>
                <td>${userAnswer}</td>
                <td>${correctAnswer}</td>
                <td><strong>${points}</strong></td>
              </tr>
            `;
          });
          
          const totalPoints = Math.round((correctCount / section.questions.length) * section.points);
          
          resultsHTML += `
                </tbody>
              </table>
              <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                <strong>Erreichte Punkte: ${correctCount}/${section.questions.length} richtig = ${totalPoints}/${section.points} Punkten</strong>
              </div>
            </div>
          `;
        });
        
        contentContainer.innerHTML = resultsHTML;
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-hoeren').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-hoeren').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        showPage('schreiben-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._hoerenState = state;
        window.hoerenApp = {
        updateListeningAnswer
      };
    }

    // ===== SCHREIBEN PAGE FUNCTIONALITY =====
    function initSchreibenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-002",
        durationSec: 30 * 60, // 30 minutes in seconds
        sections: [
          { 
            id: "s1", 
            title: "Schreiben, Teil 1", 
            points: 45,
            passageTitle: "Aufgabe: Schreiben Sie eine E-Mail",
            passage: "",
            writingTask: {
              prompt: `Renovierungskurs

Selbermachen will gelernt sein: Tapezieren und Streichen für Anfänger – Wochenendkurs im Urbi-Baumarkt.

Ihre Küche kann neue Farbe gebrauchen? 
Oder Sie möchten Ihr Wohnzimmer neu tapezieren und wissen nicht, wie das geht? 

Bei uns erfahren Sie alles, was Sie über das Renovieren wissen müssen:
- Die Auswahl der richtigen Tapete.
- Welches Werkzeug ist notwendig?
- Welche Arbeiten sind vorher und nachher erforderlich?
- Neue Streichtechniken kennenlernen.

Mit vielen praktischen Übungen! 
Ihr Kursleiter steht Ihnen mit Tipps und Expertenwissen zur Seite.

Samstag und Sonntag von 14 bis 17 Uhr, maximal acht Teilnehmer.
Teilnahmegebühr (inkl. Materialien)

Urbi-Baumarkt
Industriestraße 12
56478 Montabaur`,
              requirements: [
                "Beschreiben Sie, warum Sie sich für diesen Kurs entschieden haben.",
                "Legen Sie dar, welche Probleme es im Kurs gab.",
                "Berichten Sie von Ihren Erfahrungen mit ähnlichen Kursen.",
                "Erklären Sie, wie der Kurs verbessert werden kann."
              ],
              wordCount: 0
            }
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-schreiben');
      const passageTitleEl = document.getElementById('passageTitle-schreiben');
      const passageContentEl = document.getElementById('passageContent-schreiben');
      const writingContainer = document.getElementById('writingContainer-schreiben');
      const timerEl = document.getElementById('timer-schreiben');
      const statusText = document.getElementById('statusText-schreiben');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        return state.answers[section.id] && state.answers[section.id].length > 0;
      }

      function renderAll() {
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        passageTitleEl.textContent = section.passageTitle;
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderWritingSection();
      }

      function renderWritingSection() {
        const section = exam.sections[state.sectionIndex];
        
        // Render the prompt in left panel
        passageContentEl.innerHTML = `
          <div class="writing-task">
            <div class="writing-prompt">${section.writingTask.prompt}</div>
            <div class="instructions" style="border:1px solid #e1e8f6; padding:10px; margin:10px 0; border-radius:6px; background:#ffffff;">Sie haben an diesem Wochenendkurs teilgenommen. Leider haben Sie nicht viel gelernt und sind unzufrieden. 
      Schreiben Sie eine Beschwerde.</div>
            <div class="writing-requirements">
              <h4>Schreiben Sie in Ihrer E-Mail:</h4>
              <ul>
                ${section.writingTask.requirements.map(req => `<li>${req}</li>`).join('')}
              </ul>
            </div>
            <div class="instructions">
              Schreiben Sie eine E-Mail (ca. 150-200 Wörter). Achten Sie auf den Textaufbau (Anrede, Einleitung, Hauptteil, Schluss) und eine angemessene Formulierung.
            </div>
          </div>
        `;
        
        // Render writing area in right panel
        const currentAnswer = state.answers[section.id] || '';
        const wordCount = countWords(currentAnswer);
        
        writingContainer.innerHTML = `
          <div class="writing-area">
            <textarea 
              class="writing-textarea" 
              placeholder="Schreiben Sie hier Ihre E-Mail..."
              oninput="window.schreibenApp.updateWritingAnswer('${section.id}', this.value)"
            >${currentAnswer}</textarea>
            <div class="word-counter">
              Wörter: <span class="count">${wordCount}</span>
            </div>
          </div>
        `;
      }

      function countWords(text) {
        return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      }

      function updateWritingAnswer(sectionId, text) {
        state.answers[sectionId] = text;
        try{ localStorage.setItem('schreibenAnswers', JSON.stringify({content: state.answers[sectionId], wordCount: (state.answers[sectionId]||'').trim().split(/\s+/).filter(Boolean).length})); }catch(e){}
        
        const wordCount = countWords(text);
        document.querySelector('.word-counter .count').textContent = wordCount;
      }

      function renderResults() {
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="writing-task"><h3>${section.title}</h3>`;
          
          const userAnswer = state.answers[section.id];
          const wordCount = countWords(userAnswer);
          
          resultsHTML += `
            <div class="writing-requirements">
              <h4>Ihre Antwort (${wordCount} Wörter):</h4>
              <div style="white-space: pre-wrap; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e1e8f6; margin-top: 10px;">${userAnswer || 'Keine Antwort'}</div>
            </div>
          `;
          
          resultsHTML += `</div>`;
        });
        
        passageContentEl.innerHTML = resultsHTML;
        writingContainer.innerHTML = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-schreiben').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöschت.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-schreiben').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        showPage('ergebnisse-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._schreibenState = state;
        window.schreibenApp = {
        updateWritingAnswer
      };
    }

    // ===== ERGEBNISSE PAGE FUNCTIONALITY =====
    function initErgebnissePage() {
      const CONFIG = {
        totals: { 
          lesen: 105, 
          hoeren: 75, 
          schreiben: 45, 
          gesamt: 225 
        },
        counts: { 
          lesen: 40, 
          hoeren: 20 
        },
        hoerenCorrect: {
          "41": "falsch", "42": "richtig", "43": "richtig", "44": "falsch", "45": "richtig",
          "46": "richtig", "47": "falsch", "48": "richtig", "49": "richtig", "50": "richtig",
          "51": "falsch", "52": "falsch", "53": "falsch", "54": "richtig", "55": "falsch",
          "56": "richtig", "57": "falsch", "58": "falsch", "59": "falsch", "60": "richtig"
        },
        lesenCorrect: Object.assign({},
          {"text1": "e", "text2": "j", "text3": "g", "text4": "h", "text5": "i"},
          {"s2q1": "s2q1o1", "s2q2": "s2q2o1", "s2q3": "s2q3o3", "s2q4": "s2q4o2", "s2q5": "s2q5o1"},
          {"11": "J", "12": "K", "13": "L", "14": "A", "15": "B", "16": "D", "17": "E", "18": "F", "19": "G", "20": "I"},
          {"21": "allergrößten", "22": "dass", "23": "und", "24": "könnte", "25": "begann", "26": "ein jahr lang", "27": "entdeckte", "28": "Während", "29": "sowohl... als auch", "30": "auf Ihre Anzeige zu antworten"},
          {"31": "KAUM", "32": "AUF", "33": "VORBEI", "34": "STATT", "35": "INNERHALB", "36": "MÜSSEN", "37": "AN", "38": "SOLLEN", "39": "DANN", "40": "DENN"}
        )
      };

      function normalizeAnswer(a) {
        if (a === null || a === undefined) return '';
        let s = String(a).trim();
        if (s === '') return '';
        const low = s.toLowerCase();
        if (["richtig", "true", "yes", "ja"].includes(low)) return 'richtig';
        if (["falsch", "false", "no", "nein"].includes(low)) return 'falsch';
        return s;
      }

      function keyZeroToTen(k) {
        return k === '0' ? '10' : k;
      }

      function readExamResults() {
        try {
          const lesen = {};
          const hoeren = {};
          const schreiben = { content: '', wordCount: 0 };

          // 1) Try to read from in-memory states exposed by pages
          try {
            if (window._lesenState && window._lesenState.answers) {
              Object.keys(window._lesenState.answers).forEach(k => {
                lesen[k] = window._lesenState.answers[k];
              });
            }
          } catch (e) {}

          try {
            if (window._hoerenState && window._hoerenState.answers) {
              Object.keys(window._hoerenState.answers).forEach(sectionId => {
                const sec = window._hoerenState.answers[sectionId] || {};
                Object.keys(sec).forEach(q => {
                  hoeren[q] = sec[q];
                });
              });
            }
          } catch (e) {}

          try {
            if (window._schreibenState && window._schreibenState.answers) {
              const answers = window._schreibenState.answers;
              if (answers['s1']) {
                schreiben.content = answers['s1'];
              } else {
                const keys = Object.keys(answers);
                if (keys.length > 0) schreiben.content = answers[keys[0]] || '';
              }
              schreiben.wordCount = (schreiben.content && schreiben.content.trim()) ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0;
            }
          } catch (e) {}

          // 2) Fallback to localStorage if any part is still empty
          try {
            if (Object.keys(lesen).length === 0) {
              const storedL = localStorage.getItem('lesenAnswers');
              if (storedL) Object.assign(lesen, JSON.parse(storedL));
            }
          } catch (e) {}

          try {
            if (Object.keys(hoeren).length === 0) {
              const storedH = localStorage.getItem('hoerenAnswers');
              if (storedH) Object.assign(hoeren, JSON.parse(storedH));
            }
          } catch (e) {}

          try {
            if (!schreiben.content) {
              const storedS = localStorage.getItem('schreibenAnswers');
              if (storedS) {
                const obj = JSON.parse(storedS);
                schreiben.content = obj.content || '';
                schreiben.wordCount = obj.wordCount || (schreiben.content.trim() ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0);
              }
            }
          } catch (e) {}

          // final safe return
          return { hoeren, lesen, schreiben };
        } catch (e) {
          return { hoeren: {}, lesen: {}, schreiben: {} };
        }
      }

      function gradeHoeren(u) {
        const c = CONFIG.hoerenCorrect;
        let okCount = 0;
        const d = [];
        
        for (let q = 41; q <= 60; q++) {
          const k = String(q);
          const uA = normalizeAnswer(u[k] || '');
          const exp = normalizeAnswer(c[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.hoeren / CONFIG.counts.hoeren;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        }
        
        const total = Number((okCount * (CONFIG.totals.hoeren / CONFIG.counts.hoeren)).toFixed(2));
        return { okCount, total, details: d };
      }

      function gradeLesen(u) {
        const c = CONFIG.lesenCorrect;
        let okCount = 0;
        const d = [];
        
        Object.keys(c).forEach(k => {
          const exp = normalizeAnswer(c[k]);
          const uA = normalizeAnswer(u[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.lesen / CONFIG.counts.lesen;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        });
        
        const total = Number((okCount * (CONFIG.totals.lesen / CONFIG.counts.lesen)).toFixed(2));
        return { okCount, total, details: d };
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function buildTable(title, dets, total, max) {
        let h = `<h2>${title}</h2>
                <table class="section-table">
                  <thead>
                    <tr>
                      <th>Frage</th>
                      <th>Ihre Antwort</th>
                      <th>Richtige Antwort</th>
                      <th>Ergebnis</th>
                      <th>Punkte</th>
                    </tr>
                  </thead>
                  <tbody>`;
        
        dets.forEach(x => {
          h += `<tr>
                  <td>${x.frage}</td>
                  <td>${escapeHtml(x.user)}</td>
                  <td>${escapeHtml(x.correct)}</td>
                  <td>${x.richtig ? '✔️' : '✖️'}</td>
                  <td>${x.punkte}</td>
                </tr>`;
        });
        
        h += `</tbody>
              </table>
              <div class="small-muted">Teilpunkte: ${total.toFixed(2)} / ${max}</div>`;
        return h;
      }

      function renderResults() {
        const st = readExamResults() || { hoeren: {}, lesen: {}, schreiben: {} };
        const h = gradeHoeren(st.hoeren || {});
        const l = gradeLesen(st.lesen || {});
        const details = document.getElementById('details-ergebnisse');
        const tiles = document.getElementById('topTiles-ergebnisse');
        const sScoreRaw = localStorage.getItem('schreibenScore');
        const sScore = sScoreRaw ? Number(sScoreRaw) : 0; // Default score is now 0

        details.innerHTML = '';
        tiles.innerHTML = '';

        const tL = `<div class="results-tile">
                    <h3>Lesen</h3>
                    <div class="score">${l.total.toFixed(2)} / ${CONFIG.totals.lesen} Punkte</div>
                    <div class="small-muted">(${(l.total / CONFIG.totals.lesen * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tH = `<div class="results-tile">
                    <h3>Hören</h3>
                    <div class="score">${h.total.toFixed(2)} / ${CONFIG.totals.hoeren} Punkte</div>
                    <div class="small-muted">(${(h.total / CONFIG.totals.hoeren * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tS = `<div class="results-tile">
                    <h3>Schreiben</h3>
                    <div class="score" id="schreibenScoreDisplay">${sScore.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte</div>
                    <div class="small-muted">Manuelle Eingabe</div>
                  </div>`;
                  
        tiles.innerHTML = tL + tH + tS;

        details.innerHTML += buildTable('Hören — Detail', h.details, h.total, CONFIG.totals.hoeren);
        details.innerHTML += buildTable('Lesen — Detail', l.details, l.total, CONFIG.totals.lesen);

        let sHtml = '<h2>Schreiben — Ergebnis (manuell)</h2>';
        const txt = st.schreiben.content ? escapeHtml(st.schreiben.content) : '<span class="small-muted">Kein Text gefunden.</span>';
        const wc = st.schreiben.wordCount || '-';
        
        sHtml += `<div class="small-muted">Wörter: ${wc}</div>
                <div style="margin-top:10px;padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ff;min-height:80px">${txt}</div>
                <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                  Punkte (0–45): 
                  <input id="sInput" type="number" min="0" max="45" step="0.5" value="${sScore}"> 
                  <button id="saveS" class="results-btn">Speichern</button>
                </div>`;
                
        details.innerHTML += sHtml;

        const total = (l.total + h.total + sScore).toFixed(2);
        const percent = ((total / CONFIG.totals.gesamt) * 100).toFixed(2);
        
        document.getElementById('finalSummary-ergebnisse').innerHTML = `
          <div class="left">
            Gesamtpunktzahl: <strong>${total}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
            <span class="small-muted">Lesen + Hören + Schreiben</span>
          </div>
          <div class="right">
            Prozentsatz: <strong>${percent} %</strong>
          </div>`;

        document.getElementById('saveS').onclick = () => {
          const v = Number(document.getElementById('sInput').value) || 0;
          localStorage.setItem('schreibenScore', v);
          document.getElementById('schreibenScoreDisplay').textContent = `${v.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte`;
          
          const newTotal = (l.total + h.total + v).toFixed(2);
          const newPercent = ((newTotal / CONFIG.totals.gesamt) * 100).toFixed(2);
          
          document.getElementById('finalSummary-ergebnisse').innerHTML = `
            <div class="left">
              Gesamtpunktzahl: <strong>${newTotal}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
              <span class="small-muted">Lesen + Hören + Schreiben</span>
            </div>
            <div class="right">
              Prozentsatz: <strong>${newPercent} %</strong>
            </div>`;
        };
      }

      document.getElementById('calcBtn-ergebnisse').onclick = () => renderResults();
      document.getElementById('backBtn-ergebnisse').onclick = (e) => {
        e.preventDefault();
        showPage('start-page');
      };
      
      // Initialize results on page load
      renderResults();
    }
  </script>
</body>
</html>