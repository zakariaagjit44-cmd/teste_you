<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deutsch B2 Prüfung - Komplett</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    :root {
      --primary-color: #1e3a5f;
      --secondary-color: #2c5282;
      --accent-color: #4da6ff;
      --light-color: #ebf8ff;
      --text-color: #2d3748;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--white);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    button {
      cursor: pointer;
    }
    
    /* ===== START PAGE STYLES ===== */
    .start-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      min-height: 100vh;
    }
    
    .start-content {
      max-width: 600px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo {
      margin-bottom: 20px;
    }
    
    .logo-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 18px;
      margin-bottom: 30px;
      opacity: 0.9;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      color: var(--text-color);
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .card p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-color);
      outline: none;
      background-color: var(--white);
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }
    
    .timer-container {
      margin: 25px 0;
    }
    
    .timer-label {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-color);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar {
      height: 8px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress {
      height: 100%;
      width: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transform: scaleX(1);
      transform-origin: left;
      transition: transform 1s linear;
    }
    
    .info-text {
      font-size: 14px;
      margin-top: 20px;
      opacity: 0.8;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn:hover {
      background-color: #3399ff;
    }
    
    /* ===== EXAM PAGE STYLES ===== */
    .exam-body {
      background: #f5f5f5;
      color: #333;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Header Styles */
    header.topbar {
      background: #1e3a5f;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-height: 80px;
    }

    .brand {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .brand .logo {
      width: 80px;
      height: 40px;
      background: #e74c3c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }

    .meta .main-title {
      font-weight: 800;
      font-size: 18px;
    }

    .meta .sub-title {
      font-size: 13px;
      opacity: 0.9;
    }

    .timer {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      margin: 0 20px;
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 10px 20px;
    }

    .exam-btn {
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      background: #4da6ff;
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
      min-width: 150px;
      text-align: center;
    }

    .exam-btn:hover {
      background: #336fbf;
    }
    
    .exam-btn.save {
      background: #4da6ff;
      color: #000;
    }
    
    .exam-btn.save:hover {
      background: #3399ff;
    }
    
    .exam-btn.submit {
      background: #4da6ff;
    }
    
    .exam-btn.submit:hover {
      background: #3399ff;
    }
    
    .exam-btn.result {
      background: #4da6ff;
    }
    
    .exam-btn.result:hover {
      background: #3399ff;
    }
    
    .exam-btn.next {
      background: #4da6ff;
      color: #fff;
    }
    
    .exam-btn.next:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset {
      background: #4da6ff;
    }
    
    .exam-btn.reset:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset-section {
      background: #d35400;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
    }
    
    .exam-btn.reset-section:hover {
      background: #e67e22;
    }
    
    .exam-btn.no-match {
      background: #95a5a6;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
      margin-top: 5px;
    }
    
    .exam-btn.no-match:hover {
      background: #7f8c8d;
    }
    
    .exam-btn.no-match.selected {
      background: #e74c3c;
    }
    
    /* Top Tiles */
    .top-tiles {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1e3a5f;
      border-bottom: 1px solid #0f223a;
    }
    
    .tile {
      flex: 1;
      max-width: 180px;
      text-align: center;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #3b4a63;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    
    .tile:hover {
      background: #4a5b78;
    }
    
    .tile.active {
      background: #ffffff;
      color: #000;
      border-color: #bbb;
    }
    
    .tile.done {
      background: #2ecc71;
      color: #fff;
      border-color: #27ae60;
    }
    
    .tile.done::after {
      content: " ✅";
      margin-left: 5px;
    }
    
    .tile .points {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .tile.active .points {
      background: #e9eefc;
      color: #2c3e50;
    }
    
    /* Container Styles */
    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-full {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .left-panel {
      background: white;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .left-panel .passage {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.8;
    }
    
    .left-panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .right-panel {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 76vh;
      overflow: auto;
    }
    
    .main-panel {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1e3a5f;
      font-weight: 700;
    }
    
    /* Question Styles */
    .question-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .question-body {
      margin-top: 8px;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .option {
      background: #fbfdff;
      border: 1px solid #e1e8f6;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .option:hover {
      background: #f0f6ff;
    }
    
    .option.selected {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .option .radio {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #cfdff6;
      background: #fff;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .option.selected .radio {
      background: #3498db;
      border-color: #3498db;
      box-shadow: inset 0 -3px 0 rgba(0,0,0,0.05);
    }
    
    .text-container {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
      position: relative;
      min-height: 120px;
    }
    
    .text-container:hover {
      background: #f0f6ff;
    }
    
    .text-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    
    .text-content {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .title-slot {
      min-height: 40px;
      margin-top: 10px;
      padding: 8px;
      border: 2px dashed #c8d9f6;
      border-radius: 6px;
      background: #f8fbff;
    }
    
    .title-slot.has-title {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .title-slot.has-x {
      background: #f8d7da;
      border-color: #e74c3c;
      color: #c0392b;
      font-weight: bold;
    }
    
    .headings-bank {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 0;
    }
    
    .heading-item {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 8px;
      background: #f8fbff;
      cursor: grab;
    }
    
    .heading-item:hover {
      background: #e9f0ff;
    }
    
    .heading-item.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .result-correct {
      color: #27ae60;
      font-weight: bold;
    }
    
    .result-incorrect {
      color: #c0392b;
      font-weight: bold;
    }
    
    .result-item {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .instructions {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 15px;
      color: #2c3e50;
    }
    
    .all-questions {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .question-block {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .texts-list, .situations-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .text-item, .situation-item {
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .text-letter {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .situation-number {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .fill-blank-container {
      margin: 20px 0;
    }
    
    .blank-word {
      display: inline-block;
      min-width: 120px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      cursor: pointer;
      position: relative;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
    }
    
    .blank-word.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .options-popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 150px;
    }
    
    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f4fb;
    }
    
    .option-item:hover {
      background: #f0f6ff;
    }
    
    .option-item:last-child {
      border-bottom: none;
    }
    
    .horizontal-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .option-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .option-number {
      font-weight: bold;
      color: #2c3e50;
      min-width: 30px;
    }
    
    .option-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .option-btn {
      padding: 8px 16px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option-btn:hover {
      background: #e9f0ff;
    }
    
    .option-btn.selected {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    .word-bank-vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .bank-word-vertical {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      text-align: center;
      cursor: grab;
    }
    
    .bank-word-vertical.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .blank-slot {
      display: inline-block;
      min-width: 100px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      min-height: 30px;
      vertical-align: middle;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .blank-slot.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .footer-buttons {
      display: flex;
      gap: 10px;
    }
    
    .situation-item.used {
      opacity: 0.7;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #333;
    }
    
    /* Listening Section Styles */
    .listening-task {
      margin-bottom: 10px;
    }
    
    .true-false-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .true-false-table th {
      background: #3498db;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    
    .true-false-table td {
      padding: 15px;
      border-bottom: 1px solid #e1e8f6;
      vertical-align: top;
    }
    
    .true-false-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .true-false-table tr:hover {
      background: #e3f2fd;
    }
    
    .answer-options {
      display: flex;
      gap: 25px;
    }
    
    .answer-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 4px;
      transition: background 0.2s;
      font-weight: 500;
    }
    
    .answer-option:hover {
      background: #e3f2fd;
    }
    
    .answer-option input {
      margin: 0;
      transform: scale(1.2);
    }

    .correct-answer {
      background: #d4edda !important;
      border-left: 4px solid #28a745;
    }
    
    .incorrect-answer {
      background: #f8d7da !important;
      border-left: 4px solid #dc3545;
    }
    
    /* Writing Section Styles */
    .writing-task {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .writing-prompt {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .writing-requirements {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      margin-bottom: 15px;
    }
    
    .writing-requirements h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }
    
    .writing-requirements ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .writing-requirements li {
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    .writing-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .writing-textarea {
      flex: 1;
      min-height: 500px;
      padding: 15px;
      border: 2px solid #e1e8f6;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    
    .writing-textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .word-counter {
      margin-top: 10px;
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
      padding: 8px 0;
    }
    
    .word-counter .count {
      font-weight: bold;
      color: #2c3e50;
    }
    
    /* Results Page Styles */
    .results-body {
      background: #f7fafc;
      color: #0f1724;
      line-height: 1.6;
    }
    
    .results-header {
      background: #1e3a5f;
      color: #fff;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .results-logo {
      background: #fff;
      color: #1e3a5f;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 800;
    }
    
    .results-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .results-container {
      max-width: 1100px;
      margin: 22px auto;
      padding: 20px;
    }
    
    .results-tiles {
      display: flex;
      gap: 12px;
      margin: 18px 0;
    }
    
    .results-tile {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      border-left: 6px solid #1e3a5f;
    }
    
    .results-tile h3 {
      margin: 0;
      font-size: 16px;
      color: #1e3a5f;
    }
    
    .results-tile .score {
      font-size: 20px;
      font-weight: 800;
      margin-top: 8px;
    }
    
    .section-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .section-table th,
    .section-table td {
      padding: 8px;
      border-bottom: 1px solid #e6eef8;
      text-align: left;
      font-size: 14px;
    }
    
    .summary {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .summary .left {
      font-weight: 700;
    }
    
    .summary .right {
      text-align: right;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    
    .results-btn {
      background: #4da6ff;
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .results-btn:hover {
      background: #3a8ce0;
    }
    
    .button-like {
      text-decoration: none;
    }
    
    .small-muted {
      color: #6b7280;
      font-size: 13px;
    }
    
    input[type="number"] {
      width: 90px;
      padding: 8px;
      border: 1px solid #d7e6fb;
      border-radius: 6px;
    }
    
    .note {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    /* Footer */
    footer.controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e1e8f6;
      margin-top: 20px;
    }
    
    .status {
      font-size: 14px;
      color: #7f8c8d;
    }
    
    .ghost {
      background: transparent;
      border: 2px solid #2c3e50;
      color: #2c3e50;
    }
    
    .ghost:hover {
      background: #2c3e50;
      color: white;
    }

    /* Responsive Styles */
    @media (max-width: 980px) {
      .container {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .container-split {
        grid-template-columns: 1fr;
      }
      
      .right-panel {
        order: 2;
      }
      
      .top-tiles {
        padding-left: 8px;
        padding-right: 8px;
      }
      
      header.topbar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .answer-options {
        flex-direction: column;
        gap: 10px;
      }
      
      footer.controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .results-tiles {
        flex-direction: column;
      }
      
      .summary {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 600px) {
      .start-content {
        padding: 25px 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .card {
        padding: 20px 15px;
      }
    }
  </style>
</head>
<body id="body">
  <!-- Start Page -->
  <div id="start-page" class="start-container">
    <div class="start-content">
      <div class="logo">
        <div class="logo-icon">📝</div>
        <h1>Deutsch B2 Prüfung</h1>
        <div class="subtitle">Bereiten Sie sich auf Ihre Prüfung vor</div>
      </div>
      <div class="card">
        <h2>Prüfungsbereich auswählen</h2>
        <p>Wählen Sie bitte den Bereich aus, den Sie üben möchten. Die Prüfung startet automatisch in <span id="time-display">30</span> Sekunden.</p>
        <select id="sectionSelect">
          <option value="lesen">Lesen</option>
          <option value="hoeren">Hören</option>
          <option value="schreiben">Schreiben</option>
        </select>
        <div class="button-container">
          <button id="cancelBtn" class="btn">Abbrechen</button>
          <button id="startBtn" class="btn">Jetzt starten</button>
        </div>
      </div>
      <div class="timer-container">
        <div class="timer-label">Die Prüfung startet in:</div>
        <div class="timer" id="countdown">30</div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
      </div>
      <div class="info-text">Stellen Sie sicher, dass Sie in einer ruhigen Umgebung sind und genügend Zeit haben.</div>
    </div>
  </div>

  <!-- Lesen Page -->
  <div id="lesen-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Lesen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-lesen" class="timer" aria-live="polite">Verbleibende Zeit: 90:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-lesen" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-lesen" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-lesen" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-lesen" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-lesen">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-lesen" role="navigation" aria-label="Sections overview"></div>

    <div class="container">
      <main class="left-panel" id="leftPanel-lesen">
        <div class="passage" id="passage-lesen">
          <h2 id="passageTitle-lesen">Aufgabe</h2>
          <div id="passageContent-lesen"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-lesen" aria-labelledby="questionTitle-lesen">
        <div class="question-head">
          <div>
            <div id="sectionName-lesen" style="font-weight:800"></div>
            <div id="questionTitle-lesen" style="font-size:13px;color:#55607a">Frage</div>
          </div>
          <button id="resetSectionBtn-lesen" class="exam-btn reset-section" style="display:none;">Teil zurücksetzen</button>
        </div>
        <div class="question-body" id="questionBody-lesen"></div>
        <div id="headingsBankContainer-lesen"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-lesen" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-lesen" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-lesen">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Hören Page -->
  <div id="hoeren-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Hörverstehen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-hoeren" class="timer" aria-live="polite">Verbleibende Zeit: 17:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-hoeren" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-hoeren" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-hoeren" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-hoeren" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-hoeren">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-hoeren" role="navigation" aria-label="Sections overview"></div>

    <div class="container-full">
      <main class="main-panel" id="mainPanel-hoeren">
        <div id="contentContainer-hoeren"></div>
      </main>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-hoeren" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-hoeren" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-hoeren">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Schreiben Page -->
  <div id="schreiben-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Schreiben — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-schreiben" class="timer" aria-live="polite">Verbleibende Zeit: 30:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-schreiben" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-schreiben" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-schreiben" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-schreiben" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-schreiben">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-schreiben" role="navigation" aria-label="Sections overview"></div>

    <div class="container-split">
      <main class="left-panel" id="leftPanel-schreiben">
        <div class="passage" id="passage-schreiben">
          <h2 id="passageTitle-schreiben">Aufgabe</h2>
          <div id="passageContent-schreiben"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-schreiben">
        <div id="writingContainer-schreiben"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-schreiben" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-schreiben" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-schreiben">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Ergebnisse Page -->
  <div id="ergebnisse-page" class="results-page" style="display: none;">
    <header class="results-header">
      <div class="results-logo">telc</div>
      <div class="results-title">Gesamtergebnis — Deutsch B2</div>
    </header>

    <div class="results-container">
      <div class="results-tiles" id="topTiles-ergebnisse"></div>
      <div id="details-ergebnisse"></div>
      <div class="summary" id="finalSummary-ergebnisse"></div>
      <div class="controls">
        <a class="button-like" href="#" id="backBtn-ergebnisse">
          <button class="results-btn">🔁 Zurück zur Startseite</button>
        </a>
        <button id="calcBtn-ergebnisse" class="results-btn">✅ Ergebnisse anzeigen</button>
      </div>
      <div class="note">Hinweis: Schreiben (45 Punkte) wird manuell eingegeben, falls nicht automatisch vorhanden.</div>
    </div>
  </div>

  <script>
    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      // Hide all pages
      document.getElementById('start-page').style.display = 'none';
      document.getElementById('lesen-page').style.display = 'none';
      document.getElementById('hoeren-page').style.display = 'none';
      document.getElementById('schreiben-page').style.display = 'none';
      document.getElementById('ergebnisse-page').style.display = 'none';
      
      // Change body class based on page
      document.getElementById('body').className = '';
      if (pageId === 'ergebnisse-page') {
        document.getElementById('body').className = 'results-body';
      } else if (pageId !== 'start-page') {
        document.getElementById('body').className = 'exam-body';
      }
      
      // Show selected page
      document.getElementById(pageId).style.display = 'block';
      
      // Initialize the page if needed
      if (pageId === 'lesen-page' && typeof initLesenPage === 'function') {
        initLesenPage();
      } else if (pageId === 'hoeren-page' && typeof initHoerenPage === 'function') {
        initHoerenPage();
      } else if (pageId === 'schreiben-page' && typeof initSchreibenPage === 'function') {
        initSchreibenPage();
      } else if (pageId === 'ergebnisse-page' && typeof initErgebnissePage === 'function') {
        initErgebnissePage();
      }
    }

    // ===== START PAGE FUNCTIONALITY =====
    let initialCounter = 30;
    let counter = initialCounter;
    let countdownInterval;
    let countdownRunning = false;
    let examStarted = false;
    const timerEl = document.getElementById("countdown");
    const timeDisplayEl = document.getElementById("time-display");
    const progressEl = document.getElementById("progress");
    const selectEl = document.getElementById("sectionSelect");
    const startBtn = document.getElementById("startBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function startCountdown() {
      // prevent double-starts or starting after exam already began
      if (countdownRunning || examStarted) return;
      countdownRunning = true;
      // disable start button while counting
      try { startBtn.disabled = true; startBtn.setAttribute('aria-disabled','true'); } catch(e){}
      // reset counter & UI
      counter = initialCounter;
      timerEl.textContent = counter;
      timeDisplayEl.textContent = counter;
      progressEl.style.transform = "scaleX(0)";
      timerEl.style.color = "";

      countdownInterval = setInterval(() => {
        counter--;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
        const progressValue = (initialCounter - counter) / initialCounter;
        progressEl.style.transform = `scaleX(${progressValue})`;
        if (counter <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRunning = false;
          progressEl.style.transform = "scaleX(1)";
          // ensure exam starts only once
          if (!examStarted) {
            examStarted = true;
            startExam();
          }
          // safety: re-enable start button (page usually navigates away)
          try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
        }
      }, 1000);
    }

    function stopCountdown(reset = true) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownRunning = false;
      try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
      progressEl.style.transform = "scaleX(0)";
      if (reset) {
        counter = initialCounter;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
      } else {
        timerEl.textContent = "Gestoppt";
      }
    }

    function startExam() {
      // guard to ensure startExam is triggered once
      if (!examStarted) examStarted = true;
      const selectedSection = selectEl.value;
      if (selectedSection === 'lesen') {
        showPage('lesen-page');
      } else if (selectedSection === 'hoeren') {
        showPage('hoeren-page');
      } else if (selectedSection === 'schreiben') {
        showPage('schreiben-page');
      }
    }

    // wire buttons: start will now start the countdown (not the exam directly)
    startBtn.addEventListener('click', startCountdown);

    cancelBtn.addEventListener('click', () => {
      stopCountdown(true);
      timerEl.textContent = "Abgebrochen";
      timerEl.style.color = "#e53e3e";
    });

    // ===== LESEN PAGE FUNCTIONALITY =====
    function initLesenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-001",
        durationSec: 90 * 60,
        sections: [
          { 
            id: "s1", 
            title: "Leseverstehen, Teil 1", 
            points: 25,
            passageTitle: "Aufgabe: Ziehen Sie die passenden Überschriften auf die Texte.",
            passage: "",
            questions: [],
            texts: [
              {
                id: "text1",
                content: "Aussteigen, tanken, wegfahren: Wenn die Benzinpreise steigen, ist wieder Hochsaison bei den Benzindieben. Früh morgens und abends schlagen Sie besonders gerne zu. Viele setzen auf den Schutz der Dunkelheit. Vor Weihnachten und im Januar und Februar häufen sich die Fälle. Auch am Monatsende, wenn das Geld knapp wird, steigt die Zahl der Benzindiebstähle. Doch sparen lässt sich durch Benzinklau nicht. Fast alle Täter werden von der Polizei gefasst. Schließlich gibt es an jeder Tankstelle eine Kamera, die das Autokennzeichen aufgenommen hat. Tankwart Kurt Jochimsen aus Emden zeig uns einen Fall aus seiner großen Videosammlung. Ein Wagen mit zwei Insassen fährt an die Zapfsäule. Der Fahrer tankt, seine Frau geht in den Shop. Sie kauft dort zwei Cola und bezahlt. Aber nicht das Benzin. Der Mann hat inzwischen voll getankt und wartet im Wagen. 'Hier Sehen Sie: Die Frau kommt raussteigt ein und das Fahrzeug fährt davon. Hinterher heißt es dann, ich habe doch glatt vergessen, das Benzin zu bezahlen', erklärt Kurt Jochimsen. Bei der Polizei kennt man diese Ausreden. Polizeihauptkommissar Werner Knips: 'Vergessen gilt nicht, es gibt immer eine Anzeige. Und dann wird es richtig teuer.'",
                correctAnswer: "i"
              },
              {
                id: "text2", 
                content: "Viele Autofahrer, die in einen Unfall verwickelt sind, sind so aufgeregt, dass sie vergessen, was zu tun ist. Der Versicherungsexperte Klaus Lenhoff gibt die wichtigsten Tipps: 1. Unfallstelle absichern: Warnblinkanlage einschalten und Warndreieck in 100 Metern Entfernung aufstellen. 2. Rettung aus dem Gefahrenbereich: alle Unfallbeteiligten aus dem Gefahrenbereich retten. Eingeschlossene befreien und Brände sofort bekämpfen. 3. Rettungskräfte informieren: bei schweren Unfällen und wenn es Verletzte gibt, die Polizei (Ruf 110) oder die Rettungsleitstelle (Ruf 112) informieren. Dabei an 'die fünf W's' denken: Wo ist es passiert? Was ist passiert? Wie viele Verletzte? Welche Verletzungen? Warten sie auf Rückfragen. 4. Verletzten Hilfe leisten, zum Beispiel: Kontrolle von Atmung und Puls, Atemspende, stabile Seitenlage, Erkennen und Behandeln eines Schocks, Stillen von Blutungen. 5. Lokalisierung auf der Autobahn: Wo hat sich der Unfall ereignet? 6. Beweismittel sichern: am besten Fotos oder eine Skizze von der Unfallstelle machen. 7. Verkehrsfluß wiederherstellen, also schnell die Fahrbahn räumen. 8. Name, Anschrift und Telefonnummern von Zeugen notieren. 9. Vorsicht bei Aussagen: die Aufregung am Unfallort verleitet zu missverständlichen Äußerungen. Keine Aussagen unter Druck machen. 10. Versicherung des Unfallgegners ermitteln.",
                correctAnswer: "b"
              },
              {
                id: "text3",
                content: "Hast du schon mal mit dem Gedanken gespielt, Pilotin zu werden? Nicht? Dann geht es euch wahrscheinlich wie den meisten Mädchen oder Frauen. Warum wollen eigentlich so wenige Frauen Pilotinnen werden? Nur weil der Beruf angeblich ein typischer Männerberuf ist? Wir haben eine Pilotin getroffen: Monique Bellin ist 39 Jahre alt, wohnt im Süden Frankfurts und ist Pilotin. 'Schon seit früher Kindheit habe ich mich für die Fliegerei interessiert. Es hat mich schon immer fasziniert, dass es mit Hilfe technischer Mittel möglich ist, die Schwerkraft zu überwinden und die Welt aus der Vogelperspektive zu betrachten. Und irgendwann wollte ich diese Technik dann auch selbst beherrschen', so Belling. Seit sie in diesem Beruf arbeite, habe sich ihre Einstellung zu vielen Dingen verändert: 'Ich bin toleranter als vor meinem 'Fliegerleben' - vielleicht weil ich versuche, mein Umfeld aus anderen Perspektiven zu betrachten. Auch meine Freizeit und meine Familie sind mir noch kostbarer geworden, seit ich in diesem Beruf tätig bin', erklärt sie. Hat sie noch Träume? 'Aber ja!', sagt Monique Belling: 'Mit einem Shuttle ins Weltall fliegen, um die Erde als Kugel zu sehen und das Gefühl absoluter Schwerelosigkeit zu erleben'.",
                correctAnswer: "g"
              },
              {
                id: "text4",
                content: "Der Schweizer Louis Palmer hat eine Weltumrundung mit seinem 'Solartaxi' fast abgeschlossen. Er habe bereits 47000 km mit seinem Solarauto zurückgelegt, sagte Palmer bei einem Stopp in Paris. 'Nun habe ich fast den ganzen Planeten umrundet, ohne einen Tropfen Benzin zu brauchen'. Die Batterien des bis zu 90 Stundenkilometer schnelle Solarmobils können Energie für eine Reichweite von 400 km speichern. 'Das Wetter spielt keine Rolle', sagte Palmer. 'Es kann mehrere Tage in Folge regnen, ich fahre ohne Probleme weiter'. Palmer war mit seinem dreirädrigen 'Taxi' im Juli in Luzern gestartet. Seitdem hat er Europa, Asien, Australien, Neuseeland und Nordamerika durchquert. Er zieht einen Anhänger mit sechs Quadratmetern Solarzellen hinter sich her und die Sonnenenergie treibst das Gefährt an. Seit dem Start ist das Solartaxi nur zwei Tage ausgefallen, weil ein Kabel beschädigt war. Gebaut wurde das innovative Fahrzeug von vier Schweizer Ingenieurschulen. Palmer has auch Platz für Beifahrer: Neben ihm saßen schon berühmte Persönlichkeiten aus Politik, Wirtschaft und Showgeschäft im 'Solartaxi'.",
                correctAnswer: "d"
              },
              {
                id: "text5",
                content: "Die Bundesregierung und ihre Spitzenbeamten sind auf Dienstreisen gern mit dem Flugzeug unterwegs - aber nicht nur, wenn es um Fernreisen geht, sondern auch bei kurzen Inlandsreisen. Wie aus der Antwort des Innenministeriums auf eine Frage eines Abgeordneten hervorgeht, gab die Bundesregierung im letzten Jahr 7,7 Millionen Euro für innendeutsche Flugreisen aus. Fahrkarten der Bahn hingegen schlugen lediglich mit 3,2 Millionen zu Buche. Der Vergleich mit anderen Jahren zeigt aber, dass sich die meisten Politiker bemühen, immer häufiger vom Flugzeug auf die Bahn umzusteigen. Eine Ausnahme bildet das Kanzleramt (Flugkosten um 30% erhöht gegenüber dem Vorjahr) sowie ausgerechnet das Ressort des Bundesumweltministers (plus 7%). Vergleichszahlen für den erhöhten und gesenkten Benzinverbrauch für die Dienstwagen der Bundesregierung liegen noch nicht vor.",
                correctAnswer: "e"
              }
            ],
            headings: [
              {id: "a", text: "Benzingeld sparen: Tipp vom Tankwart"},
              {id: "b", text: "Die wichtigsten Erste-Hilfe-Ratschläge"},
              {id: "c", text: "Einmal die Welt als Ganzes sehen"},
              {id: "d", text: "Einmal um die Welt ohne einen Tropfen Benzin"},
              {id: "e", text: "Fliegen statt fahren"},
              {id: "f", text: "Innerdeutsche Reisen besonders beliebt"},
              {id: "g", text: "Frau im All"},
              {id: "h", text: "Schweizer nutzen Solartaxis"},
              {id: "i", text: "Steigende Spritpreise: die Tricks der Autofahrer"},
              {id: "j", text: "Die richtige Unfallversicherung"}
            ]
          },
          { 
            id: "s2", 
            title: "Leseverstehen, Teil 2", 
            points: 25,
            passageTitle: "Korbjagd zu Pferde",
            passage: `Wer sich unter dem zweimal pro Woche stattfindenden Training auf dem Wiesbadener Hofgut Adamstal eine Art 'Kuschehrunde' vorgestellt hatte, der wird schnell eines Besseren belehrt, und der neugierige Betrachter fühlt sich eher auf einen Fußballplatz als in eine Reithalle versetzt. Die festliegenden Spielzüge, die es einzustudieren gilt, sind Bestandteil einer Sportart, die hierzulande allenfalls eine Randerscheinung ist: Horse–Ball.

'Es kommen immer mehr Aktive dazu', versichert jedoch Hans–Jürgen Faust (59), Hausherr auf Hofgut Adamstal und Präsident des Deutschen Horse–Ball–Verbandes. Irgendwo in Hagen, Düsseldorf, München oder Heidelberg soll es noch ein paar vereinzelte Akteure geben, das eigentliche Geschehen aber spielt sich hier ab, wo einer der wohl kleinsten Sportverbände Deutschlands vor 15 Jahren aus der Taufe gehoben wurde und wo die erste Mannschaft der Reitergruppe Wiesbaden (RGW) identisch ist mit der National–Auswahl. Aber diesen Sport betreiben nicht nur Erwachsene: Die jüngsten Spieler sind nicht älter als acht. Horse–Ball ist –vereinfacht gesagt – eine Art Basketball zu Pferde.

An den beiden Enden des zirka 25 mal 70 Meter großen Spielfeldes sind die Korbringe nicht waagerecht, sondern senkrecht ausgerichtet und mit Fangnetzen versehen, in denen die Bälle nach einem gelungenen Spielzug landen. Keine leichte Aufgabe, wie die bereits erwähnten ersten Trainingseindrücke zeigen, aber Übung macht eben auch hier den Meister. Zumindest auf nationaler, sprich: Wiesbadener Ebene.

Darüber hinaus gilt es, immer wieder Lehrgeld zu zahlen, vor allem bei Gastspielen im Heimatland Frankreich, wo Horse–Ball vor rund 25 Jahren erfunden wurde und einen viel höheren Stellenwert als hierzulande genießt. Sogar eine eigene Profiliga gibt es bei unseren südwestlichen Nachbarn, die bei den Mitte August anstehenden Europameisterschaften einmal mehr nicht nur Gastgeber, sondern auch wieder Anwärter auf den Titel sind.

Wer es übrigens selbst einmal ausprobieren möchte: Im kommenden Monat bieten die Wiesbaden Buffalos für maximal zwölf Teilnehmer einen Einstiegs–Lehrgang an. Dabei mitzubringen sind reiterliche Grundkenntnisse und ein so genannter Dreipunkt– Helm. Alles andere wird – inklusive Vierbeiner – bei Bedarf gestellt. 'Natürlich können auch eigene Pferde mitgebracht werden', sagt Faust.

Die Tiere müssen 'sozialverträglich' sein, erläutert der 59–Jährige, und das nicht nur im Umgang mit dem Reiter, sondern vor allem untereinander. 'Im richtigen Wettkampf kann es auch schon mal zu Zusammenstößen kommen', weiß Faust, für den Horse–Ball zu einem ganz persönlichen 'Steckenpferd' geworden ist, das in der vielfältigen Angebotspalette des riesigen Hofguts eine Art Sonderstatus einnimmt.

Damit es trotz unvermeidlichen Körperkontakts kaum einmal zu ernsthaften Verletzungen kommt, tragen nicht nur die Pferde vorgeschriebene Bandagen an den Beinen, sondern auch für die Reiter gibt es eine speielle Vorrichtung: Ein Gurt, der unter dem Bauch der Tiere die beiden Steigbügel miteinander verbindet, gewährt selbst dann noch sicheren Halt, wenn sich der Spieler aus vollem Galopp heraus aus dem Sattel fallen lässt, um den Ball vom Boden aufnehmen zu können. Um die Handhabung dabei ein wenig zu vereinfachen, ist das runde Leder mit Fangriemen versehen, die ein sicheres Zugreifen auch mit einer Hand ermöglichen.

Aber noch eine Besonderheit weist Horse–Ball auf: Es ist die einzige Pferdesportart, bei der der gebraucht einer Gerte (das ist ein kleiner Stock, mit dem das Pferd leicht geschlagen wird) ausdrücklich verboten ist, wie Faust betont. Damit tritt er auch etwaigen Befürchtungen entgegen, dass es zu Tierquälerei kommen könnte. Der Chef des Hofgut Adamstal: 'Das Gegenteil ist der Fall. Die Tiere können beim Horse–Ball ihre natürlichen Verhaltensweisen ausleben und haben sogar Spaß dabei'. Zumindest mehr als der eine oder andere Reiter, wie es angesichts des strengen Trainings den Eindruck macht.`,
            questions: [
              {
                id: "s2q1",
                type: "single",
                text: "Aktive der Wiesbadener Reitergruppe",
                options: [
                  {id: "s2q1o1", text: "bilden die deutsche Nationalmannschaft."},
                  {id: "s2q1o2", text: "spielen schon als Achtjährige in der deutschen Nationalmannschaft mit."},
                  {id: "s2q1o3", text: "unterstützen die deutsche Nationalmannschaft."}
                ],
                correctAnswer: "s2q1o1"
              },
              {
                id: "s2q2",
                type: "single", 
                text: "Die Basketball-Körbe",
                options: [
                  {id: "s2q2o1", text: "hängen wie beim normalen Basketball."},
                  {id: "s2q2o2", text: "sind mit dem Netz nach oben aufgehängt."},
                  {id: "s2q2o3", text: "sind so gedreht, dass ihre Öffnungen nach der Seite zeigen."}
                ],
                correctAnswer: "s2q2o3"
              },
              {
                id: "s2q3",
                type: "single",
                text: "Wer an einem Horse-Ball-Lehrgang teilnimmt,",
                options: [
                  {id: "s2q3o1", text: "braucht ein eigenes Pferd."},
                  {id: "s2q3o2", text: "kann sein eigenes Pferd einsetzen."},
                  {id: "s2q3o3", text: "muss sein Pferd jedes Mal mitbringen."}
                ],
                correctAnswer: "s2q3o2"
              },
              {
                id: "s2q4",
                type: "single",
                text: "Beim Horse-Ball-Spiel",
                options: [
                  {id: "s2q4o1", text: "wird ein Fußball verwendet."},
                  {id: "s2q4o2", text: "darf der Ball in die Hand genommen werden."},
                  {id: "s2q4o3", text: "darf der Ball nicht auf den Boden fallen."}
                ],
                correctAnswer: "s2q4o2"
              },
              {
                id: "s2q5", 
                type: "single",
                text: "Das Training ist so streng, dass",
                options: [
                  {id: "s2q5o1", text: "die Reiter oft mehr Stress zu empfinden scheinen als die Tiere."},
                  {id: "s2q5o2", text: "die Tiere ihre naturgegebenen Anlagen nicht ausleben können."},
                  {id: "s2q5o3", text: "es Pferden und Reitern oft kein Vergnügen macht."}
                ],
                correctAnswer: "s2q5o1"
              }
            ]
          },
          { 
            id: "s3", 
            title: "Leseverstehen, Teil 3", 
            points: 25,
            passageTitle: "Aufgabe: Lesen Sie die zehn Situationen (11-20) und die zwölf Texte (A-L). Welcher Text passt zu welcher Situation? Sie können jeden Text nur einmal verwenden. Manchmal passt kein Text. Wählen Sie dann 'x'.",
            passage: "",
            questions: [],
            texts: [
              {id: "A", text: "Ratgeber 'Was bei Erkältung hilft' - Erkältungen gehören leider zum Leben. Sie kommen immer wieder wie Frühling, Sommer, Herbst und Winter. Jetzt ist wieder Erkältungssaison. Hier sind einige wichtige Tipps. Bei Fieber: mindestens 2–3 Liter Tee oder Mineralwasser trinken. Bei Husten: Hustensaft aus der Apotheke. Bei Halsschmerzen: Gurgeln mit Salbeitee. Bei Schnupfen: Nasenspray oder Inhalieren. Bei Kopfschmerzen: Schmerztabletten. Bei Ohrenschmerzen: sofort zum Arzt. Bei Gliederschmerzen: Wärmflasche und Ruhe. Bei Appetitlosigkeit: Hühnersuppe. Bei Müdigkeit: schlafen. Bei Fieber über 39 Grad: zum Arzt gehen.", correctAnswer: "11"},
              {id: "B", text: "Die Zahl der Arbeitslosen in Deutschland ist im vergangenen Monat auf den niedrigsten Stand seit 20 Jahren gesunken. Die Arbeitslosenquote liegt jetzt bei 5,8 Prozent. Das ist ein Rückgang um 0,3 Prozentpunkte im Vergleich zum Vormonat. Besonders erfreulich ist die Entwicklung in den neuen Bundesländern, wo die Arbeitslosigkeit stärker als im Westen zurückgeht. Die Bundesagentur für Arbeit führt diesen positiven Trend auf die gute Konjunktur und die gestiegene Zahl der sozialversicherungspflichtigen Beschäftigungsverhältnisse zurück.", correctAnswer: null},
              {id: "C", text: "Wenn Sie sich für eine Stelle bewerben, sollten Sie darauf achten, dass Ihre Bewerbungsunterlagen vollständig sind. Dazu gehören ein individuell gestaltetes Anschreiben, ein tabellarischer Lebenslauf, Kopien Ihrer Zeugnisse und gegebenenfalls Arbeitsproben. Das Anschreiben sollte nicht länger als eine Seite sein und auf die ausgeschriebene Stelle zugeschnitten sein. Der Lebenslauf sollte lückenlos sein und Ihre wichtigsten Stationen und Qualifikationen enthalten. Fehlende Unterlagen können dazu führen, dass Ihre Bewerbung nicht berücksichtigt wird.", correctAnswer: "12"},
              {id: "D", text: "Das Assessment-Center ist ein mehrstufiges Auswahlverfahren, bei dem mehrere Bewerber gleichzeitig geprüft werden. Typische Aufgaben sind Gruppendiskussionen, Präsentationen, Rollenspiele und Postkorbübungen. Dabei werden nicht nur fachliche Kompetenzen, sondern auch soziale Fähigkeiten wie Teamfähigkeit, Kommunikationsstärke und Stressresistenz bewertet. Die Teilnehmer sollten sich natürlich verhalten, aber auch ihre Stärken gezielt einsetzen. Vorbereitung ist wichtig, aber Authentizität ist entscheidend.", correctAnswer: "13"},
              {id: "E", text: "Die Bundesagentur für Arbeit bietet verschiedene Leistungen für Arbeitsuchende an. Dazu gehören Beratung, Vermittlung in Arbeit, Förderung von Weiterbildungen und finanzielle Unterstützung. Arbeitslose können sich in den Arbeitsagenturen persönlich beraten lassen oder das Online-Portal der Bundesagentur nutzen. Dort finden sich auch Stellenangebote und Informationen zu Fortbildungsmöglichkeiten. Bei längerer Arbeitslosigkeit kann Arbeitslosengeld beantragt werden.", correctAnswer: "14"},
              {id: "F", text: "Ein Praktikum kann der Einstieg in den Beruf sein. Viele Unternehmen nutzen Praktika, um potenzielle neue Mitarbeiter kennenzulernen. Für Bewerber bietet ein Praktikum die Möglichkeit, Berufserfahrung zu sammeln, Kontakte zu knüpfen und sich für eine spätere Festanstellung zu empfehlen. Wichtig ist, dass das Praktikum zum Berufswunsch passt und dass man sich während dieser Zeit engagiert zeigt. Ein positives Praktikumszeugnis kann bei späteren Bewerbungen von Vorteil sein.", correctAnswer: "15"},
              {id: "G", text: "Die Digitalisierung verändert die Arbeitswelt grundlegend. Immer mehr Tätigkeiten werden automatisiert, neue Berufe entstehen, andere verschwinden. Arbeitnehmer müssen sich kontinuierlich weiterbilden, um mit den Veränderungen Schritt halten zu können. Flexible Arbeitszeiten, Homeoffice und virtuelle Teams werden immer häufiger. Diese Entwicklung bietet neue Chancen, stellt aber auch neue Anforderungen an die Beschäftigten. Lebenslanges Lernen wird zur Notwendigkeit.", correctAnswer: null},
              {id: "H", text: "Bei der Vorbereitung auf ein Vorstellungsgespräch ist es wichtig, sich über das Unternehmen zu informieren. Dazu gehören die Unternehmensgeschichte, die Produkte oder Dienstleistungen, die Unternehmensphilosophie und die aktuellen Entwicklungen. Auch die Branche und die Wettbewerber sollten bekannt sein. Diese Informationen helfen, im Gespräch kompetent aufzutreten und zu zeigen, dass man sich ernsthaft mit der Stelle auseinandergesetzt hat. Vorbereitete Fragen an den Gesprächspartner zeigen Interesse.", correctAnswer: "16"},
              {id: "I", text: "Die Probezeit dauert in der Regel sechs Monate. In dieser Zeit können sowohl Arbeitgeber als auch Arbeitnehmer das Arbeitsverhältnis ohne Angabe von Gründen kündigen. Die Kündigungsfrist beträgt dann zwei Wochen. Die Probezeit dient dazu, festzustellen, ob der Arbeitnehmer für die Stelle geeignet ist und ob er sich in das Unternehmen integrieren kann. Auch der Arbeitnehmer sollte prüfen, ob der Job und das Unternehmen seinen Erwartungen entsprechen.", correctAnswer: "17"},
              {id: "J", text: "Weiterbildung ist in der heutigen Arbeitswelt unverzichtbar. Wer sich nicht regelmäßig fortbildet, riskiert, den Anschluss zu verlieren. Viele Arbeitgeber unterstützen ihre Mitarbeiter bei Weiterbildungen, sei es durch finanzielle Zuschüsse oder durch Freistellung. Auch für Arbeitsuchende gibt es Fördermöglichkeiten durch die Arbeitsagentur. Wichtig ist, dass die Weiterbildung zum Beruf passt und die Karrierechancen verbessert.", correctAnswer: "18"},
              {id: "K", text: "Das Arbeitszeugnis ist ein wichtiges Dokument für jede berufliche Bewerbung. Es sollte die Tätigkeiten und Leistungen des Arbeitnehmers beschreiben und eine Beurteilung enthalten. Formulierungen in Zeugnissen sind oft codiert. 'Stets zu unserer vollsten Zufriedenheit' ist die beste Note, während 'zu unserer Zufriedenheit' nur durchschnittlich ist. Arbeitnehmer haben einen Anspruch auf ein Zeugnis beim Ausscheiden aus dem Unternehmen. Es sollte wahrheitsgemäß sein, aber auch wohlwollend formuliert.", correctAnswer: "19"},
              {id: "L", text: "Das Vorstellungsgespräch ist eine wichtige Hürde bei der Suche nach einem Arbeitsplatz. In der Regel fangen sie mit Smalltalk an: Man redet über das Wetter, den Verkehr und Ähnliches. Doch dabei kommt es schon auf das 'Wie?' an. Wer viel kritisiert, hat schon verloren. Bei der Vorstellung ihrer Person sollten Bewerber darauf achten, dass sie ihre Fähigkeit und den Nutzen, den ihr potentiell zukünftiger Arbeitgeber von ihnen hat, in den Vordergrund stellen, Fragen nach Gesundheit, Familienplanung, Schwangerschaft oder Geld gehören nicht ins Bewerbungsgespräch. Sollten Sie dennoch gestellt werden, ist man nicht verpflichtet, diese wahrheitsgemäß zu beantworten.", correctAnswer: "20"}
            ],
            situations: [
              {id: "11", text: "Sie haben eine Erkältung und suchen nach Hausmitteln."},
              {id: "12", text: "Sie möchten wissen, welche Unterlagen zu einer vollständigen Bewerbung gehören."},
              {id: "13", text: "Sie sollen an einem Auswahlverfahren teilnehmen, bei dem mehrere Kandidaten gemeinsam geprüft werden."},
              {id: "14", text: "Sie sind arbeitslos und suchen Informationen über finanzielle Unterstützung."},
              {id: "15", text: "Sie suchen nach einer Möglichkeit, Berufserfahrung zu sammeln und Kontakte zu knüpfen."},
              {id: "16", text: "Sie bereiten sich auf ein Vorstellungsgespräch vor und wollen sich über das Unternehmen informieren."},
              {id: "17", text: "Sie haben eine neue Stelle angefangen und wollen wissen, wie lange die Probezeit dauert."},
              {id: "18", text: "Sie möchten sich beruflich weiterbilden und suchen nach Fördermöglichkeiten."},
              {id: "19", text: "Sie scheiden aus einem Unternehmen aus und wollen ein Arbeitszeugnis erhalten."},
              {id: "20", text: "Sie wollen wissen, welche Fragen in einem Vorstellungsgespräch nicht gestellt werden dürfen."}
            ]
          },
          { 
            id: "s4", 
            title: "Sprachbausteine, Teil 1", 
            points: 15,
            passageTitle: "Aufgabe: Ergänzen Sie den Text. Wählen Sie für jede Lücke das passende Wort.",
            passage: "",
            questions: [],
            fillBlanks: [
              {
                id: "21",
                options: ["dabei", "daraus", "davon"],
                correctAnswer: "davon"
              },
              {
                id: "22",
                options: ["denen", "die", "den"],
                correctAnswer: "denen"
              },
              {
                id: "23",
                options: ["an", "in", "durch"],
                correctAnswer: "an"
              },
              {
                id: "24",
                options: ["Jeder Mittwoch", "Mittwochs", "Zum Mittwoch"],
                correctAnswer: "Mittwochs"
              },
              {
                id: "25",
                options: ["jedem Kurs", "jeden Kurs", "jedes Kurses"],
                correctAnswer: "jedem Kurs"
              },
              {
                id: "26",
                options: ["der", "deren", "dessen"],
                correctAnswer: "deren"
              },
              {
                id: "27",
                options: ["obwohl", "wobei", "wenn"],
                correctAnswer: "wenn"
              },
              {
                id: "28",
                options: ["Ihnen", "Sie", "Euch"],
                correctAnswer: "Ihnen"
              },
              {
                id: "29",
                options: ["hat", "ist", "wird"],
                correctAnswer: "ist"
              },
              {
                id: "30",
                options: ["eine Diät halten müssen", "müssen eine Diät halten", "müssen halten eine Diät"],
                correctAnswer: "eine Diät halten müssen"
              }
            ],
            fillText: `Sehr geehrte Frau Goronsksa,

vielen Dank für Ihre Anfrage vom 12. September bezüglich unserer Sprachurlaube in Deutschland und Österreich. Unsere Organisation unterhält insgesamt zehn Schulen, acht ________ in Deutschland und zwei in Österreich, an ________ Sie ausnahmslos sowohl Ihr Deutsch verbessern als auch an einem anspruchsvollen Kultur- und Freizeitprogramm teilnehmen können.

Der Sprachunterricht findet in der Regel ________ fünf Tagen pro Woche statt, jeweils in der Zeit von 9 bis 13 und von 15 bis 17 Uhr. ________ ist kein Nachmittagsunterricht. Das Kursangebot umfasst alle Niveaustufen. Die Mindestdauer für einen Kurs beträgt zwei Wochen, Sie können jedoch auch vier, six oder acht Wochen bleiben. Zu Beginn ________ wird ein Einstufungstest durchgeführt, mit ________ Hilfe wir herausfinden, welcher Kurs für Sie der geeignete ist. Nach Abschluss Ihres Aufenthaltes erhalten Sie eine Teilnahmebescheinigung. Selbstverständlich können Sie bei uns Tests auf allen Niveaustufen von A1 bis C1 ablegen und erhalten, ________ Sie den Test bestehen, ein international anerkanntes Zertifikat.

Hinsichtlich unseres Kultur- und Freizeitprogramms gibt es verschiedene Wahlmöglichkeiten, die ________ vor Ort angeboten werden. Dazu zählen Ausflüge in die nähere Umgebung, Museums- und Theaterbesuche und vieles mehr.

Was die Übernachtung am Kursort angeht, können Sie zwischen einer Unterbringung in einer Gastfamilie und der Unterkunft in einfachen Hotels wählen. Im Unterkunftspreis ________ jeweils Halbpension eingeschlossen, das heißt Frühstück und Mittagessen. Bitte teilen Sie uns mit, wenn Sie bestimmte Lebensmittel ausschließen, z. B. vegetarisch essen oder ________. Alles Weitere entnehmen Sie bitte dem beiliegenden Katalog. Bei weiteren Fragen sind wir gerne für Sie da.

Mit freundlichen Grüßen Natalie Spengler`
          },
          { 
            id: "s5", 
            title: "Sprachbausteine, Teil 2", 
            points: 15,
            passageTitle: "Aufgabe: Lesen Sie den Text und entscheiden Sie, welches Wort in welche Lücke passt. Sie können jedes Wort nur einmal verwenden. Nicht alle Wörter passen in den Text.",
            passage: "",
            questions: [],
            fillBlanks2: [
              {
                id: "31",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "KAUM"
              },
              {
                id: "32", 
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "DANN"
              },
              {
                id: "33",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "AN"
              },
              {
                id: "34",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "AUF"
              },
              {
                id: "35",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "VORBEI"
              },
              {
                id: "36",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "SOLLEN"
              },
              {
                id: "37",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "NICHT NUR"
              },
              {
                id: "38",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "DENEN"
              },
              {
                id: "39",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "DASS"
              },
              {
                id: "40",
                options: ["AN", "AUF", "BEINAHE", "DAFÜR", "DANN", "DENN", "DÜRFEN", "FAST", "INNERHALB", "KAUM", "MÜSSEN", "SOLLEN", "STATT", "VOR", "VORBEI"],
                correctAnswer: "KEINE"
              }
            ],
            fillText2: `Der Hund als intelligentes Wesen

Hunde sind beliebte Begleiter vieler Menschen. Gerade in den Großstädten Deutschlands und Österreichs gibt es eine große Anzahl an Hundebesitzern, die das Tier als Freund, manchmal sogar als Helfer schätzen. Bislang galt die Auffassung, Hunde seien zwar treu, aber ________ ihre Intelligenz betrifft, eher mit geringen Begabungen ausgestattet. Doch ________ haben wissenschaftliche Experimente ________ der Universität Wien und am Max-Planck-Institut in Leipzig die Hundeehre gerettet und bewiesen: Der Hund ist ein außerordentlich intelligentes Lebewesen und kommt in einer Vielzahl von Strategien, die er anwendet, an menschliche Denkmuster durchaus heran.

Friederike Range von der Universität Wien setzte ihren Hund vor einen Computer. Der Hund sollte ________ verschiedenen Bildern, von denen jeweils zwei auf dem Monitor zu sehen waren, das richtige auswählen und ________ entweder einen Menschen oder eine Landschaft erkennen. Der Monitor war mit einem Touchscreen ausgestattet, ________ der Hund mit der Schnauze auf das jeweils richtige Bild tippen konnte. Lag er richtig, bekam er ein Stück Trockenfutter als Belohnung, lag er falsch, wurde der Bildschirm kurz rot und zeigte gleich im Anschluss das nächste Bilderpaar.

Das Ergebnis war verblüffend. Der Hund hing ________ mit einer ähnlicher Begeisterung und Ausdauer am Bildschirm wir manch Jugendlicher an der Playstation, sondern er war auch bei seinen Entscheidungen äußerst treffsicher. Die Leipziger Forscherin Juliane Kaminski setzte ihren Hund vor zwei Gefäße, von ________ eins Futter enthielt, das andere nicht. Danach schaute sie in die Richtung des Behälters, in dem das Fleischstück lag. Der Hund beobachtete sie dabei und interpretierte die menschliche Mimik richtig.

Dasselbe Experiment mit dem gleichen Ergebnis mit Hundebabys wiederholt. Daraus schließen die Forscher in Leipzig, ________ bestimmte Muster menschlicher Gestik und Mimik von den Hunden sehr treffsicher interpretiert werden können und diese Fähigkeiten bereits seit langem bei Hunden vorhanden sein müssen. Man kann also mit Recht annehmen, dass die Interpretationsfähigkeit menschlicher Mimik und Gestik bei den Hunden genetisch verankert ist.

Ähnliche Experimente mit Wölfen, die als die Vorfahren des Haushundes gelten, brachten ________ vergleichbaren Resultate. Ein weiterer Beweis also dafür, dass der Hund diese Fähigkeiten gelernt und verinnerlicht haben muss.`
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        questionIndex: 0, 
        answers: {}, 
        marked: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      const topTiles = document.getElementById('topTiles-lesen');
      const passageTitleEl = document.getElementById('passageTitle-lesen');
      const passageContentEl = document.getElementById('passageContent-lesen');
      const sectionNameEl = document.getElementById('sectionName-lesen');
      const questionTitleEl = document.getElementById('questionTitle-lesen');
      const questionBodyEl = document.getElementById('questionBody-lesen');
      const headingsBankContainer = document.getElementById('headingsBankContainer-lesen');
      const timerEl = document.getElementById('timer-lesen');
      const statusText = document.getElementById('statusText-lesen');
      const resultBtn = document.getElementById('resultBtn-lesen');
      const resetBtn = document.getElementById('resetBtn-lesen');
      const resetSectionBtn = document.getElementById('resetSectionBtn-lesen');

      /* ===== Timer Functions ===== */
      function startTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(()=>{
          if(state.remaining <= 0){
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay(){
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Reset Section Function ===== */
      function resetCurrentSection() {
        const currentSection = exam.sections[state.sectionIndex];
        
        if (confirm(`Möchten Sie wirklich den Teil "${currentSection.title}" zurücksetzen? Alle Antworten in diesem Teil werden gelöscht.`)) {
          if (currentSection.id === 's1') {
            currentSection.texts.forEach(text => {
              delete state.answers[text.id];
            });
          } else if (currentSection.id === 's2') {
            currentSection.questions.forEach(question => {
              delete state.answers[question.id];
            });
          } else if (currentSection.id === 's3') {
            currentSection.situations.forEach(situation => {
              delete state.answers[situation.id];
            });
          } else if (currentSection.id === 's4') {
            currentSection.fillBlanks.forEach(blank => {
              delete state.answers[blank.id];
            });
          } else if (currentSection.id === 's5') {
            currentSection.fillBlanks2.forEach(blank => {
              delete state.answers[blank.id];
            });
          }
          
          renderAll();
        }
      }

      /* ===== Render ===== */
      function renderTopTiles(){ 
        topTiles.innerHTML=''; 
        exam.sections.forEach((sec,idx)=>{ 
          const div=document.createElement('div'); 
          div.className='tile'+(idx===state.sectionIndex?' active':'')+(isSectionDone(sec)?' done':''); 
          div.innerHTML=`<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick=()=>{state.sectionIndex=idx; state.questionIndex=0; state.showResults=false; renderAll();}; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section){
        if(section.id==='s1') return section.texts.every(t=>state.answers[t.id]);
        if(section.id==='s2') return section.questions.every(q=>state.answers[q.id]);
        if(section.id==='s3') return section.situations.every(h=>state.answers[h.id] || state.answers[h.id] === 'X');
        if(section.id==='s4') return section.fillBlanks.every(b=>state.answers[b.id]);
        if(section.id==='s5') return section.fillBlanks2.every(b=>state.answers[b.id]);
        return false;
      }

      function renderAll(){
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        sectionNameEl.textContent = section.title;
        passageTitleEl.textContent = section.passageTitle;
        
        resetSectionBtn.style.display = 'block';
        
        if(state.showResults){
          renderResults();
          return;
        }
        
        if(section.id === 's1'){
          renderPart1();
        } else if(section.id === 's2'){
          renderPart2();
        } else if(section.id === 's3'){
          renderPart3();
        } else if(section.id === 's4'){
          renderSprachbausteine1();
        } else if(section.id === 's5'){
          renderSprachbausteine2();
        }
      }

      function renderPart1(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `<div class="instructions">Ziehen Sie die passenden Überschriften auf die Texte. Sie können jede Überschrift nur einmal verwenden.</div>`;
        
        section.texts.forEach((text, idx) => {
          const letter = String.fromCharCode(97 + idx);
          const selectedHeading = state.answers[text.id];
          
          textsHTML += `
            <div class="text-container">
              <div class="text-title">Text ${letter.toUpperCase()}</div>
              <div class="text-content">${text.content}</div>
              <div class="title-slot ${selectedHeading ? 'has-title' : ''}" data-text-id="${text.id}">
                ${selectedHeading ? getHeadingTextById(selectedHeading) : 'Ziehen Sie hier eine Überschrift hin'}
              </div>
            </div>
          `;
        });
        
        passageContentEl.innerHTML = textsHTML;
        
        let headingsHTML = `<div class="headings-bank">`;
        section.headings.forEach(heading => {
          const isUsed = section.texts.some(text => state.answers[text.id] === heading.id);
          
          headingsHTML += `
            <div class="heading-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-heading-id="${heading.id}">
              ${heading.id}) ${heading.text}
            </div>
          `;
        });
        
        headingsHTML += `</div>`;
        
        headingsBankContainer.innerHTML = headingsHTML;
        
        setupDragAndDrop();
        
        questionBodyEl.innerHTML = '';
        questionTitleEl.textContent = '';
      }

      function getHeadingTextById(id){
        const section = exam.sections[state.sectionIndex];
        const heading = section.headings.find(h => h.id === id);
        return heading ? `${heading.id}) ${heading.text}` : '';
      }

      function setupDragAndDrop(){
        const headingItems = document.querySelectorAll('.heading-item:not(.used)');
        const titleSlots = document.querySelectorAll('.title-slot');
        
        headingItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.headingId);
          });
        });
        
        titleSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            slot.style.background = slot.classList.contains('has-title') ? '#e8fbe9' : '#f8fbff';
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const headingId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === headingId) {
                delete state.answers[key];
              }
            });
            
            state.answers[textId] = headingId;
            renderAll();
          });
        });
      }

      function renderPart2(){
        const section = exam.sections[state.sectionIndex];
        
        passageContentEl.innerHTML = `<div class="passage">${section.passage}</div>`;
        
        let questionsHTML = `<div class="all-questions">`;
        
        section.questions.forEach((question, idx) => {
          const questionNumber = idx + 1;
          const userAnswer = state.answers[question.id];
          
          questionsHTML += `
            <div class="question-block">
              <div class="question-text">${questionNumber}. ${question.text}</div>
              <div class="options">
                ${question.options.map(opt => `
                  <div class="option ${userAnswer === opt.id ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectOption('${question.id}', '${opt.id}')">
                    <div class="radio"></div>
                    <div>${opt.text}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = questionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function renderPart3(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `
          <div class="instructions">Ziehen Sie die passenden Situationen auf die Texte. Sie können jede Situation nur einmal verwenden. Manchmal passt keine Situation.</div>
          <div class="texts-list">
            <h3>Texte (A-L)</h3>
        `;
        
        section.texts.forEach(text => {
          const userAnswer = Object.keys(state.answers).find(key => state.answers[key] === text.id);
          const selectedSituation = userAnswer ? section.situations.find(h => h.id === userAnswer) : null;
          
          textsHTML += `
            <div class="text-item" data-text-id="${text.id}">
              <div class="text-letter">${text.id})</div>
              <div class="text-content">${text.text}</div>
              <div class="title-slot ${userAnswer ? 'has-title' : ''} ${userAnswer === 'X' ? 'has-x' : ''}" data-text-id="${text.id}">
                ${selectedSituation ? selectedSituation.text : (userAnswer === 'X' ? 'X - Keine passende Situation' : 'Ziehen Sie hier eine Situation hin')}
              </div>
            </div>
          `;
        });
        
        textsHTML += `</div>`;
        
        passageContentEl.innerHTML = textsHTML;
        
        let situationsHTML = `
          <div class="situations-list">
            <h3>Situationen (11-20)</h3>
        `;
        
        section.situations.forEach((situation, idx) => {
          const situationNumber = parseInt(situation.id);
          const isUsed = state.answers[situation.id];
          const isX = state.answers[situation.id] === 'X';
          
          situationsHTML += `
            <div class="situation-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-situation-id="${situation.id}">
              <div class="situation-number">${situationNumber}.</div>
              <div class="situation-text">${situation.text}</div>
              ${!isUsed ? `<button class="exam-btn no-match ${isX ? 'selected' : ''}" onclick="window.lesenApp.markNoMatch('${situation.id}')">X - Kein passender Text</button>` : ''}
            </div>
          `;
        });
        
        situationsHTML += `</div>`;
        
        questionBodyEl.innerHTML = situationsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
        
        setupPart3DragAndDrop();
      }

      function markNoMatch(situationId) {
        Object.keys(state.answers).forEach(key => {
          if(state.answers[key] === situationId) {
            delete state.answers[key];
          }
        });
        
        state.answers[situationId] = 'X';
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function setupPart3DragAndDrop(){
        const situationItems = document.querySelectorAll('.situation-item:not(.used)');
        const textSlots = document.querySelectorAll('.text-item .title-slot');
        
        situationItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.situationId);
          });
        });
        
        textSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            const hasTitle = slot.classList.contains('has-title');
            const hasX = slot.classList.contains('has-x');
            slot.style.background = hasTitle ? '#e8fbe9' : (hasX ? '#f8d7da' : '#f8fbff');
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const situationId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === situationId) {
                delete state.answers[key];
              }
            });
            
            state.answers[situationId] = textId;
            renderAll();
          });
        });
      }

      function renderSprachbausteine1(){
        const section = exam.sections[state.sectionIndex];
        
        let textWithBlanks = section.fillText;
        
        const blankPlaceholders = [];
        section.fillBlanks.forEach(blank => {
          blankPlaceholders.push(`BLANK_${blank.id}`);
        });
        
        let tempText = textWithBlanks;
        blankPlaceholders.forEach((placeholder, index) => {
          tempText = tempText.replace('________', placeholder);
        });
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          const displayText = userAnswer ? userAnswer : '________';
          tempText = tempText.replace(`BLANK_${blank.id}`, `<span class="blank-word ${userAnswer ? 'has-answer' : ''}" data-blank-id="${blank.id}">${displayText}</span>`);
        });
        
        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können die Lücken in beliebiger Reihenfolge ausfüllen.</div>
          <div class="fill-blank-container">${tempText}</div>
        `;
        
        document.querySelectorAll('.blank-word').forEach(blank => {
          blank.addEventListener('click', (e) => {
            showOptionsPopup(e.target);
          });
        });
        
        let optionsHTML = `<div class="horizontal-options" style="gap: 8px;">`;
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          
          optionsHTML += `
            <div class="option-row" style="padding: 8px; margin-bottom: 5px;">
              <div class="option-number">${blank.id}</div>
              <div class="option-buttons">
                ${blank.options.map(opt => `
                  <div class="option-btn ${userAnswer === opt ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectSprachbausteine1('${blank.id}', '${opt}')" 
                       style="padding: 6px 12px; font-size: 12px;">
                    ${opt}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        optionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = optionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function showOptionsPopup(blankElement){
        const existingPopup = document.querySelector('.options-popup');
        if(existingPopup) {
          existingPopup.remove();
        }
        
        const blankId = blankElement.getAttribute('data-blank-id');
        const section = exam.sections.find(s => s.id === 's4');
        const blank = section.fillBlanks.find(b => b.id === blankId);
        
        if(!blank) return;
        
        const popup = document.createElement('div');
        popup.className = 'options-popup';
        
        blank.options.forEach(opt => {
          const optionItem = document.createElement('div');
          optionItem.className = 'option-item';
          optionItem.textContent = opt;
          optionItem.onclick = () => {
            selectSprachbausteine1(blankId, opt);
            popup.remove();
          };
          popup.appendChild(optionItem);
        });
        
        blankElement.appendChild(popup);
      }

      function selectSprachbausteine1(blankId, answer){
        state.answers[blankId] = answer;
        renderAll();
      }

      function renderSprachbausteine2(){
        const section = exam.sections[state.sectionIndex];
        // Build text but replace blanks with unique placeholders first (prevents ambiguous replacements)
        let textWithPlaceholders = section.fillText2;
        const placeholders = [];
        section.fillBlanks2.forEach(blank => {
          const ph = `BLANK_${blank.id}`;
          placeholders.push({id: blank.id, ph});
          // replace first occurrence of the visual underline with placeholder
          textWithPlaceholders = textWithPlaceholders.replace('________', ph);
        });

        // Now replace placeholders with actual span elements showing current answer (or underscore)
        placeholders.forEach(item => {
          const userAnswer = state.answers[item.id];
          const displayText = userAnswer ? userAnswer : '________';
          const span = `<span class="blank-slot ${userAnswer ? 'has-answer' : ''}" data-blank-id="${item.id}">${displayText}</span>`;
          textWithPlaceholders = textWithPlaceholders.replace(item.ph, span);
        });

        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können jedes Wort nur einmal verwenden.</div>
          <div class="fill-blank-container">${textWithPlaceholders}</div>
        `;

        // attach click handlers to slots
        document.querySelectorAll('.blank-slot').forEach(slot => {
          slot.addEventListener('click', (e) => {
            // use the element itself to open popup
            showSprachbausteine2Options(slot);
          });
        });

        // Build word bank on the right
        let wordBankHTML = `<div class="word-bank-vertical" style="gap: 8px;">`;
        const usedWords = Object.values(state.answers);
        // Use section.wordBank if present, otherwise derive from fillBlanks2 options
        const bank = section.fillBlanks2[0] ? section.fillBlanks2[0].options : [];
        bank.forEach(word => {
          const isUsed = usedWords.includes(word);
          wordBankHTML += `
            <div class="bank-word-vertical ${isUsed ? 'used' : ''}" 
                 draggable="${!isUsed}" 
                 data-word="${word}"
                 ${!isUsed ? `onclick="window.lesenApp.selectSprachbausteine2FromBank('${word}')"` : ''}>
              ${word}
            </div>
          `;
        });
        wordBankHTML += `</div>`;
        questionBodyEl.innerHTML = wordBankHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';

        setupSprachbausteine2DragAndDrop();
      }

      // --- Added functions to handle drag/drop and clicks for Sprachbausteine Teil 2 ---
      let lastClickedSprachSlot = null;

      function setupSprachbausteine2DragAndDrop(){
        // bank words: make draggable if not used, attach dragstart
        const bankWords = Array.from(document.querySelectorAll('.bank-word-vertical'));
        bankWords.forEach(el => {
          const word = el.dataset.word;
          if(!el.classList.contains('used')){
            el.setAttribute('draggable','true');
          } else {
            el.setAttribute('draggable','false');
          }
          // ensure single attached listener
          el.removeEventListener('dragstart', el._dstart);
          el._dstart = (e) => {
            e.dataTransfer.setData('text/plain', word);
            // also set an indicator
            e.dataTransfer.setData('source', 'bank');
          };
          el.addEventListener('dragstart', el._dstart);

          // keep onclick behavior (select into clicked slot)
          el.removeEventListener('click', el._onclick);
          el._onclick = () => {
            if(el.classList.contains('used')) return;
            selectSprachbausteine2FromBank(word);
          };
          el.addEventListener('click', el._onclick);
        });

        // blank slots: allow drop
        const slots = Array.from(document.querySelectorAll('.blank-slot'));
        slots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', (e) => {
            slot.classList.remove('drag-over');
          });
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            slot.classList.remove('drag-over');
            const word = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html');
            if(!word) return;
            // Determine blank id
            const blankId = slot.dataset.blankId;
            if(!blankId) return;
            // If this word is already used in another slot, free it
            Object.keys(state.answers).forEach(k => {
              if(state.answers[k] === word){
                delete state.answers[k];
              }
            });
            // If slot had a previous answer, free that bank word
            const prev = state.answers[blankId];
            if(prev){
              const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
              if(prevEl){
                prevEl.classList.remove('used');
                prevEl.setAttribute('draggable','true');
                prevEl.addEventListener('click', prevEl._onclick);
              }
            }
            // mark bank word used
            const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
            if(bankEl){
              bankEl.classList.add('used');
              bankEl.setAttribute('draggable','false');
              // remove click to prevent double-placing
              bankEl.removeEventListener('click', bankEl._onclick);
            }
            // assign to state and re-render
            state.answers[blankId] = word;
            renderAll();
          });
        });
      }

      function showSprachbausteine2Options(slot){
        // highlight selected slot so click from bank knows target
        document.querySelectorAll('.blank-slot').forEach(s => s.classList.remove('selected-sprach'));
        slot.classList.add('selected-sprach');
        lastClickedSprachSlot = slot;
      }

      function selectSprachbausteine2FromBank(word){
        // choose target slot: prefer lastClicked, otherwise first empty
        let slot = lastClickedSprachSlot;
        if(!slot){
          slot = Array.from(document.querySelectorAll('.blank-slot')).find(s => {
            const id = s.dataset.blankId;
            return !state.answers[id];
          });
        }
        if(!slot) {
          // if none available, do nothing
          return;
        }
        const blankId = slot.dataset.blankId;
        // free previous occurrence of word
        Object.keys(state.answers).forEach(k => {
          if(state.answers[k] === word){
            delete state.answers[k];
          }
        });
        // free previous word in target slot
        const prev = state.answers[blankId];
        if(prev){
          const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
          if(prevEl){
            prevEl.classList.remove('used');
            prevEl.setAttribute('draggable','true');
            if(prevEl._onclick) prevEl.addEventListener('click', prevEl._onclick);
          }
        }
        // mark selected bank word as used
        const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
        if(bankEl){
          bankEl.classList.add('used');
          bankEl.setAttribute('draggable','false');
          if(bankEl._onclick) try{ bankEl.removeEventListener('click', bankEl._onclick); }catch(e){}
        }
        // assign value
        state.answers[blankId] = word;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        lastClickedSprachSlot = null;
        renderAll();
      }

      function selectOption(questionId, optionId){
        state.answers[questionId] = optionId;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function renderResults(){
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        let totalCorrect = 0;
        let totalQuestions = 0;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="result-item"><h3>${section.title}</h3>`;
          
          if(section.id === 's1'){
            section.texts.forEach(text => {
              totalQuestions++;
              const userAnswer = state.answers[text.id];
              const isCorrect = userAnswer === text.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Text ${text.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's2'){
            section.questions.forEach(question => {
              totalQuestions++;
              const userAnswer = state.answers[question.id];
              const isCorrect = userAnswer === question.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>${question.text}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's3'){
            section.situations.forEach(situation => {
              totalQuestions++;
              const userAnswer = state.answers[situation.id];
              const correctText = section.texts.find(t => t.correctAnswer === situation.id);
              const isCorrect = userAnswer === (correctText ? correctText.id : null);
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Situation ${situation.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's4'){
            section.fillBlanks.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's5'){
            section.fillBlanks2.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          }
          
          resultsHTML += `</div>`;
        });
        
        const percentage = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        resultsHTML += `<div class="result-item"><h3>Gesamtergebnis: ${totalCorrect}/${totalQuestions} (${percentage}%)</h3></div>`;
        
        passageContentEl.innerHTML = resultsHTML;
        questionBodyEl.innerHTML = '';
        sectionNameEl.textContent = 'Ergebnisse';
        questionTitleEl.textContent = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex > 0){
          state.sectionIndex--;
          state.questionIndex = 0;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex < exam.sections.length - 1){
          state.sectionIndex++;
          state.questionIndex = 0;
          renderAll();
        }
      });

      resultBtn.addEventListener('click', ()=>{
        state.showResults = !state.showResults;
        renderAll();
      });

      resetBtn.addEventListener('click', ()=>{
        if(confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')){
          state.answers = {};
          state.marked = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      resetSectionBtn.addEventListener('click', resetCurrentSection);

      document.getElementById('saveBtn-lesen').addEventListener('click', ()=>{
        statusText.textContent = 'Gespeichert';
        setTimeout(()=>{statusText.textContent = 'Nicht gespeichert'}, 2000);
      });

      document.getElementById('submitBtn-lesen').addEventListener('click', ()=>{
        if(confirm('Möchten Sie die Prüfung wirklich abgeben?')){
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        showPage('hoeren-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
      window._lesenState = state;
      window.lesenApp = {
        selectOption,
        markNoMatch,
        selectSprachbausteine1,
        selectSprachbausteine2FromBank
      };
    }

    // ===== HÖREN PAGE FUNCTIONALITY =====
    function initHoerenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-hörverstehen",
        durationSec: 17 * 60, // 17 minutes in seconds
        sections: [
          { 
            id: "hörverstehen1", 
            title: "Hörverstehen, Teil 1", 
            points: 25,
            correctAnswers: { "41": "richtig", "42": "falsch", "43": "falsch", "44": "richtig", "45": "falsch" },
            questions: [
              {
                id: "41",
                text: "Wegen Unwetterschäden wurden Urlauber in einer Notunterkunft untergebracht."
              },
              {
                id: "42", 
                text: "Sämtliche Waren der Firma Mirella wurden aus den Läden entfernt."
              },
              {
                id: "43",
                text: "Das Arbeitsplatzangebot in der Bundesrepublik hat einen Tiefstand erreicht."
              },
              {
                id: "44",
                text: "Am 21. Mai ist der Besuch der Sonderausstellung kostenlos."
              },
              {
                id: "45",
                text: "Entlaufene Tiere verursachten einen Unfall auf der Autobahn."
              }
            ]
          },
          { 
            id: "hörverstehen2", 
            title: "Hörverstehen, Teil 2", 
            points: 25,
            correctAnswers: { "46": "richtig", "47": "falsch", "48": "richtig", "49": "richtig", "50": "falsch", "51": "falsch", "52": "falsch", "53": "richtig", "54": "falsch", "55": "falsch" },
            questions: [
              {
                id: "46",
                text: "Nadine Wagner ist gerade erst von ihrer Weltreise zurückgekehrt."
              },
              {
                id: "47",
                text: "Sie hatte vor der Weltreise einige Zweifel und Bedenken."
              },
              {
                id: "48", 
                text: "Die Journalistin ist während ihrer Reise auch geflogen."
              },
              {
                id: "49",
                text: "Sie hat für dieses Abenteuer ihre Stelle gekündigt."
              },
              {
                id: "50",
                text: "Ihre Freunde waren unterschiedlicher Meinung über ihr Vorhaben."
              },
              {
                id: "51",
                text: "In Tadschikistan hat sie eine Zeit lang andere Motorradfahrer begleitet."
              },
              {
                id: "52",
                text: "Sie hat auf der Reise ihr ganzes Erspartes aufgebraucht."
              },
              {
                id: "53",
                text: "Nadine Wagner hat auf der Reise gelegentlich gearbeitet."
              },
              {
                id: "54",
                text: "Sie hat am meisten ihre eigene Wohnung vermisst."
              },
              {
                id: "55",
                text: "Nach ihrer Rückkehr musste sie nicht lange nach einer neuen Arbeit suchen."
              }
            ]
          },
          { 
            id: "hörverstehen3", 
            title: "Hörverstehen, Teil 3", 
            points: 25,
            correctAnswers: { "56": "richtig", "57": "falsch", "58": "falsch", "59": "richtig", "60": "falsch" },
            questions: [
              {
                id: "56",
                text: "Morgen muss man im Süden Deutschlands mit Schnee rechnen."
              },
              {
                id: "57",
                text: "Die zwei Jungen sind von zu Hause weggelaufen."
              },
              {
                id: "58",
                text: "Am Samstag können Sie einen Mitarbeiter der Firma anrufen."
              },
              {
                id: "59",
                text: "Wegen einer Demonstration ist es verboten, in die Nürnberger Altstadt zu fahren."
              },
              {
                id: "60",
                text: "Die historische elektrische Eisenbahn wird im Dezember wie gewohnt fahren."
              }
            ]
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-hoeren');
      const contentContainer = document.getElementById('contentContainer-hoeren');
      const timerEl = document.getElementById('timer-hoeren');
      const statusText = document.getElementById('statusText-hoeren');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        const answers = state.answers[section.id];
        if (!answers) return false;
        
        // تحقق إذا تمت الإجابة على جميع الأسئلة في هذا القسم
        const answeredQuestions = Object.keys(answers).length;
        const totalQuestions = section.questions.length;
        
        return answeredQuestions === totalQuestions;
      }

      function renderAll() {
        renderTopTiles();
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderListeningSection();
      }

      function renderListeningSection() {
        const section = exam.sections[state.sectionIndex];
        const currentAnswers = state.answers[section.id] || {};
        
        let contentHTML = `
          <div class="panel-title">${section.title}</div>
          <div class="instructions">
            Sie hören die Nachrichten. Entscheiden Sie beim Hören, ob die Aussagen richtig oder falsch sind. 
            Sie hören die Nachrichten nur einmal. Sie haben jetzt 30 Sekunden, um die Aussagen zu lesen.
          </div>
          
          <div class="listening-task">
            <table class="true-false-table">
              <thead>
                <tr>
                  <th style="width: 10%">Nr.</th>
                  <th style="width: 60%">Aussage</th>
                  <th style="width: 30%">Ihre Antwort</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        section.questions.forEach((question, index) => {
          const currentAnswer = currentAnswers[question.id] || '';
          contentHTML += `
            <tr>
              <td><strong>${question.id}</strong></td>
              <td class="question-text">${question.text}</td>
              <td>
                <div class="answer-options">
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="richtig" 
                      ${currentAnswer === 'richtig' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Richtig
                  </label>
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="falsch" 
                      ${currentAnswer === 'falsch' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Falsch
                  </label>
                </div>
              </td>
            </tr>
          `;
        });
        
        contentHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        contentContainer.innerHTML = contentHTML;
      }

      function updateListeningAnswer(sectionId, questionId, answer) {
        if (!state.answers[sectionId]) {
          state.answers[sectionId] = {};
        }
        state.answers[sectionId][questionId] = answer;
        try{ localStorage.setItem('hoerenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        
        // إعادة عرض البلاطات لتحديث حالة "تم"
        renderTopTiles();
      }

      function renderResults() {
        let resultsHTML = `<div class="panel-title">Ergebnisse - Hörverstehen</div>`;
        
        exam.sections.forEach(section => {
          const userAnswers = state.answers[section.id] || {};
          let correctCount = 0;
          
          resultsHTML += `
            <div class="listening-task">
              <h3>${section.title} (${section.points} Punkte)</h3>
              <table class="true-false-table">
                <thead>
                  <tr>
                    <th style="width: 10%">Nr.</th>
                    <th style="width: 50%">Aussage</th>
                    <th style="width: 15%">Ihre Antwort</th>
                    <th style="width: 15%">Richtige Antwort</th>
                    <th style="width: 10%">Punkte</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          section.questions.forEach((question) => {
            const userAnswer = userAnswers[question.id] || '-';
            const correctAnswer = section.correctAnswers[question.id];
            const gotCorrect = userAnswer === correctAnswer;
            const points = gotCorrect ? "1" : "0";
            
            if (gotCorrect) correctCount++;
            
            const rowClass = gotCorrect ? 'correct-answer' : 'incorrect-answer';
            
            resultsHTML += `
              <tr class="${rowClass}">
                <td><strong>${question.id}</strong></td>
                <td class="question-text">${question.text}</td>
                <td>${userAnswer}</td>
                <td>${correctAnswer}</td>
                <td><strong>${points}</strong></td>
              </tr>
            `;
          });
          
          const totalPoints = Math.round((correctCount / section.questions.length) * section.points);
          
          resultsHTML += `
                </tbody>
              </table>
              <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                <strong>Erreichte Punkte: ${correctCount}/${section.questions.length} richtig = ${totalPoints}/${section.points} Punkten</strong>
              </div>
            </div>
          `;
        });
        
        contentContainer.innerHTML = resultsHTML;
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-hoeren').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-hoeren').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        showPage('schreiben-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._hoerenState = state;
        window.hoerenApp = {
        updateListeningAnswer
      };
    }

    // ===== SCHREIBEN PAGE FUNCTIONALITY =====
    function initSchreibenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-002",
        durationSec: 30 * 60, // 30 minutes in seconds
        sections: [
          { 
            id: "s1", 
            title: "Schreiben, Teil 1", 
            points: 45,
            passageTitle: "Aufgabe: Schreiben Sie eine E-Mail",
            passage: "",
            writingTask: {
              prompt: `Schmelzkäse - Alpengeschmack

Die Reinheit der Natur auf Ihrem Teller! 
Schmelzkäse ist eine besondere Spezialität unter den Käsen und wird aus gereiftem Schnittkäse 
oder Frischkäse auf Grundlage einer traditionellen Methode weiterverarbeitet und gleichzeitig 
haltbar gemacht. 

Schmelzkäse - Alpengeschmack ist in der modernen Küche besonders beliebt, da er vielseitig 
einsetzbar ist: Er bindet Soßen und Suppen, verleiht den Gerichten eine feinwürzige Note, ist perfekt 
zum Überbacken geeignet und darf auf keinem Frühstücks- oder Abendbrottisch fehlen. 

Zutaten: 
50 % Käse, Süßmolke, Butter, Schmelzsalze, Natriumphosphate, Natriumcitrate, Polyphosphate, 
Magermilch aus Kuhmilch, Milcheiweiß, Speisesalz, 
Farbstoffe: Paprikaextrakt, Carotin. 

10 Scheiben, einzeln in Folie verpackt. 
Ungeöffnet mindestens 24 Tage haltbar. Nach dem Öffnen gekühlt lagern. 

Artikelnummer: 9977 8855 
Hersteller: Molkerei Alpengeschmack 
Lindauer Straße 5 
87437 Kempten 
Tel. 0831-181921 
www.molkerei-alpengeschmack.de`,
              requirements: [
                "Erläutern Sie, wozu Sie diesen Käse verwenden.",
                "Beschreiben Sie, welche gesundheitlichen Beschwerden Sie nach dem Essen hatten.",
                "Erklären Sie, warum die Fremdkörper gesundheitsgefährdend sind.",
                "Beschreiben Sie, wen Sie außer dem Hersteller noch informiert haben."
              ],
              wordCount: 0
            }
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-schreiben');
      const passageTitleEl = document.getElementById('passageTitle-schreiben');
      const passageContentEl = document.getElementById('passageContent-schreiben');
      const writingContainer = document.getElementById('writingContainer-schreiben');
      const timerEl = document.getElementById('timer-schreiben');
      const statusText = document.getElementById('statusText-schreiben');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        return state.answers[section.id] && state.answers[section.id].length > 0;
      }

      function renderAll() {
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        passageTitleEl.textContent = section.passageTitle;
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderWritingSection();
      }

      function renderWritingSection() {
        const section = exam.sections[state.sectionIndex];
        
        // Render the prompt in left panel
        passageContentEl.innerHTML = `
          <div class="writing-task">
            <div class="writing-prompt">${section.writingTask.prompt}</div>
            <div class="instructions" style="border:1px solid #e1e8f6; padding:10px; margin:10px 0; border-radius:6px; background:#ffffff;">Sie haben dieses Produkt gekauft, es war aber verunreinigt. 
Der Käse enthielt Fremdkörper, und Sie sind nach dem Essen erkrankt. 
Schreiben Sie einen Beschwerdebrief an den Hersteller.</div>
            <div class="writing-requirements">
              <h4>Schreiben Sie in Ihrer E-Mail:</h4>
              <ul>
                ${section.writingTask.requirements.map(req => `<li>${req}</li>`).join('')}
              </ul>
            </div>
            <div class="instructions">
              Schreiben Sie eine E-Mail (ca. 150-200 Wörter). Achten Sie auf den Textaufbau (Anrede, Einleitung, Hauptteil, Schluss) und eine angemessene Formulierung.
            </div>
          </div>
        `;
        
        // Render writing area in right panel
        const currentAnswer = state.answers[section.id] || '';
        const wordCount = countWords(currentAnswer);
        
        writingContainer.innerHTML = `
          <div class="writing-area">
            <textarea 
              class="writing-textarea" 
              placeholder="Schreiben Sie hier Ihre E-Mail..."
              oninput="window.schreibenApp.updateWritingAnswer('${section.id}', this.value)"
            >${currentAnswer}</textarea>
            <div class="word-counter">
              Wörter: <span class="count">${wordCount}</span>
            </div>
          </div>
        `;
      }

      function countWords(text) {
        return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      }

      function updateWritingAnswer(sectionId, text) {
        state.answers[sectionId] = text;
        try{ localStorage.setItem('schreibenAnswers', JSON.stringify({content: state.answers[sectionId], wordCount: (state.answers[sectionId]||'').trim().split(/\s+/).filter(Boolean).length})); }catch(e){}
        
        const wordCount = countWords(text);
        document.querySelector('.word-counter .count').textContent = wordCount;
      }

      function renderResults() {
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="writing-task"><h3>${section.title}</h3>`;
          
          const userAnswer = state.answers[section.id];
          const wordCount = countWords(userAnswer);
          
          resultsHTML += `
            <div class="writing-requirements">
              <h4>Ihre Antwort (${wordCount} Wörter):</h4>
              <div style="white-space: pre-wrap; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e1e8f6; margin-top: 10px;">${userAnswer || 'Keine Antwort'}</div>
            </div>
          `;
          
          resultsHTML += `</div>`;
        });
        
        passageContentEl.innerHTML = resultsHTML;
        writingContainer.innerHTML = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-schreiben').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöschت.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-schreiben').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        showPage('ergebnisse-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._schreibenState = state;
        window.schreibenApp = {
        updateWritingAnswer
      };
    }

    // ===== ERGEBNISSE PAGE FUNCTIONALITY =====
    function initErgebnissePage() {
      const CONFIG = {
        totals: { 
          lesen: 105, 
          hoeren: 75, 
          schreiben: 45, 
          gesamt: 225 
        },
        counts: { 
          lesen: 40, 
          hoeren: 20 
        },
        hoerenCorrect: {
          "41": "richtig", "42": "falsch", "43": "falsch", "44": "richtig", "45": "falsch",
          "46": "richtig", "47": "falsch", "48": "richtig", "49": "richtig", "50": "falsch",
          "51": "falsch", "52": "falsch", "53": "richtig", "54": "falsch", "55": "falsch",
          "56": "richtig", "57": "falsch", "58": "falsch", "59": "richtig", "60": "falsch"
        },
        lesenCorrect: Object.assign({},
          {"text1": "i", "text2": "b", "text3": "g", "text4": "d", "text5": "e"},
          {"s2q1": "s2q1o1", "s2q2": "s2q2o3", "s2q3": "s2q3o2", "s2q4": "s2q4o2", "s2q5": "s2q5o1"},
          {"11": "A", "12": "C", "13": "D", "14": "E", "15": "F", "16": "H", "17": "I", "18": "J", "19": "K", "20": "L"},
          {"21": "davon", "22": "denen", "23": "an", "24": "Mittwochs", "25": "jedem Kurs", "26": "deren", "27": "wenn", "28": "Ihnen", "29": "ist", "30": "eine Diät halten müssen"},
          {"31": "KAUM", "32": "DANN", "33": "AN", "34": "AUF", "35": "VORBEI", "36": "SOLLEN", "37": "NICHT NUR", "38": "DENEN", "39": "DASS", "40": "KEINE"}
        )
      };

      function normalizeAnswer(a) {
        if (a === null || a === undefined) return '';
        let s = String(a).trim();
        if (s === '') return '';
        const low = s.toLowerCase();
        if (["richtig", "true", "yes", "ja"].includes(low)) return 'richtig';
        if (["falsch", "false", "no", "nein"].includes(low)) return 'falsch';
        return s;
      }

      function keyZeroToTen(k) {
        return k === '0' ? '10' : k;
      }

      function readExamResults() {
        try {
          const lesen = {};
          const hoeren = {};
          const schreiben = { content: '', wordCount: 0 };

          // 1) Try to read from in-memory states exposed by pages
          try {
            if (window._lesenState && window._lesenState.answers) {
              Object.keys(window._lesenState.answers).forEach(k => {
                lesen[k] = window._lesenState.answers[k];
              });
            }
          } catch (e) {}

          try {
            if (window._hoerenState && window._hoerenState.answers) {
              Object.keys(window._hoerenState.answers).forEach(sectionId => {
                const sec = window._hoerenState.answers[sectionId] || {};
                Object.keys(sec).forEach(q => {
                  hoeren[q] = sec[q];
                });
              });
            }
          } catch (e) {}

          try {
            if (window._schreibenState && window._schreibenState.answers) {
              const answers = window._schreibenState.answers;
              if (answers['s1']) {
                schreiben.content = answers['s1'];
              } else {
                const keys = Object.keys(answers);
                if (keys.length > 0) schreiben.content = answers[keys[0]] || '';
              }
              schreiben.wordCount = (schreiben.content && schreiben.content.trim()) ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0;
            }
          } catch (e) {}

          // 2) Fallback to localStorage if any part is still empty
          try {
            if (Object.keys(lesen).length === 0) {
              const storedL = localStorage.getItem('lesenAnswers');
              if (storedL) Object.assign(lesen, JSON.parse(storedL));
            }
          } catch (e) {}

          try {
            if (Object.keys(hoeren).length === 0) {
              const storedH = localStorage.getItem('hoerenAnswers');
              if (storedH) Object.assign(hoeren, JSON.parse(storedH));
            }
          } catch (e) {}

          try {
            if (!schreiben.content) {
              const storedS = localStorage.getItem('schreibenAnswers');
              if (storedS) {
                const obj = JSON.parse(storedS);
                schreiben.content = obj.content || '';
                schreiben.wordCount = obj.wordCount || (schreiben.content.trim() ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0);
              }
            }
          } catch (e) {}

          // final safe return
          return { hoeren, lesen, schreiben };
        } catch (e) {
          return { hoeren: {}, lesen: {}, schreiben: {} };
        }
      }

      function gradeHoeren(u) {
        const c = CONFIG.hoerenCorrect;
        let okCount = 0;
        const d = [];
        
        for (let q = 41; q <= 60; q++) {
          const k = String(q);
          const uA = normalizeAnswer(u[k] || '');
          const exp = normalizeAnswer(c[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.hoeren / CONFIG.counts.hoeren;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        }
        
        const total = Number((okCount * (CONFIG.totals.hoeren / CONFIG.counts.hoeren)).toFixed(2));
        return { okCount, total, details: d };
      }

      function gradeLesen(u) {
        const c = CONFIG.lesenCorrect;
        let okCount = 0;
        const d = [];
        
        Object.keys(c).forEach(k => {
          const exp = normalizeAnswer(c[k]);
          const uA = normalizeAnswer(u[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.lesen / CONFIG.counts.lesen;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        });
        
        const total = Number((okCount * (CONFIG.totals.lesen / CONFIG.counts.lesen)).toFixed(2));
        return { okCount, total, details: d };
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function buildTable(title, dets, total, max) {
        let h = `<h2>${title}</h2>
                <table class="section-table">
                  <thead>
                    <tr>
                      <th>Frage</th>
                      <th>Ihre Antwort</th>
                      <th>Richtige Antwort</th>
                      <th>Ergebnis</th>
                      <th>Punkte</th>
                    </tr>
                  </thead>
                  <tbody>`;
        
        dets.forEach(x => {
          h += `<tr>
                  <td>${x.frage}</td>
                  <td>${escapeHtml(x.user)}</td>
                  <td>${escapeHtml(x.correct)}</td>
                  <td>${x.richtig ? '✔️' : '✖️'}</td>
                  <td>${x.punkte}</td>
                </tr>`;
        });
        
        h += `</tbody>
              </table>
              <div class="small-muted">Teilpunkte: ${total.toFixed(2)} / ${max}</div>`;
        return h;
      }

      function renderResults() {
        const st = readExamResults() || { hoeren: {}, lesen: {}, schreiben: {} };
        const h = gradeHoeren(st.hoeren || {});
        const l = gradeLesen(st.lesen || {});
        const details = document.getElementById('details-ergebnisse');
        const tiles = document.getElementById('topTiles-ergebnisse');
        const sScoreRaw = localStorage.getItem('schreibenScore');
        const sScore = sScoreRaw ? Number(sScoreRaw) : 0; // Default score is now 0

        details.innerHTML = '';
        tiles.innerHTML = '';

        const tL = `<div class="results-tile">
                    <h3>Lesen</h3>
                    <div class="score">${l.total.toFixed(2)} / ${CONFIG.totals.lesen} Punkte</div>
                    <div class="small-muted">(${(l.total / CONFIG.totals.lesen * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tH = `<div class="results-tile">
                    <h3>Hören</h3>
                    <div class="score">${h.total.toFixed(2)} / ${CONFIG.totals.hoeren} Punkte</div>
                    <div class="small-muted">(${(h.total / CONFIG.totals.hoeren * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tS = `<div class="results-tile">
                    <h3>Schreiben</h3>
                    <div class="score" id="schreibenScoreDisplay">${sScore.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte</div>
                    <div class="small-muted">Manuelle Eingabe</div>
                  </div>`;
                  
        tiles.innerHTML = tL + tH + tS;

        details.innerHTML += buildTable('Hören — Detail', h.details, h.total, CONFIG.totals.hoeren);
        details.innerHTML += buildTable('Lesen — Detail', l.details, l.total, CONFIG.totals.lesen);

        let sHtml = '<h2>Schreiben — Ergebnis (manuell)</h2>';
        const txt = st.schreiben.content ? escapeHtml(st.schreiben.content) : '<span class="small-muted">Kein Text gefunden.</span>';
        const wc = st.schreiben.wordCount || '-';
        
        sHtml += `<div class="small-muted">Wörter: ${wc}</div>
                <div style="margin-top:10px;padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ff;min-height:80px">${txt}</div>
                <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                  Punkte (0–45): 
                  <input id="sInput" type="number" min="0" max="45" step="0.5" value="${sScore}"> 
                  <button id="saveS" class="results-btn">Speichern</button>
                </div>`;
                
        details.innerHTML += sHtml;

        const total = (l.total + h.total + sScore).toFixed(2);
        const percent = ((total / CONFIG.totals.gesamt) * 100).toFixed(2);
        
        document.getElementById('finalSummary-ergebnisse').innerHTML = `
          <div class="left">
            Gesamtpunktzahl: <strong>${total}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
            <span class="small-muted">Lesen + Hören + Schreiben</span>
          </div>
          <div class="right">
            Prozentsatz: <strong>${percent} %</strong>
          </div>`;

        document.getElementById('saveS').onclick = () => {
          const v = Number(document.getElementById('sInput').value) || 0;
          localStorage.setItem('schreibenScore', v);
          document.getElementById('schreibenScoreDisplay').textContent = `${v.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte`;
          
          const newTotal = (l.total + h.total + v).toFixed(2);
          const newPercent = ((newTotal / CONFIG.totals.gesamt) * 100).toFixed(2);
          
          document.getElementById('finalSummary-ergebnisse').innerHTML = `
            <div class="left">
              Gesamtpunktzahl: <strong>${newTotal}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
              <span class="small-muted">Lesen + Hören + Schreiben</span>
            </div>
            <div class="right">
              Prozentsatz: <strong>${newPercent} %</strong>
            </div>`;
        };
      }

      document.getElementById('calcBtn-ergebnisse').onclick = () => renderResults();
      document.getElementById('backBtn-ergebnisse').onclick = (e) => {
        e.preventDefault();
        showPage('start-page');
      };
      
      // Initialize results on page load
      renderResults();
    }
  </script>
</body>
</html>