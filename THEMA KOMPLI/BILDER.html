<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deutsch B2 Prüfung - Komplett</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    :root {
      --primary-color: #1e3a5f;
      --secondary-color: #2c5282;
      --accent-color: #4da6ff;
      --light-color: #ebf8ff;
      --text-color: #2d3748;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--white);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    button {
      cursor: pointer;
    }
    
    /* ===== START PAGE STYLES ===== */
    .start-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      min-height: 100vh;
    }
    
    .start-content {
      max-width: 600px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo {
      margin-bottom: 20px;
    }
    
    .logo-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 18px;
      margin-bottom: 30px;
      opacity: 0.9;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      color: var(--text-color);
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .card p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-color);
      outline: none;
      background-color: var(--white);
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }
    
    .timer-container {
      margin: 25px 0;
    }
    
    .timer-label {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-color);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar {
      height: 8px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress {
      height: 100%;
      width: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transform: scaleX(1);
      transform-origin: left;
      transition: transform 1s linear;
    }
    
    .info-text {
      font-size: 14px;
      margin-top: 20px;
      opacity: 0.8;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn:hover {
      background-color: #3399ff;
    }
    
    /* ===== EXAM PAGE STYLES ===== */
    .exam-body {
      background: #f5f5f5;
      color: #333;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Header Styles */
    header.topbar {
      background: #1e3a5f;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-height: 80px;
    }

    .brand {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .brand .logo {
      width: 80px;
      height: 40px;
      background: #e74c3c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }

    .meta .main-title {
      font-weight: 800;
      font-size: 18px;
    }

    .meta .sub-title {
      font-size: 13px;
      opacity: 0.9;
    }

    .timer {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      margin: 0 20px;
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 10px 20px;
    }

    .exam-btn {
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      background: #4da6ff;
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
      min-width: 150px;
      text-align: center;
    }

    .exam-btn:hover {
      background: #336fbf;
    }
    
    .exam-btn.save {
      background: #4da6ff;
      color: #000;
    }
    
    .exam-btn.save:hover {
      background: #3399ff;
    }
    
    .exam-btn.submit {
      background: #4da6ff;
    }
    
    .exam-btn.submit:hover {
      background: #3399ff;
    }
    
    .exam-btn.result {
      background: #4da6ff;
    }
    
    .exam-btn.result:hover {
      background: #3399ff;
    }
    
    .exam-btn.next {
      background: #4da6ff;
      color: #fff;
    }
    
    .exam-btn.next:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset {
      background: #4da6ff;
    }
    
    .exam-btn.reset:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset-section {
      background: #d35400;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
    }
    
    .exam-btn.reset-section:hover {
      background: #e67e22;
    }
    
    .exam-btn.no-match {
      background: #95a5a6;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
      margin-top: 5px;
    }
    
    .exam-btn.no-match:hover {
      background: #7f8c8d;
    }
    
    .exam-btn.no-match.selected {
      background: #e74c3c;
    }
    
    /* Top Tiles */
    .top-tiles {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1e3a5f;
      border-bottom: 1px solid #0f223a;
    }
    
    .tile {
      flex: 1;
      max-width: 180px;
      text-align: center;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #3b4a63;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    
    .tile:hover {
      background: #4a5b78;
    }
    
    .tile.active {
      background: #ffffff;
      color: #000;
      border-color: #bbb;
    }
    
    .tile.done {
      background: #2ecc71;
      color: #fff;
      border-color: #27ae60;
    }
    
    .tile.done::after {
      content: " ✅";
      margin-left: 5px;
    }
    
    .tile .points {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .tile.active .points {
      background: #e9eefc;
      color: #2c3e50;
    }
    
    /* Container Styles */
    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-full {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .left-panel {
      background: white;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .left-panel .passage {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.8;
    }
    
    .left-panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .right-panel {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 76vh;
      overflow: auto;
    }
    
    .main-panel {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1e3a5f;
      font-weight: 700;
    }
    
    /* Question Styles */
    .question-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .question-body {
      margin-top: 8px;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .option {
      background: #fbfdff;
      border: 1px solid #e1e8f6;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .option:hover {
      background: #f0f6ff;
    }
    
    .option.selected {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .option .radio {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #cfdff6;
      background: #fff;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .option.selected .radio {
      background: #3498db;
      border-color: #3498db;
      box-shadow: inset 0 -3px 0 rgba(0,0,0,0.05);
    }
    
    .text-container {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
      position: relative;
      min-height: 120px;
    }
    
    .text-container:hover {
      background: #f0f6ff;
    }
    
    .text-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    
    .text-content {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .title-slot {
      min-height: 40px;
      margin-top: 10px;
      padding: 8px;
      border: 2px dashed #c8d9f6;
      border-radius: 6px;
      background: #f8fbff;
    }
    
    .title-slot.has-title {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .title-slot.has-x {
      background: #f8d7da;
      border-color: #e74c3c;
      color: #c0392b;
      font-weight: bold;
    }
    
    .headings-bank {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 0;
    }
    
    .heading-item {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 8px;
      background: #f8fbff;
      cursor: grab;
    }
    
    .heading-item:hover {
      background: #e9f0ff;
    }
    
    .heading-item.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .result-correct {
      color: #27ae60;
      font-weight: bold;
    }
    
    .result-incorrect {
      color: #c0392b;
      font-weight: bold;
    }
    
    .result-item {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .instructions {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 15px;
      color: #2c3e50;
    }
    
    .all-questions {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .question-block {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .texts-list, .situations-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .text-item, .situation-item {
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .text-letter {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .situation-number {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .fill-blank-container {
      margin: 20px 0;
    }
    
    .blank-word {
      display: inline-block;
      min-width: 120px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      cursor: pointer;
      position: relative;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
    }
    
    .blank-word.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .options-popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 150px;
    }
    
    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f4fb;
    }
    
    .option-item:hover {
      background: #f0f6ff;
    }
    
    .option-item:last-child {
      border-bottom: none;
    }
    
    .horizontal-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .option-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .option-number {
      font-weight: bold;
      color: #2c3e50;
      min-width: 30px;
    }
    
    .option-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .option-btn {
      padding: 8px 16px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option-btn:hover {
      background: #e9f0ff;
    }
    
    .option-btn.selected {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    .word-bank-vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .bank-word-vertical {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      text-align: center;
      cursor: grab;
    }
    
    .bank-word-vertical.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .blank-slot {
      display: inline-block;
      min-width: 100px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      min-height: 30px;
      vertical-align: middle;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .blank-slot.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .footer-buttons {
      display: flex;
      gap: 10px;
    }
    
    .situation-item.used {
      opacity: 0.7;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #333;
    }
    
    /* Listening Section Styles */
    .listening-task {
      margin-bottom: 10px;
    }
    
    .true-false-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .true-false-table th {
      background: #3498db;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    
    .true-false-table td {
      padding: 15px;
      border-bottom: 1px solid #e1e8f6;
      vertical-align: top;
    }
    
    .true-false-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .true-false-table tr:hover {
      background: #e3f2fd;
    }
    
    .answer-options {
      display: flex;
      gap: 25px;
    }
    
    .answer-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 4px;
      transition: background 0.2s;
      font-weight: 500;
    }
    
    .answer-option:hover {
      background: #e3f2fd;
    }
    
    .answer-option input {
      margin: 0;
      transform: scale(1.2);
    }

    .correct-answer {
      background: #d4edda !important;
      border-left: 4px solid #28a745;
    }
    
    .incorrect-answer {
      background: #f8d7da !important;
      border-left: 4px solid #dc3545;
    }
    
    /* Writing Section Styles */
    .writing-task {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .writing-prompt {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .writing-requirements {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      margin-bottom: 15px;
    }
    
    .writing-requirements h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }
    
    .writing-requirements ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .writing-requirements li {
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    .writing-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .writing-textarea {
      flex: 1;
      min-height: 500px;
      padding: 15px;
      border: 2px solid #e1e8f6;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    
    .writing-textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .word-counter {
      margin-top: 10px;
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
      padding: 8px 0;
    }
    
    .word-counter .count {
      font-weight: bold;
      color: #2c3e50;
    }
    
    /* Results Page Styles */
    .results-body {
      background: #f7fafc;
      color: #0f1724;
      line-height: 1.6;
    }
    
    .results-header {
      background: #1e3a5f;
      color: #fff;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .results-logo {
      background: #fff;
      color: #1e3a5f;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 800;
    }
    
    .results-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .results-container {
      max-width: 1100px;
      margin: 22px auto;
      padding: 20px;
    }
    
    .results-tiles {
      display: flex;
      gap: 12px;
      margin: 18px 0;
    }
    
    .results-tile {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      border-left: 6px solid #1e3a5f;
    }
    
    .results-tile h3 {
      margin: 0;
      font-size: 16px;
      color: #1e3a5f;
    }
    
    .results-tile .score {
      font-size: 20px;
      font-weight: 800;
      margin-top: 8px;
    }
    
    .section-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .section-table th,
    .section-table td {
      padding: 8px;
      border-bottom: 1px solid #e6eef8;
      text-align: left;
      font-size: 14px;
    }
    
    .summary {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .summary .left {
      font-weight: 700;
    }
    
    .summary .right {
      text-align: right;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    
    .results-btn {
      background: #4da6ff;
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .results-btn:hover {
      background: #3a8ce0;
    }
    
    .button-like {
      text-decoration: none;
    }
    
    .small-muted {
      color: #6b7280;
      font-size: 13px;
    }
    
    input[type="number"] {
      width: 90px;
      padding: 8px;
      border: 1px solid #d7e6fb;
      border-radius: 6px;
    }
    
    .note {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    /* Footer */
    footer.controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e1e8f6;
      margin-top: 20px;
    }
    
    .status {
      font-size: 14px;
      color: #7f8c8d;
    }
    
    .ghost {
      background: transparent;
      border: 2px solid #2c3e50;
      color: #2c3e50;
    }
    
    .ghost:hover {
      background: #2c3e50;
      color: white;
    }

    /* Responsive Styles */
    @media (max-width: 980px) {
      .container {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .container-split {
        grid-template-columns: 1fr;
      }
      
      .right-panel {
        order: 2;
      }
      
      .top-tiles {
        padding-left: 8px;
        padding-right: 8px;
      }
      
      header.topbar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .answer-options {
        flex-direction: column;
        gap: 10px;
      }
      
      footer.controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .results-tiles {
        flex-direction: column;
      }
      
      .summary {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 600px) {
      .start-content {
        padding: 25px 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .card {
        padding: 20px 15px;
      }
    }
  </style>
</head>
<body id="body">
  <!-- Start Page -->
  <div id="start-page" class="start-container">
    <div class="start-content">
      <div class="logo">
        <div class="logo-icon">📝</div>
        <h1>Deutsch B2 Prüfung</h1>
        <div class="subtitle">Bereiten Sie sich auf Ihre Prüfung vor</div>
      </div>
      <div class="card">
        <h2>Prüfungsbereich auswählen</h2>
        <p>Wählen Sie bitte den Bereich aus, den Sie üben möchten. Die Prüfung startet automatisch in <span id="time-display">30</span> Sekunden.</p>
        <select id="sectionSelect">
          <option value="lesen">Lesen</option>
          <option value="hoeren">Hören</option>
          <option value="schreiben">Schreiben</option>
        </select>
        <div class="button-container">
          <button id="cancelBtn" class="btn">Abbrechen</button>
          <button id="startBtn" class="btn">Jetzt starten</button>
        </div>
      </div>
      <div class="timer-container">
        <div class="timer-label">Die Prüfung startet in:</div>
        <div class="timer" id="countdown">30</div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
      </div>
      <div class="info-text">Stellen Sie sicher, dass Sie in einer ruhigen Umgebung sind und genügend Zeit haben.</div>
    </div>
  </div>

  <!-- Lesen Page -->
  <div id="lesen-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Lesen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-lesen" class="timer" aria-live="polite">Verbleibende Zeit: 90:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-lesen" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-lesen" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-lesen" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-lesen" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-lesen">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-lesen" role="navigation" aria-label="Sections overview"></div>

    <div class="container">
      <main class="left-panel" id="leftPanel-lesen">
        <div class="passage" id="passage-lesen">
          <h2 id="passageTitle-lesen">Aufgabe</h2>
          <div id="passageContent-lesen"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-lesen" aria-labelledby="questionTitle-lesen">
        <div class="question-head">
          <div>
            <div id="sectionName-lesen" style="font-weight:800"></div>
            <div id="questionTitle-lesen" style="font-size:13px;color:#55607a">Frage</div>
          </div>
          <button id="resetSectionBtn-lesen" class="exam-btn reset-section" style="display:none;">Teil zurücksetzen</button>
        </div>
        <div class="question-body" id="questionBody-lesen"></div>
        <div id="headingsBankContainer-lesen"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-lesen" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-lesen" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-lesen">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Hören Page -->
  <div id="hoeren-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Hörverstehen — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-hoeren" class="timer" aria-live="polite">Verbleibende Zeit: 17:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-hoeren" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-hoeren" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-hoeren" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-hoeren" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-hoeren">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-hoeren" role="navigation" aria-label="Sections overview"></div>

    <div class="container-full">
      <main class="main-panel" id="mainPanel-hoeren">
        <div id="contentContainer-hoeren"></div>
      </main>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-hoeren" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-hoeren" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-hoeren">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Schreiben Page -->
  <div id="schreiben-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (Übung)</div>
          <div class="sub-title">Schreiben — Testbeispiel</div>
        </div>
      </div>

      <div id="timer-schreiben" class="timer" aria-live="polite">Verbleibende Zeit: 30:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-schreiben" class="exam-btn reset">🔄 Von neu beginnen</button>
        <button id="saveBtn-schreiben" class="exam-btn save">📋 Speichern</button>
        <button id="resultBtn-schreiben" class="exam-btn result">📊 Ergebnis</button>
        <button id="submitBtn-schreiben" class="exam-btn submit">🏁 Abgabe</button>
        <button class="exam-btn next" id="nextBtn-schreiben">➡️ Nächste Prüfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-schreiben" role="navigation" aria-label="Sections overview"></div>

    <div class="container-split">
      <main class="left-panel" id="leftPanel-schreiben">
        <div class="passage" id="passage-schreiben">
          <h2 id="passageTitle-schreiben">Aufgabe</h2>
          <div id="passageContent-schreiben"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-schreiben">
        <div id="writingContainer-schreiben"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-schreiben" class="exam-btn ghost">Zurück</button>
        <button id="nextBtn-schreiben" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-schreiben">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Ergebnisse Page -->
  <div id="ergebnisse-page" class="results-page" style="display: none;">
    <header class="results-header">
      <div class="results-logo">telc</div>
      <div class="results-title">Gesamtergebnis — Deutsch B2</div>
    </header>

    <div class="results-container">
      <div class="results-tiles" id="topTiles-ergebnisse"></div>
      <div id="details-ergebnisse"></div>
      <div class="summary" id="finalSummary-ergebnisse"></div>
      <div class="controls">
        <a class="button-like" href="#" id="backBtn-ergebnisse">
          <button class="results-btn">🔁 Zurück zur Startseite</button>
        </a>
        <button id="calcBtn-ergebnisse" class="results-btn">✅ Ergebnisse anzeigen</button>
      </div>
      <div class="note">Hinweis: Schreiben (45 Punkte) wird manuell eingegeben, falls nicht automatisch vorhanden.</div>
    </div>
  </div>

  <script>
    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      // Hide all pages
      document.getElementById('start-page').style.display = 'none';
      document.getElementById('lesen-page').style.display = 'none';
      document.getElementById('hoeren-page').style.display = 'none';
      document.getElementById('schreiben-page').style.display = 'none';
      document.getElementById('ergebnisse-page').style.display = 'none';
      
      // Change body class based on page
      document.getElementById('body').className = '';
      if (pageId === 'ergebnisse-page') {
        document.getElementById('body').className = 'results-body';
      } else if (pageId !== 'start-page') {
        document.getElementById('body').className = 'exam-body';
      }
      
      // Show selected page
      document.getElementById(pageId).style.display = 'block';
      
      // Initialize the page if needed
      if (pageId === 'lesen-page' && typeof initLesenPage === 'function') {
        initLesenPage();
      } else if (pageId === 'hoeren-page' && typeof initHoerenPage === 'function') {
        initHoerenPage();
      } else if (pageId === 'schreiben-page' && typeof initSchreibenPage === 'function') {
        initSchreibenPage();
      } else if (pageId === 'ergebnisse-page' && typeof initErgebnissePage === 'function') {
        initErgebnissePage();
      }
    }

    // ===== START PAGE FUNCTIONALITY =====
    let initialCounter = 30;
    let counter = initialCounter;
    let countdownInterval;
    let countdownRunning = false;
    let examStarted = false;
    const timerEl = document.getElementById("countdown");
    const timeDisplayEl = document.getElementById("time-display");
    const progressEl = document.getElementById("progress");
    const selectEl = document.getElementById("sectionSelect");
    const startBtn = document.getElementById("startBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function startCountdown() {
      // prevent double-starts or starting after exam already began
      if (countdownRunning || examStarted) return;
      countdownRunning = true;
      // disable start button while counting
      try { startBtn.disabled = true; startBtn.setAttribute('aria-disabled','true'); } catch(e){}
      // reset counter & UI
      counter = initialCounter;
      timerEl.textContent = counter;
      timeDisplayEl.textContent = counter;
      progressEl.style.transform = "scaleX(0)";
      timerEl.style.color = "";

      countdownInterval = setInterval(() => {
        counter--;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
        const progressValue = (initialCounter - counter) / initialCounter;
        progressEl.style.transform = `scaleX(${progressValue})`;
        if (counter <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRunning = false;
          progressEl.style.transform = "scaleX(1)";
          // ensure exam starts only once
          if (!examStarted) {
            examStarted = true;
            startExam();
          }
          // safety: re-enable start button (page usually navigates away)
          try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
        }
      }, 1000);
    }

    function stopCountdown(reset = true) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownRunning = false;
      try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
      progressEl.style.transform = "scaleX(0)";
      if (reset) {
        counter = initialCounter;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
      } else {
        timerEl.textContent = "Gestoppt";
      }
    }

    function startExam() {
      // guard to ensure startExam is triggered once
      if (!examStarted) examStarted = true;
      const selectedSection = selectEl.value;
      if (selectedSection === 'lesen') {
        showPage('lesen-page');
      } else if (selectedSection === 'hoeren') {
        showPage('hoeren-page');
      } else if (selectedSection === 'schreiben') {
        showPage('schreiben-page');
      }
    }

    // wire buttons: start will now start the countdown (not the exam directly)
    startBtn.addEventListener('click', startCountdown);

    cancelBtn.addEventListener('click', () => {
      stopCountdown(true);
      timerEl.textContent = "Abgebrochen";
      timerEl.style.color = "#e53e3e";
    });

    // ===== LESEN PAGE FUNCTIONALITY =====
    function initLesenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-001",
        durationSec: 90 * 60,
        sections: [
          { 
            id: "s1", 
            title: "Leseverstehen, Teil 1", 
            points: 25,
            passageTitle: "Aufgabe: Ziehen Sie die passenden Überschriften auf die Texte.",
            passage: "",
            questions: [],
            texts: [
              {
                id: "text1",
                content: "Fotos machen ist heute nicht schwer. Schnell nimmt man das Handy und macht einen Schnappschuss. Wer aber besondere und eindrucksvolle Bilder haben möchte, muss sich mit dem Thema Fotografie schon etwas intensiver befassen. Dietmar Spehrs neuer Fotografie-Ratgeber ist dabei ein gutes Hilfsmittel. Auf 424 Seiten erklärt der Autor und Journalist mit einfachen, aber kompetenten Worten, was zu beachten ist. Der Ratgeber versteht sich als Fotokurs für Ein- und Aufsteiger und richtet sich an die vielen Menschen, die gerne fotografieren, aber wenig Fachwissen haben. Diesen Hobbyfotografen vermittelt das Buch sehr verständlich Schritt für Schritt solides Basiswissen. Spehr setzt dabei auf Beispielbilder, Tabellen und Grafiken und schreibt so wenig wie möglich, aber so viel wie nötig. Das sorgt dafür, dass der Ratgeber sehr unterhaltsam zu lesen ist und nicht wie ein langweiliges Lehrbuch daherkommt. Von der Auswahl des Motivs über die richtige Kameraeinstellung bis hin zur optimierenden Nachbearbeitung am Computer wird alles Wissenswerte vermittelt.",
                correctAnswer: "i"
              },
              {
                id: "text2", 
                content: "Der Buchtitel erinnert an eine Horrogeschichte: 'Die Nacht'. Aber dem Autor Paul Bogart geht es nicht um Fantasiewelten, sondern um sehr reale Dinge. Das Thema des Autors ist die nächtliche Finsternis. Wer erlebt noch eine dunkle Nacht? Großstadtbewohner eher nicht, außer im abgedunkelten Schlafzimmer. Ein natürlicher Nachthimmel mit unzähligen Sternen ist die Ausnahme, deshalb sind wir überwältigt, wenn wir ihn doch einmal zu sehen bekommen. Das war früher anders, und zwar bis Gaslicht und Glühlampe erfunden wurden. Heute sieht man in Städten gerade noch den Mond und, wenn man Glück hat, eine Handvoll der hellsten Sterne. Paul Bogart erläutert, warum künstliches Licht so weit verbreitet ist, und betrachtet dies sehr kritisch. Der Autor fesselt seine Leser dabei mit beachtlichem Fachwissen. Außerdem ist er weit gereist. Überall, so berichtet er, gebe es Organisationen, die sich für eine Reduzierung des künstlichen Lichts einsetzen - auch in Deutschland. Paul Bogart fände es positiv, wenn die Organisationen sich durchsetzen könnten. Denn der Autor - und das macht er sehr deutlich - hält nicht viel davon, dass es heute kaum noch völlig dunkel ist!",
                correctAnswer: "b"
              },
              {
                id: "text3",
                content: "Bilder der Fotografin Annie Leibovitz sind ab kommendem Samstag im Kunsthaus Wien zu sehen. Die Ausstellung besticht durch ihre umfangreiche Bildauswahl. Zum einen kann man zahlreiche Portraits berühmter Schauspieler, Politiker oder Musiker bestaunen. Zum anderen sieht man Bilder aus dem privaten Fotoalbum der Künstlerin. Die zum Teil sehr persönlichen Aufnahmen dokumentieren ihr Leben und zeigen bisher unveröffentlichte Werke, die zum Teil sehr bedrückend sind. Bilder ihres Vaters berühren den Besucher und oftmals ist man von der Offenheit der Fotografin überrascht. Zwischen Aufnahmen der Fotografin selbst stehen zahlreiche Porträts ihrer Eltern und Urlaubsfotos der Familie. Die bunte Mischung von großformatigen und kleinformatigen Bildern sorgt für Abwechslung. Um die Fotografien besser kennenzulernen, können Besucher einen ca. 1,5 Stunden langen Film über die Karriere von Annie Leibovitz sehen. Eines ist nach der Ausstellung und dem Film klar: Anne Leibovitz zählt zu den bedeutendsten Fotografinnen des 20. und beginnenden 21. Jahrhunderts.",
                correctAnswer: "a"
              },
              {
                id: "text4",
                content: "Die Abkürzung TWAN klingt nach einem neuen Computerprogramm, aber tatsächlich steht sie für eine neue fotografische Methode, die der Iraner Babak Amin Tafreshi entwickelt hat. Diese neue Methode führt zu atemberaubenden Ergebnissen: Noch nie hat man die Sterne so eindrucksvoll über den Landschaften der Erde gesehen wie auf den Bildern in diesem Buch - ein Genuss für die Augen. Was man auf den 160 Seiten des Buches sieht, ist meines Wissens ohne Beispiel. Viele der gezeigten Orte und Landschaften sind bekannte Motive, hier aber wirken sie doch vollkommen anders, als man sie kennt. Da sieht man Sterne über den Ruinen von Persepolis, den Mond über ungarischen Wäldern, die Milchstraße über dem kalifornischen Mammutbaum 'General Grant'. Die drei Herausgeber Stefan Seip, Gernot Meiser und Babak A. Tafreshi wurden unterstützt von einem weltweiten Team erfahrener Naturfotografen. Auf den letzten Seiten des Buchs erfährt man auch, dass 'Fotografieren im TWAN-Stil heißt, bei fortgeschrittener Dämmerung oder Dunkelheit Aufnahmen zu machen, auch wenn man selbst nicht mehr viel sehen kann'. Neben aller Technik kommt es aber auf den künstlerischen Blick des Fotografen an - und viel Geduld.",
                correctAnswer: "g"
              },
              {
                id: "text5",
                content: "Er gehörte zu den ganz Großen seines Fachs: Andreas Feininger. Eine neue Biografie erzählt die Lebensgeschichte des weltberühmten Fotografen. Neben einem Text auf Deutsch und Englisch enthält sie auch eine kleine, aber gute Auswahl seiner Fotoarbeiten aus allen Schaffensphasen. Die Autoren zeigen den Weg des 1906 in Paris geborenen Fotografen von der Kindheit in Berlin über die Jahre in Weimar und Dessau bis hin zum Leben in Hamburg, Stockholm und schließlich New York, dessen Stadtansichten Feininger weltberühmt machen. Dabei hatte Feininger keineswegs das Ziel, Fotograf zu sein. Eigentlich war Andreas Feininger gelernter Architekt. Als Feininger mit seiner Frau 1933 nach Stockholm auswandert, findet er dort als Architekt keine Anstellung. So macht er aus der Not eine Tugend: Weil er die kleine Familie mit Sohn Thomas ernähren muss, macht er seine Leidenschaft, die Fotografie, zum Broterwerb. Den Durchbruch als weltweit anerkannter Fotograf schafft er schließlich in New York, wohin seine Familie 1939 auswandert.",
                correctAnswer: "c"
              }
            ],
            headings: [
              {id: "a", text: "Bilder einer bedeutenden Künstlerin"},
              {id: "b", text: "Das Ende der Dunkelheit"},
              {id: "c", text: "Die bemerkenswerte Karriere eines Fotografen"},
              {id: "d", text: "Ein Fotograf auf Reisen"},
              {id: "e", text: "Eine Fotografin dreht einen Film"},
              {id: "f", text: "Entwicklungsgeschichte der Lampen"},
              {id: "g", text: "Erde, Mond und Sterne - wie man sie noch nie gesehen hat"},
              {id: "h", text: "Familienfotos berühmter Persönlichkeiten"},
              {id: "i", text: "Gelungene Einführung in die moderne Fotografie"},
              {id: "j", text: "Mit Profis eine neue Foto-Technik erlernen"}
            ]
          },
          { 
            id: "s2", 
            title: "Leseverstehen, Teil 2", 
            points: 25,
            passageTitle: "Gesundes Essen für Schulkinder",
            passage: `Für Kinder sind regelmäßige Mahlzeiten wichtig, um volle Konzentrations– und Leistungsfähigkeit zu gewährleisten. Um gut in den Tag zu kommen, sollte jedes Schulkind mit einem ausgewogenen Frühstück starten.
Aber eine Umfrage kam zu erschreckenden Ergebnissen: Jedes siebte Kind isst morgens nichts, bevor es in die Schule geht. Die Gründe dafür sind vielfältig: Jeder vierte Befragte gab an, dass sein Kind morgens keinen Appetit habe. Und sogar jede dritte Mutter und jeder dritte Vater sagten, dass morgens keine Zeit für Frühstück sei. Für eine gesunde Morgenmahlzeit sollte man jedoch immer Zeit freischaufeln, rät Ernährungswissenschaftlerin Alexandra Krotz.
Mit leerem Magen können Körper und Geist keine Leistung erbringen. Die Folge: Die Kinder sind reizbar, nervös und können sich nicht richtig konzentrieren. Und das ist schon auf dem Schulweg wichtig: Kinder bewegen sich sicherer, wenn sie rechtzeitig aufgestanden sind und entspannt gefrühstückt haben.
Zu einem gesunden Frühstück eignen sich am besten Vollkornbrote mit fettarmer Wurst oder Käse, aber auch Müslis mit Milch oder Joghurt, Nüssen und frisches Obst. Wer morgens keinen Hunger hat, sollte wenigstens eine Kleinigkeit zu sich nehmen – etwa eine Banane essen und dazu einen Kakao trinken – und das ausgiebige Frühstück dann etwas später nachholen. In einigen Schulen wird gemeinsam gefrühstückt. Hier gilt es, je nach Vereinbarung mit Erziehern und Lehrern, ein leckeres Frühstück zusammenzustellen. Wer seinen Kinder ein zweites Frühstück einpackt, sollte auf Abwechslung und die geeignete Verpackung achten. Am besten eignet sich eine Brotdose – die spart Verpackungsmilli und vermeidet zermatschte Brote. Zudem lassen sich darin auch Obst und Gemüse sicher transportieren.
Eine gute Ergänzung zu lecker belegten Vollkornbroten ist Rohkost. Dazu eignen sich besonders transportsichere feste Sorten wie Möhren, Kohlrabi, Cherrytonaten, Trauben oder Äpfel. Je nach Jahreszeit und Vorliebe der Kinder können Sie als Eltern hierbei für Abwechslung sorgen.
Heutzutage wird Schulmilch leider nicht mehr in allen Schulen angeboten. Schade, denn Milch liefert wichtiges Calcium, Eiweiß und viele B-Vitamine. Wer als Kind die Möglichkeit hat, in der Schule Milch zu trinken, sollte darauf nicht verzichten. Und selbst Milchmuffel dürften zufrieden sein: Da Milch in vielen Varianten angeboten wird – von Erdbeermilch über Kakao zu Vanillemlich –, ist für jedes Kind das Richtige dabei.
Generell ist der Wasserbedarf von Kindern im Verhältnis zum Körpergewicht höher als bei Erwachsenen. Trinken Kinder zu wenig, beeinträchtigt dies schneller die körperliche und geistige Leistungsfähigkeit. Kinder sollten deshalb je nach Alter mindestens 0,7 Liter bis 1,2 Liter trinken – Milch nicht mitgerechnet. Wenn das Kind viel Sport treibt oder tobt und bei besonders warmen Tagen brauchen die Kinder entsprechend mehr Flüssigkeit.
Viele Kinder trinken zu wenig. Häufig vergessen sie ganz einfach zu trinken, wenn sie konzentriert spielen oder lernen. Ganz wichtig ist es daher, Kinder immer mal wieder zum Trinken aufzufordern und auch zwischen den Mahlzeiten den Durst zu löschen, auch während der Unterrichtsstunden. Am besten sind Wasser, Kräutertees und Saftschorlen geeignet.
Übrigens: Fast ein Viertel aller Schüler in Deutschland trinkt vormittags nichts oder fast nichts. Das hat eine Untersuchung der Universität Paderborn zum Trinkverhalten vor und während der Unterrichtszeit ergeben. Die unzureichende Flüssigkeitsaufnahme führte dabei nachweislich zu Einschränkungen der geistigen und körperlichen Leistungsfähigkeit.
Kinder mögen Süßes. Schokoriegel und Süßigkeiten sollten allerdings beim Pausenbrot nicht die Regel sein. Eine gute Alternative dazu sind Trockenfrüchte, Fruchtschnitten oder Studentenfutter. Sie liefern wichtige Vitamine und Mineralstoffe und sind als Energieschub zwischendurch geeignet. Aber Vorsicht: Sie enthalten auch viel Energie und sollten gerade von Kindern, die leichtes Übergewicht haben, nur in geringen Mengen gegessen werden.
Viele Eltern nehmen sich morgens nicht die Zeit, mit ihren Kindern zu frühstücken, und geben Ihnen lieber Geld mit, damit sie sich auf dem Schulweg ein Frühstück kaufen können. Versuchen Sie, das zu vermeiden. Denn die meisten Kinder legen das Geld in Süßwaren oder Fast Food, Cola oder andere Süßgetränke an. Die Mittagsverpflegung in Schulen kann sehr unterschiedlich sein. Ein weiteres Pausenbrot wäre jedenfalls eine Zumutung für die Kinder. Deshalb gibt es verschiedene Systeme für die Versorgung am Mittag – Catering, kochende Eltern oder Profi–Küchen mit geschultem Personal. Klar ist: Für die Kinder sind Pausen und regelmäßige Mahlzeiten zur Aufrechterhaltung ihrer Leistungsfähigkeit wichtig. Daher sollte es im Interesse aller sein, den Kindern in der Schule eine geeignete Mittagsverpflegung zur Verfügung zu stellen.`,
            questions: [
              {
                id: "s2q1",
                type: "single",
                text: "Einige Eltern",
                options: [
                  {id: "s2q1o1", text: "haben selbst keinen Appetit auf ein Frühstück."},
                  {id: "s2q1o2", text: "lassen das Frühstück aus Zeitmangel ausfallen."},
                  {id: "s2q1o3", text: "schaufeln das Frühstück einfach in sich hinein."}
                ],
                correctAnswer: "s2q1o2"
              },
              {
                id: "s2q2",
                type: "single", 
                text: "Ein gesundes Frühstück",
                options: [
                  {id: "s2q2o1", text: "erhöht auch die Sicherheit des Kindes auf dem Weg zur Schule."},
                  {id: "s2q2o2", text: "muss mindestens aus einem Glas Kakao oder Milch bestehen."},
                  {id: "s2q2o3", text: "sollte gemeinsam in der Schule angenommen werden."}
                ],
                correctAnswer: "s2q2o1"
              },
              {
                id: "s2q3",
                type: "single",
                text: "Milch",
                options: [
                  {id: "s2q3o1", text: "deckt den täglichen Flüssigkeitsbedarf."},
                  {id: "s2q3o2", text: "gehört zum Angebot der Schulkantinen."},
                  {id: "s2q3o3", text: "wird in verschiedenen Geschmacksrichtungen angeboten."}
                ],
                correctAnswer: "s2q3o3"
              },
              {
                id: "s2q4",
                type: "single",
                text: "Kinder",
                options: [
                  {id: "s2q4o1", text: "denken von alleine nicht immer daran, genug zu trinken."},
                  {id: "s2q4o2", text: "dürfen während des Unterrichts nichts trinken."},
                  {id: "s2q4o3", text: "können sich auch noch gut konzentrieren, wenn sie nicht genug getrunken haben."}
                ],
                correctAnswer: "s2q4o1"
              },
              {
                id: "s2q5", 
                type: "single",
                text: "Mittagessen",
                options: [
                  {id: "s2q5o1", text: "sollte in der Schule angeboten werden."},
                  {id: "s2q5o2", text: "sollten die Kinder von zu Hause mitbringen."},
                  {id: "s2q5o3", text: "sollten Kinder bei den Eltern zu Hause bekommen."}
                ],
                correctAnswer: "s2q5o1"
              }
            ]
          },
          { 
            id: "s3", 
            title: "Leseverstehen, Teil 3", 
            points: 25,
            passageTitle:"Aufgabe: Lesen Sie die zehn Situationen (11-20) und die zwölf Texte (A-L). Welcher Text passt zu welcher Situation? Sie können jeden Text nur einmal verwenden. Manchmal passt kein Text. Wählen Sie dann 'x'.",
            passage: "",
            questions:[],
            texts: [
              {id: "A", text: "Neues Angebot der VHS: Ab dem kommenden Monat bietet die Volkshochschule in Zusammenarbeit mit der Bürgerschaft in unserem Stadtteil einen neuen Kurs an. Unter dem Motto 'Gemeinsam statt einsam' können alleinstehende ältere Menschen hier neue Kontakte knüpfen. Bei Kaffee und Kuchen wird gemeinsam gespielt, gesungen und über aktuelle Themen diskutiert. Der Kurs findet jeden Dienstag von 14 bis 16 Uhr statt. Eine Anmeldung ist nicht erforderlich.", correctAnswer: "11"},
              {id: "B", text: "Das neue Seniorenheim 'Haus am See' eröffnet am 1. Juni. Es bietet 80 voll ausgestattete Einzelzimmer mit eigenem Bad und Balkon. Neben der medizinischen Versorgung stehen auch verschiedene Freizeitaktivitäten zur Verfügung: Gedächtnistraining, Gymnastik, Musiktherapie und Ausflüge. Interessenten können sich ab sofort für eine Besichtigung anmelden. Besonders erwähnenswert ist der günstige Preis von nur 1.800 Euro monatlich inklusive Vollverpflegung.", correctAnswer: "12"},
              {id: "C", text: "Die Stadtbibliothek erweitert ihr Angebot für ältere Menschen. Ab sofort können Hörbücher in großer Schrift und mit einfacher Bedienung ausgeliehen werden. Zudem gibt es spezielle Lesebrillen, die das Lesen erleichtern. Jeden Donnerstag von 10 bis 12 Uhr bietet die Bibliothek eine Einführung in die Nutzung der neuen Geräte an. Der Service ist kostenlos.", correctAnswer: "13"},
              {id: "D", text: "Der Seniorenbeirat der Stadt sucht ehrenamtliche Helfer für das Projekt 'Hand in Hand'. Gesucht werden Menschen, die älteren Mitbürgern bei Einkäufen, Behördengängen oder kleinen Reparaturen in der Wohnung helfen möchten. Interessenten sollten über etwas Freizeit verfügen und gerne mit Menschen umgehen. Eine Aufwandsentschädigung wird gezahlt.", correctAnswer: "14"},
              {id: "E", text: "Das Gesundheitsamt warnt vor falschen Handwerkern, die besonders älteren Menschen teure Reparaturen aufschwatzen wollen. In den letzten Wochen häufen sich die Beschwerden über unseriöse Anbieter. Die Polizei rät: Lassen Sie sich niemals zu Arbeiten überreden, die Sie nicht selbst in Auftrag gegeben haben. Fragen Sie immer nach einem Ausweis und vergleichen Sie mehrere Angebote.", correctAnswer: "15"},
              {id: "F", text: "Der Seniorenclub 'Goldene Jahre' veranstaltet am 15. Mai einen Ausflug zur Landesgartenschau. Die Fahrt im komfortablen Reisebus startet um 8 Uhr am Rathausplatz und kehrt gegen 18 Uhr zurück. Der Preis von 25 Euro beinhaltet Fahrt, Eintritt und eine Mittagsmahlzeit. Anmeldungen werden bis zum 30. April entgegengenommen.", correctAnswer: "16"},
              {id: "G", text: "Die Deutsche Bahn bietet spezielle Seminare für ältere Menschen an, in denen der Umgang mit Fahrkartenautomaten und die Nutzung der Bahn-Apps erklärt werden. Die Kurse finden in kleinen Gruppen statt und dauern etwa zwei Stunden. Nach dem theoretischen Teil gibt es eine praktische Übung am Bahnhof. Die Teilnahme ist kostenfrei.", correctAnswer: "17"},
              {id: "H", text: "Die Verbraucherzentrale bietet am 12. Mai einen Vortrag zum Thema 'Sicherheit im Internet' speziell für Senioren an. Es wird erklärt, wie man sich vor Betrug im Internet schützt, sichere Passwörter erstellt und Online-Banking nutzt. Der Vortrag beginnt um 15 Uhr in den Räumen der Verbraucherzentrale. Der Eintritt ist frei.", correctAnswer: "18"},
              {id: "I", text: "Das städtische Krankenhaus sucht dringend Blutspender. Besonders benötigt werden Spenden der Blutgruppen 0 negativ und A negativ. Die nächste Blutspendeaktion findet am 20. Mai von 14 bis 18 Uhr im Konferenzsaal des Krankenhauses statt. Spender sollten zwischen 18 und 68 Jahre alt sein und ihren Personalausweis mitbringen.", correctAnswer: null},
              {id: "J", text: "Der Seniorenbeirat lädt alle interessierten Bürger ab 60 Jahren zur monatlichen Sprechstunde ein. Hier können Anliegen, Probleme und Vorschläge direkt mit den Mitgliedern des Beirats besprochen werden. Die nächste Sprechstunde findet am 5. Mai um 10 Uhr im Rathaus, Raum 204, statt. Eine vorherige Anmeldung ist nicht erforderlich.", correctAnswer: "19"},
              {id: "K", text: "Die Stadtwerke bieten einen speziellen Service für ältere Menschen an: Bei Problemen mit Wasser, Strom oder Gas können Senioren ab 70 Jahren den kostenlosen 'Senioren-Notdienst' nutzen. Ein Techniker kommt innerhalb von zwei Stunden und behebt das Problem. Der Service ist rund um die Uhr erreichbar unter der Telefonnummer 0800-1234567.", correctAnswer: "20"},
              {id: "L", text: "Das Sozialamt informiert über die Neuregelung der Grundsicherung im Alter. Ab dem 1. Juli gelten neue Richtwerte für den Bezug von Leistungen. Eine Beratung zu den Änderungen bietet das Amt jeden Mittwoch von 9 bis 12 Uhr an. Betroffene sollten ihre Einkommensnachweise und Mietverträge mitbringen.", correctAnswer: null}
            ],
            situations: [
              {id: "11", text: "Sie sind alleinstehend und möchten neue Leute kennenlernen."},
              {id: "12", text: "Sie suchen ein neues Zuhause mit Betreuung."},
              {id: "13", text: "Sie haben Sehprobleme und möchten trotzdem lesen."},
              {id: "14", text: "Sie haben Zeit und möchten älteren Menschen helfen."},
              {id: "15", text: "Sie wurden von einem Handwerker bedrängt."},
              {id: "16", text: "Sie möchten einen Tagesausflug mit anderen Senioren machen."},
              {id: "17", text: "Sie möchten lernen, wie man Zug fährt."},
              {id: "18", text: "Sie möchten sich über Internetsicherheit informieren."},
              {id: "19", text: "Sie haben ein Problem und möchten mit der Stadt sprechen."},
              {id: "20", text: "Sie haben einen Wasserrohrbruch und brauchen Hilfe."}
            ]
          },
          { 
            id: "s4", 
            title: "Sprachbausteine, Teil 1", 
            points: 15,
            passageTitle:"Aufgabe: Ergänzen Sie den Text. Wählen Sie für jede Lücke das passende Wort.",
            passage: "",
            questions:[],
            fillBlanks: [
              {
                id: "21",
                options: ["ab", "aus", "von"],
                correctAnswer: "aus"
              },
              {
                id: "22",
                options: ["wann", "was", "wie"],
                correctAnswer: "was"
              },
              {
                id: "23",
                options: ["da", "denn", "obwohl"],
                correctAnswer: "da"
              },
              {
                id: "24",
                options: ["ist", "wird", "würde"],
                correctAnswer: "wird"
              },
              {
                id: "25",
                options: ["bin", "war", "wäre"],
                correctAnswer: "wäre"
              },
              {
                id: "26",
                options: ["konnte", "musste", "sollte"],
                correctAnswer: "konnte"
              },
              {
                id: "27",
                options: ["aber", "denn", "sondern"],
                correctAnswer: "denn"
              },
              {
                id: "28",
                options: ["Beide", "Beiden", "Beides"],
                correctAnswer: "Beides"
              },
              {
                id: "29",
                options: ["erst", "noch", "schon"],
                correctAnswer: "noch"
              },
              {
                id: "30",
                options: ["auf", "für", "über"],
                correctAnswer: "auf"
              }
            ],
            fillText: `Betreff: Grüße ________ Berlin

Hallo Leon,

vielen Dank für deine letzte Mail ________ Peking! Du arbeitest ja jetzt schon seit einem halben Jahr in China unglaublich, wie schnell die Zeit vergeht.

Leider hatte ich in den letzten drei Wochen keine Zeit, dir zu antworten, weil ich viel zu tun hatte. Aber jetzt berichte ich dir, ________ alles los war.

Also, im Büro haben wir derzeit viel Stress, ________ drei Kollegen im Urlaub sind und eine weitere Kollegin seit zwei Wochen krank ist. Jetzt müssen wir mit fünf Leuten die Arbeit erledigen, die sonst neun Leute machen. Ich weiß wirklich nicht, wer diese Urlaubsplanung gemacht hat. Hoffentlich ________ das in Zukunft besser organisiert.

Abends waren Carmen und ich dann ein paarmal aus. Wir waren zum Beispiel bei einem Konzert von "Belasco". Kennst du die Band? Eigentlich war ich an dem Abend ganz schön kaputt und ________ am liebsten zuhause geblieben, aber ich hatte Carmen die Karten zum Geburtstag geschenkt. Da ________ ich ja schlecht auf dem Sofa sitzen bleiben! Im Nachhinein muss ich sagen: Ein Glück, dass wir zu dem Konzert gegangen sind, ________ es war einfach nur super!

An den letzten beiden Wochenenden hatten wir dann auch noch Familienfeiern: Erst hatte meine ältere Schwester Geburtstag und hat groß gefeiert, dann hat ein Cousin geheiratet und uns eingelagen, ________ war zwar schön, aber auch anstrengend. Ich bin froh, dass wir für die kommenden Wochenenden ________ keine Pläne haben.

Das war's erst mal von mir. Melde dich doch wieder, ich freue mich ________ deine nächste E-Mail!

Viele Grüße sendet dir

Fabian`
    },
    { 
      id: "s5", 
      title: "Sprachbausteine, Teil 2", 
      points: 15,
      passageTitle:"Aufgabe: Lesen Sie den Text und entscheiden Sie, welches Wort in welche Lücke passt. Sie können jedes Wort nur einmal verwenden. Nicht alle Wörter passen in den Text.",
      passage: "",
      questions:[],
      fillBlanks2: [
        {
          id: "31",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "KAUM"
        },
        {
          id: "32", 
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "MIT"
        },
        {
          id: "33",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "SONDERN"
        },
        {
          id: "34",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "OHNE"
        },
        {
          id: "35",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "STATT"
        },
        {
          id: "36",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "BESONDERS"
        },
        {
          id: "37",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "ABER"
        },
        {
          id: "38",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "SOLLTE"
        },
        {
          id: "39",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "FÜR"
        },
        {
          id: "40",
          options: ["ABER", "AN", "BESONDERS", "FÜR", "KAUM", "MIT", "MÜSSTE", "OHNE", "SCHON", "SO", "SOGAR", "SOLLTE", "SONDERN", "STATT", "VON"],
          correctAnswer: "SO"
        }
      ],
      fillText2: `Online-Sprachkurse & Co. - Wie lernt man heute am besten eine Sprache?

Es gibt inzwischen zahlreiche Online-Sprachkurse und ________ mit Smartphones kann man Sprachen lernen. Eine weitere Lernmöglichkeit ist zum Beispiel eine Tandem-Partnerschaft ________ einem Muttersprachler. Welche Vorteile und Nachteile haben die unterschiedlichen Methoden?

Es gibt inzwischen zahlreiche Online-Lernportale, die leicht zu überblicken und zu bedienen sind. Der Vorteil: Man kann die Wörter nicht nur lesen, ________ gleichzeitig auch hören. Außerdem kann man Wörter nachsprechen, ________ dass ein ganzer Kurs zuhört.

Auch Lerntipps bekommt man bei Online-Portalen, beispielsweise diesen: Vokabeln sollte man lieber mehrmals täglich in Fünf-Minuten-Blöcken wiederholen, ________ sie in einer Stunde alle auf einmal zu lernen.

Wer auch unterwegs lernen möchte, kann es mit einer Smartphone-App versuchen, einem kleinen Programm, das auf dem Handy läuft. Viele Programme gibt es kostenlos, andere kosten zwischen einem und mehreren Euro. Die kleinen Helfer sind ________ gut zum Vokabellernen geeignet - mehr aber meist nicht. Das spielerische Vokabeltraining macht zwar Spaß, ________ Satzbau oder andere Grammatikthemen werden allenfalls kurz angesprochen. Ein richtiges Gespräch kann man mit dieser Methode erst recht nicht üben. Dafür ________ man besser in einen Kurs gehen oder einen Tandem-Partner suchen.

Ein Tandem-Partner ist ein Muttersprachler, der die Grammatik erklärt, die Aussprache verbessert und seinerseits die Muttersprache des anderen lernen möchte.

Der schnellste Weg, ________ einen passenden Tandem-Partner zu finden, ist die Online-Suche: Muttersprache, Zielsprache und Wohnort eingeben, ________ werden alle Treffer angezeigt. Man trifft sich beispielsweise in einem Restaurant, schickt sich Nachrichten oder E-Mails und erklärt sich gegenseitig die eigene Sprache.`
    }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        questionIndex: 0, 
        answers: {}, 
        marked: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      const topTiles = document.getElementById('topTiles-lesen');
      const passageTitleEl = document.getElementById('passageTitle-lesen');
      const passageContentEl = document.getElementById('passageContent-lesen');
      const sectionNameEl = document.getElementById('sectionName-lesen');
      const questionTitleEl = document.getElementById('questionTitle-lesen');
      const questionBodyEl = document.getElementById('questionBody-lesen');
      const headingsBankContainer = document.getElementById('headingsBankContainer-lesen');
      const timerEl = document.getElementById('timer-lesen');
      const statusText = document.getElementById('statusText-lesen');
      const resultBtn = document.getElementById('resultBtn-lesen');
      const resetBtn = document.getElementById('resetBtn-lesen');
      const resetSectionBtn = document.getElementById('resetSectionBtn-lesen');

      /* ===== Timer Functions ===== */
      function startTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(()=>{
          if(state.remaining <= 0){
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay(){
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Reset Section Function ===== */
      function resetCurrentSection() {
        const currentSection = exam.sections[state.sectionIndex];
        
        if (confirm(`Möchten Sie wirklich den Teil "${currentSection.title}" zurücksetzen? Alle Antworten in diesem Teil werden gelöscht.`)) {
          if (currentSection.id === 's1') {
            currentSection.texts.forEach(text => {
              delete state.answers[text.id];
            });
          } else if (currentSection.id === 's2') {
            currentSection.questions.forEach(question => {
              delete state.answers[question.id];
            });
          } else if (currentSection.id === 's3') {
            currentSection.situations.forEach(situation => {
              delete state.answers[situation.id];
            });
          } else if (currentSection.id === 's4') {
            currentSection.fillBlanks.forEach(blank => {
              delete state.answers[blank.id];
            });
          } else if (currentSection.id === 's5') {
            currentSection.fillBlanks2.forEach(blank => {
              delete state.answers[blank.id];
            });
          }
          
          renderAll();
        }
      }

      /* ===== Render ===== */
      function renderTopTiles(){ 
        topTiles.innerHTML=''; 
        exam.sections.forEach((sec,idx)=>{ 
          const div=document.createElement('div'); 
          div.className='tile'+(idx===state.sectionIndex?' active':'')+(isSectionDone(sec)?' done':''); 
          div.innerHTML=`<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick=()=>{state.sectionIndex=idx; state.questionIndex=0; state.showResults=false; renderAll();}; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section){
        if(section.id==='s1') return section.texts.every(t=>state.answers[t.id]);
        if(section.id==='s2') return section.questions.every(q=>state.answers[q.id]);
        if(section.id==='s3') return section.situations.every(h=>state.answers[h.id] || state.answers[h.id] === 'X');
        if(section.id==='s4') return section.fillBlanks.every(b=>state.answers[b.id]);
        if(section.id==='s5') return section.fillBlanks2.every(b=>state.answers[b.id]);
        return false;
      }

      function renderAll(){
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        sectionNameEl.textContent = section.title;
        passageTitleEl.textContent = section.passageTitle;
        
        resetSectionBtn.style.display = 'block';
        
        if(state.showResults){
          renderResults();
          return;
        }
        
        if(section.id === 's1'){
          renderPart1();
        } else if(section.id === 's2'){
          renderPart2();
        } else if(section.id === 's3'){
          renderPart3();
        } else if(section.id === 's4'){
          renderSprachbausteine1();
        } else if(section.id === 's5'){
          renderSprachbausteine2();
        }
      }

      function renderPart1(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `<div class="instructions">Ziehen Sie die passenden Überschriften auf die Texte. Sie können jede Überschrift nur einmal verwenden.</div>`;
        
        section.texts.forEach((text, idx) => {
          const letter = String.fromCharCode(97 + idx);
          const selectedHeading = state.answers[text.id];
          
          textsHTML += `
            <div class="text-container">
              <div class="text-title">Text ${letter.toUpperCase()}</div>
              <div class="text-content">${text.content}</div>
              <div class="title-slot ${selectedHeading ? 'has-title' : ''}" data-text-id="${text.id}">
                ${selectedHeading ? getHeadingTextById(selectedHeading) : 'Ziehen Sie hier eine Überschrift hin'}
              </div>
            </div>
          `;
        });
        
        passageContentEl.innerHTML = textsHTML;
        
        let headingsHTML = `<div class="headings-bank">`;
        section.headings.forEach(heading => {
          const isUsed = section.texts.some(text => state.answers[text.id] === heading.id);
          
          headingsHTML += `
            <div class="heading-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-heading-id="${heading.id}">
              ${heading.id}) ${heading.text}
            </div>
          `;
        });
        
        headingsHTML += `</div>`;
        
        headingsBankContainer.innerHTML = headingsHTML;
        
        setupDragAndDrop();
        
        questionBodyEl.innerHTML = '';
        questionTitleEl.textContent = '';
      }

      function getHeadingTextById(id){
        const section = exam.sections[state.sectionIndex];
        const heading = section.headings.find(h => h.id === id);
        return heading ? `${heading.id}) ${heading.text}` : '';
      }

      function setupDragAndDrop(){
        const headingItems = document.querySelectorAll('.heading-item:not(.used)');
        const titleSlots = document.querySelectorAll('.title-slot');
        
        headingItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.headingId);
          });
        });
        
        titleSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            slot.style.background = slot.classList.contains('has-title') ? '#e8fbe9' : '#f8fbff';
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const headingId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === headingId) {
                delete state.answers[key];
              }
            });
            
            state.answers[textId] = headingId;
            renderAll();
          });
        });
      }

      function renderPart2(){
        const section = exam.sections[state.sectionIndex];
        
        passageContentEl.innerHTML = `<div class="passage">${section.passage}</div>`;
        
        let questionsHTML = `<div class="all-questions">`;
        
        section.questions.forEach((question, idx) => {
          const questionNumber = idx + 1;
          const userAnswer = state.answers[question.id];
          
          questionsHTML += `
            <div class="question-block">
              <div class="question-text">${questionNumber}. ${question.text}</div>
              <div class="options">
                ${question.options.map(opt => `
                  <div class="option ${userAnswer === opt.id ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectOption('${question.id}', '${opt.id}')">
                    <div class="radio"></div>
                    <div>${opt.text}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = questionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function renderPart3(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `
          <div class="instructions">Ziehen Sie die passenden Situationen auf die Texte. Sie können jede Situation nur einmal verwenden. Manchmal passt keine Situation.</div>
          <div class="texts-list">
            <h3>Texte (A-L)</h3>
        `;
        
        section.texts.forEach(text => {
          const userAnswer = Object.keys(state.answers).find(key => state.answers[key] === text.id);
          const selectedSituation = userAnswer ? section.situations.find(h => h.id === userAnswer) : null;
          
          textsHTML += `
            <div class="text-item" data-text-id="${text.id}">
              <div class="text-letter">${text.id})</div>
              <div class="text-content">${text.text}</div>
              <div class="title-slot ${userAnswer ? 'has-title' : ''} ${userAnswer === 'X' ? 'has-x' : ''}" data-text-id="${text.id}">
                ${selectedSituation ? selectedSituation.text : (userAnswer === 'X' ? 'X - Keine passende Situation' : 'Ziehen Sie hier eine Situation hin')}
              </div>
            </div>
          `;
        });
        
        textsHTML += `</div>`;
        
        passageContentEl.innerHTML = textsHTML;
        
        let situationsHTML = `
          <div class="situations-list">
            <h3>Situationen (11-20)</h3>
        `;
        
        section.situations.forEach((situation, idx) => {
          const situationNumber = parseInt(situation.id);
          const isUsed = state.answers[situation.id];
          const isX = state.answers[situation.id] === 'X';
          
          situationsHTML += `
            <div class="situation-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-situation-id="${situation.id}">
              <div class="situation-number">${situationNumber}.</div>
              <div class="situation-text">${situation.text}</div>
              ${!isUsed ? `<button class="exam-btn no-match ${isX ? 'selected' : ''}" onclick="window.lesenApp.markNoMatch('${situation.id}')">X - Kein passender Text</button>` : ''}
            </div>
          `;
        });
        
        situationsHTML += `</div>`;
        
        questionBodyEl.innerHTML = situationsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
        
        setupPart3DragAndDrop();
      }

      function markNoMatch(situationId) {
        Object.keys(state.answers).forEach(key => {
          if(state.answers[key] === situationId) {
            delete state.answers[key];
          }
        });
        
        state.answers[situationId] = 'X';
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function setupPart3DragAndDrop(){
        const situationItems = document.querySelectorAll('.situation-item:not(.used)');
        const textSlots = document.querySelectorAll('.text-item .title-slot');
        
        situationItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.situationId);
          });
        });
        
        textSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            const hasTitle = slot.classList.contains('has-title');
            const hasX = slot.classList.contains('has-x');
            slot.style.background = hasTitle ? '#e8fbe9' : (hasX ? '#f8d7da' : '#f8fbff');
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const situationId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === situationId) {
                delete state.answers[key];
              }
            });
            
            state.answers[situationId] = textId;
            renderAll();
          });
        });
      }

      function renderSprachbausteine1(){
        const section = exam.sections[state.sectionIndex];
        
        let textWithBlanks = section.fillText;
        
        const blankPlaceholders = [];
        section.fillBlanks.forEach(blank => {
          blankPlaceholders.push(`BLANK_${blank.id}`);
        });
        
        let tempText = textWithBlanks;
        blankPlaceholders.forEach((placeholder, index) => {
          tempText = tempText.replace('________', placeholder);
        });
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          const displayText = userAnswer ? userAnswer : '________';
          tempText = tempText.replace(`BLANK_${blank.id}`, `<span class="blank-word ${userAnswer ? 'has-answer' : ''}" data-blank-id="${blank.id}">${displayText}</span>`);
        });
        
        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können die Lücken in beliebiger Reihenfolge ausfüllen.</div>
          <div class="fill-blank-container">${tempText}</div>
        `;
        
        document.querySelectorAll('.blank-word').forEach(blank => {
          blank.addEventListener('click', (e) => {
            showOptionsPopup(e.target);
          });
        });
        
        let optionsHTML = `<div class="horizontal-options" style="gap: 8px;">`;
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          
          optionsHTML += `
            <div class="option-row" style="padding: 8px; margin-bottom: 5px;">
              <div class="option-number">${blank.id}</div>
              <div class="option-buttons">
                ${blank.options.map(opt => `
                  <div class="option-btn ${userAnswer === opt ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectSprachbausteine1('${blank.id}', '${opt}')" 
                       style="padding: 6px 12px; font-size: 12px;">
                    ${opt}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        optionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = optionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function showOptionsPopup(blankElement){
        const existingPopup = document.querySelector('.options-popup');
        if(existingPopup) {
          existingPopup.remove();
        }
        
        const blankId = blankElement.getAttribute('data-blank-id');
        const section = exam.sections.find(s => s.id === 's4');
        const blank = section.fillBlanks.find(b => b.id === blankId);
        
        if(!blank) return;
        
        const popup = document.createElement('div');
        popup.className = 'options-popup';
        
        blank.options.forEach(opt => {
          const optionItem = document.createElement('div');
          optionItem.className = 'option-item';
          optionItem.textContent = opt;
          optionItem.onclick = () => {
            selectSprachbausteine1(blankId, opt);
            popup.remove();
          };
          popup.appendChild(optionItem);
        });
        
        blankElement.appendChild(popup);
      }

      function selectSprachbausteine1(blankId, answer){
        state.answers[blankId] = answer;
        renderAll();
      }

      function renderSprachbausteine2(){
        const section = exam.sections[state.sectionIndex];
        // Build text but replace blanks with unique placeholders first (prevents ambiguous replacements)
        let textWithPlaceholders = section.fillText2;
        const placeholders = [];
        section.fillBlanks2.forEach(blank => {
          const ph = `BLANK_${blank.id}`;
          placeholders.push({id: blank.id, ph});
          // replace first occurrence of the visual underline with placeholder
          textWithPlaceholders = textWithPlaceholders.replace('________', ph);
        });

        // Now replace placeholders with actual span elements showing current answer (or underscore)
        placeholders.forEach(item => {
          const userAnswer = state.answers[item.id];
          const displayText = userAnswer ? userAnswer : '________';
          const span = `<span class="blank-slot ${userAnswer ? 'has-answer' : ''}" data-blank-id="${item.id}">${displayText}</span>`;
          textWithPlaceholders = textWithPlaceholders.replace(item.ph, span);
        });

        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede Lücke und wählen Sie das passende Wort aus. Sie können jedes Wort nur einmal verwenden.</div>
          <div class="fill-blank-container">${textWithPlaceholders}</div>
        `;

        // attach click handlers to slots
        document.querySelectorAll('.blank-slot').forEach(slot => {
          slot.addEventListener('click', (e) => {
            // use the element itself to open popup
            showSprachbausteine2Options(slot);
          });
        });

        // Build word bank on the right
        let wordBankHTML = `<div class="word-bank-vertical" style="gap: 8px;">`;
        const usedWords = Object.values(state.answers);
        // Use section.wordBank if present, otherwise derive from fillBlanks2 options
        const bank = section.wordBank && section.wordBank.length ? section.wordBank : (section.fillBlanks2[0] ? section.fillBlanks2[0].options : []);
        bank.forEach(word => {
          const isUsed = usedWords.includes(word);
          wordBankHTML += `
            <div class="bank-word-vertical ${isUsed ? 'used' : ''}" 
                 draggable="${!isUsed}" 
                 data-word="${word}"
                 ${!isUsed ? `onclick="window.lesenApp.selectSprachbausteine2FromBank('${word}')"` : ''}>
              ${word}
            </div>
          `;
        });
        wordBankHTML += `</div>`;
        questionBodyEl.innerHTML = wordBankHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';

        setupSprachbausteine2DragAndDrop();
      }

      // --- Added functions to handle drag/drop and clicks for Sprachbausteine Teil 2 ---
      let lastClickedSprachSlot = null;

      function setupSprachbausteine2DragAndDrop(){
        // bank words: make draggable if not used, attach dragstart
        const bankWords = Array.from(document.querySelectorAll('.bank-word-vertical'));
        bankWords.forEach(el => {
          const word = el.dataset.word;
          if(!el.classList.contains('used')){
            el.setAttribute('draggable','true');
          } else {
            el.setAttribute('draggable','false');
          }
          // ensure single attached listener
          el.removeEventListener('dragstart', el._dstart);
          el._dstart = (e) => {
            e.dataTransfer.setData('text/plain', word);
            // also set an indicator
            e.dataTransfer.setData('source', 'bank');
          };
          el.addEventListener('dragstart', el._dstart);

          // keep onclick behavior (select into clicked slot)
          el.removeEventListener('click', el._onclick);
          el._onclick = () => {
            if(el.classList.contains('used')) return;
            selectSprachbausteine2FromBank(word);
          };
          el.addEventListener('click', el._onclick);
        });

        // blank slots: allow drop
        const slots = Array.from(document.querySelectorAll('.blank-slot'));
        slots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', (e) => {
            slot.classList.remove('drag-over');
          });
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            slot.classList.remove('drag-over');
            const word = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html');
            if(!word) return;
            // Determine blank id
            const blankId = slot.dataset.blankId;
            if(!blankId) return;
            // If this word is already used in another slot, free it
            Object.keys(state.answers).forEach(k => {
              if(state.answers[k] === word){
                delete state.answers[k];
              }
            });
            // If slot had a previous answer, free that bank word
            const prev = state.answers[blankId];
            if(prev){
              const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
              if(prevEl){
                prevEl.classList.remove('used');
                prevEl.setAttribute('draggable','true');
                prevEl.addEventListener('click', prevEl._onclick);
              }
            }
            // mark bank word used
            const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
            if(bankEl){
              bankEl.classList.add('used');
              bankEl.setAttribute('draggable','false');
              // remove click to prevent double-placing
              bankEl.removeEventListener('click', bankEl._onclick);
            }
            // assign to state and re-render
            state.answers[blankId] = word;
            renderAll();
          });
        });
      }

      function showSprachbausteine2Options(slot){
        // highlight selected slot so click from bank knows target
        document.querySelectorAll('.blank-slot').forEach(s => s.classList.remove('selected-sprach'));
        slot.classList.add('selected-sprach');
        lastClickedSprachSlot = slot;
      }

      function selectSprachbausteine2FromBank(word){
        // choose target slot: prefer lastClicked, otherwise first empty
        let slot = lastClickedSprachSlot;
        if(!slot){
          slot = Array.from(document.querySelectorAll('.blank-slot')).find(s => {
            const id = s.dataset.blankId;
            return !state.answers[id];
          });
        }
        if(!slot) {
          // if none available, do nothing
          return;
        }
        const blankId = slot.dataset.blankId;
        // free previous occurrence of word
        Object.keys(state.answers).forEach(k => {
          if(state.answers[k] === word){
            delete state.answers[k];
          }
        });
        // free previous word in target slot
        const prev = state.answers[blankId];
        if(prev){
          const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
          if(prevEl){
            prevEl.classList.remove('used');
            prevEl.setAttribute('draggable','true');
            if(prevEl._onclick) prevEl.addEventListener('click', prevEl._onclick);
          }
        }
        // mark selected bank word as used
        const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
        if(bankEl){
          bankEl.classList.add('used');
          bankEl.setAttribute('draggable','false');
          if(bankEl._onclick) try{ bankEl.removeEventListener('click', bankEl._onclick); }catch(e){}
        }
        // assign value
        state.answers[blankId] = word;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        lastClickedSprachSlot = null;
        renderAll();
      }

      function selectOption(questionId, optionId){
        state.answers[questionId] = optionId;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function renderResults(){
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        let totalCorrect = 0;
        let totalQuestions = 0;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="result-item"><h3>${section.title}</h3>`;
          
          if(section.id === 's1'){
            section.texts.forEach(text => {
              totalQuestions++;
              const userAnswer = state.answers[text.id];
              const isCorrect = userAnswer === text.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Text ${text.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's2'){
            section.questions.forEach(question => {
              totalQuestions++;
              const userAnswer = state.answers[question.id];
              const isCorrect = userAnswer === question.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>${question.text}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's3'){
            section.situations.forEach(situation => {
              totalQuestions++;
              const userAnswer = state.answers[situation.id];
              const correctText = section.texts.find(t => t.correctAnswer === situation.id);
              const isCorrect = userAnswer === (correctText ? correctText.id : null);
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Situation ${situation.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's4'){
            section.fillBlanks.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's5'){
            section.fillBlanks2.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Lücke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '✓' : '✗'}</span>` : ''}
                </div>
              `;
            });
          }
          
          resultsHTML += `</div>`;
        });
        
        const percentage = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        resultsHTML += `<div class="result-item"><h3>Gesamtergebnis: ${totalCorrect}/${totalQuestions} (${percentage}%)</h3></div>`;
        
        passageContentEl.innerHTML = resultsHTML;
        questionBodyEl.innerHTML = '';
        sectionNameEl.textContent = 'Ergebnisse';
        questionTitleEl.textContent = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex > 0){
          state.sectionIndex--;
          state.questionIndex = 0;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex < exam.sections.length - 1){
          state.sectionIndex++;
          state.questionIndex = 0;
          renderAll();
        }
      });

      resultBtn.addEventListener('click', ()=>{
        state.showResults = !state.showResults;
        renderAll();
      });

      resetBtn.addEventListener('click', ()=>{
        if(confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')){
          state.answers = {};
          state.marked = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      resetSectionBtn.addEventListener('click', resetCurrentSection);

      document.getElementById('saveBtn-lesen').addEventListener('click', ()=>{
        statusText.textContent = 'Gespeichert';
        setTimeout(()=>{statusText.textContent = 'Nicht gespeichert'}, 2000);
      });

      document.getElementById('submitBtn-lesen').addEventListener('click', ()=>{
        if(confirm('Möchten Sie die Prüfung wirklich abgeben?')){
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        showPage('hoeren-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
      window._lesenState = state;
      window.lesenApp = {
        selectOption,
        markNoMatch,
        selectSprachbausteine1,
        selectSprachbausteine2FromBank
      };
    }

    // ===== HÖREN PAGE FUNCTIONALITY =====
    function initHoerenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-hörverstehen",
        durationSec: 17 * 60, // 17 minutes in seconds
        sections: [
          { 
            id: "hörverstehen1", 
            title: "Hörverstehen, Teil 1", 
            points: 25,
            correctAnswers: { "41": "falsch", "42": "richtig", "43": "falsch", "44": "richtig", "45": "falsch" },
            questions: [
              {
                id: "41",
                text: "Viele Kunden würden für bessere Serviceleistungen der Paketdienste höhere Gebühren bezahlen."
              },
              {
                id: "42", 
                text: "Nach dem Unfall konnten beide Schiffe ihre Fahrt nicht fortsetzen."
              },
              {
                id: "43",
                text: "Europaweit gibt es immer weniger Vögel."
              },
              {
                id: "44",
                text: "Die Polizei hat auf der Autobahn ein dort verbotenes Fahrzeug entdeckt."
              },
              {
                id: "45",
                text: "Bei dem Festival konnte man Konzerte an verschiedenen Orten besuchen."
              }
            ]
          },
          { 
            id: "hörverstehen2", 
            title: "Hörverstehen, Teil 2", 
            points: 25,
            correctAnswers: { "46": "falsch", "47": "richtig", "48": "falsch", "49": "richtig", "50": "falsch", "51": "falsch", "52": "falsch", "53": "richtig", "54": "falsch", "55": "richtig" },
            questions: [
              {
                id: "46",
                text: "Herr Karimov hat vor sechs Jahren die Internetplattform ZEITPLAN gegründet."
              },
              {
                id: "47",
                text: "Die Mitglieder bekommen für ihre Hilfe ein Stundenguthaben."
              },
              {
                id: "48", 
                text: "Herr Karimov hatte ein eigenes Handwerksunternehmen."
              },
              {
                id: "49",
                text: "Nach dem Umzug aufs Land war er auf die Hilfe der Nachbarn angewiesen."
              },
              {
                id: "50",
                text: "Manchmal erwarten Mitglieder keine Gegenleistung für ihre Arbeit."
              },
              {
                id: "51",
                text: "Meistens brauchen alleinstehende Frauen Herrn Karimovs Hilfe."
              },
              {
                id: "52",
                text: "Viele Menschen sehen im ZEITPLAN eine Konkurrenz zu Handwerksbetrieben."
              },
              {
                id: "53",
                text: "Herr Karimov erledigt nicht so gerne Büroarbeit."
              },
              {
                id: "54",
                text: "Wer sich bei der Nachbarschaftshilfe einbringen möchte, muss sich persönlich vorstellen."
              },
              {
                id: "55",
                text: "Herr Karimov brauchte vorübergehend einen Chauffeur."
              }
            ]
          },
          { 
            id: "hörverstehen3", 
            title: "Hörverstehen, Teil 3", 
            points: 25,
            correctAnswers: { "56": "richtig", "57": "falsch", "58": "falsch", "59": "falsch", "60": "richtig" },
            questions: [
              {
                id: "56",
                text: "Besucher des Reitturniers sollten möglichst Parkplätze außerhalb des Turniergeländes nutzen."
              },
              {
                id: "57",
                text: "Das Open-Air-Gospelkonzert wird live im Radio übertragen."
              },
              {
                id: "58",
                text: "Bei der Berliner Museumsnacht können Sie mit einer Sonderbuslinie bequem jedes Museum erreichen."
              },
              {
                id: "59",
                text: "Wegen Glätte ist die A5 zwischen Mannheim und Frankfurt in beide Richtungen voll gesperrt."
              },
              {
                id: "60",
                text: "Hotelreservierungen in Dresden sind ausschließlich telefonisch möglich."
              }
            ]
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-hoeren');
      const contentContainer = document.getElementById('contentContainer-hoeren');
      const timerEl = document.getElementById('timer-hoeren');
      const statusText = document.getElementById('statusText-hoeren');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        const answers = state.answers[section.id];
        if (!answers) return false;
        
        // تحقق إذا تمت الإجابة على جميع الأسئلة في هذا القسم
        const answeredQuestions = Object.keys(answers).length;
        const totalQuestions = section.questions.length;
        
        return answeredQuestions === totalQuestions;
      }

      function renderAll() {
        renderTopTiles();
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderListeningSection();
      }

      function renderListeningSection() {
        const section = exam.sections[state.sectionIndex];
        const currentAnswers = state.answers[section.id] || {};
        
        let contentHTML = `
          <div class="panel-title">${section.title}</div>
          <div class="instructions">
            Sie hören die Nachrichten. Entscheiden Sie beim Hören, ob die Aussagen richtig oder falsch sind. 
            Sie hören die Nachrichten nur einmal. Sie haben jetzt 30 Sekunden, um die Aussagen zu lesen.
          </div>
          
          <div class="listening-task">
            <table class="true-false-table">
              <thead>
                <tr>
                  <th style="width: 10%">Nr.</th>
                  <th style="width: 60%">Aussage</th>
                  <th style="width: 30%">Ihre Antwort</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        section.questions.forEach((question, index) => {
          const currentAnswer = currentAnswers[question.id] || '';
          contentHTML += `
            <tr>
              <td><strong>${question.id}</strong></td>
              <td class="question-text">${question.text}</td>
              <td>
                <div class="answer-options">
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="richtig" 
                      ${currentAnswer === 'richtig' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Richtig
                  </label>
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="falsch" 
                      ${currentAnswer === 'falsch' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Falsch
                  </label>
                </div>
              </td>
            </tr>
          `;
        });
        
        contentHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        contentContainer.innerHTML = contentHTML;
      }

      function updateListeningAnswer(sectionId, questionId, answer) {
        if (!state.answers[sectionId]) {
          state.answers[sectionId] = {};
        }
        state.answers[sectionId][questionId] = answer;
        try{ localStorage.setItem('hoerenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        
        // إعادة عرض البلاطات لتحديث حالة "تم"
        renderTopTiles();
      }

      function renderResults() {
        let resultsHTML = `<div class="panel-title">Ergebnisse - Hörverstehen</div>`;
        
        exam.sections.forEach(section => {
          const userAnswers = state.answers[section.id] || {};
          let correctCount = 0;
          
          resultsHTML += `
            <div class="listening-task">
              <h3>${section.title} (${section.points} Punkte)</h3>
              <table class="true-false-table">
                <thead>
                  <tr>
                    <th style="width: 10%">Nr.</th>
                    <th style="width: 50%">Aussage</th>
                    <th style="width: 15%">Ihre Antwort</th>
                    <th style="width: 15%">Richtige Antwort</th>
                    <th style="width: 10%">Punkte</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          section.questions.forEach((question) => {
            const userAnswer = userAnswers[question.id] || '-';
            const correctAnswer = section.correctAnswers[question.id];
            const gotCorrect = userAnswer === correctAnswer;
            const points = gotCorrect ? "1" : "0";
            
            if (gotCorrect) correctCount++;
            
            const rowClass = gotCorrect ? 'correct-answer' : 'incorrect-answer';
            
            resultsHTML += `
              <tr class="${rowClass}">
                <td><strong>${question.id}</strong></td>
                <td class="question-text">${question.text}</td>
                <td>${userAnswer}</td>
                <td>${correctAnswer}</td>
                <td><strong>${points}</strong></td>
              </tr>
            `;
          });
          
          const totalPoints = Math.round((correctCount / section.questions.length) * section.points);
          
          resultsHTML += `
                </tbody>
              </table>
              <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                <strong>Erreichte Punkte: ${correctCount}/${section.questions.length} richtig = ${totalPoints}/${section.points} Punkten</strong>
              </div>
            </div>
          `;
        });
        
        contentContainer.innerHTML = resultsHTML;
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-hoeren').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöscht.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-hoeren').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-hoeren').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        showPage('schreiben-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._hoerenState = state;
        window.hoerenApp = {
        updateListeningAnswer
      };
    }

    // ===== SCHREIBEN PAGE FUNCTIONALITY =====
    function initSchreibenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-002",
        durationSec: 30 * 60, // 30 minutes in seconds
        sections: [
          { 
            id: "s1", 
            title: "Schreiben, Teil 1", 
            points: 45,
            passageTitle: "Aufgabe: Schreiben Sie eine E-Mail",
            passage: "",
            writingTask: {
              prompt: `Schmelzkäse - Alpengeschmack

Die Reinheit der Natur auf Ihrem Teller! 
Schmelzkäse ist eine besondere Spezialität unter den Käsen und wird aus gereiftem Schnittkäse 
oder Frischkäse auf Grundlage einer traditionellen Methode weiterverarbeitet und gleichzeitig 
haltbar gemacht. 

Schmelzkäse - Alpengeschmack ist in der modernen Küche besonders beliebt, da er vielseitig 
einsetzbar ist: Er bindet Soßen und Suppen, verleiht den Gerichten eine feinwürzige Note, ist perfekt 
zum Überbacken geeignet und darf auf keinem Frühstücks- oder Abendbrottisch fehlen. 

Zutaten: 
50 % Käse, Süßmolke, Butter, Schmelzsalze, Natriumphosphate, Natriumcitrate, Polyphosphate, 
Magermilch aus Kuhmilch, Milcheiweiß, Speisesalz, 
Farbstoffe: Paprikaextrakt, Carotin. 

10 Scheiben, einzeln in Folie verpackt. 
Ungeöffnet mindestens 24 Tage haltbar. Nach dem Öffnen gekühlt lagern. 

Artikelnummer: 9977 8855 
Hersteller: Molkerei Alpengeschmack 
Lindauer Straße 5 
87437 Kempten 
Tel. 0831-181921 
www.molkerei-alpengeschmack.de`,
              requirements: [
                "Erläutern Sie, wozu Sie diesen Käse verwenden.",
                "Beschreiben Sie, welche gesundheitlichen Beschwerden Sie nach dem Essen hatten.",
                "Erklären Sie, warum die Fremdkörper gesundheitsgefährdend sind.",
                "Beschreiben Sie, wen Sie außer dem Hersteller noch informiert haben."
              ],
              wordCount: 0
            }
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-schreiben');
      const passageTitleEl = document.getElementById('passageTitle-schreiben');
      const passageContentEl = document.getElementById('passageContent-schreiben');
      const writingContainer = document.getElementById('writingContainer-schreiben');
      const timerEl = document.getElementById('timer-schreiben');
      const statusText = document.getElementById('statusText-schreiben');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        return state.answers[section.id] && state.answers[section.id].length > 0;
      }

      function renderAll() {
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        passageTitleEl.textContent = section.passageTitle;
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderWritingSection();
      }

      function renderWritingSection() {
        const section = exam.sections[state.sectionIndex];
        
        // Render the prompt in left panel
        passageContentEl.innerHTML = `
          <div class="writing-task">
            <div class="writing-prompt">${section.writingTask.prompt}</div>
            <div class="instructions" style="border:1px solid #e1e8f6; padding:10px; margin:10px 0; border-radius:6px; background:#ffffff;">Sie haben dieses Produkt gekauft, es war aber verunreinigt. 
Der Käse enthielt Fremdkörper, und Sie sind nach dem Essen erkrankt. 
Schreiben Sie einen Beschwerdebrief an den Hersteller.</div>
            <div class="writing-requirements">
              <h4>Schreiben Sie in Ihrer E-Mail:</h4>
              <ul>
                ${section.writingTask.requirements.map(req => `<li>${req}</li>`).join('')}
              </ul>
            </div>
            <div class="instructions">
              Schreiben Sie eine E-Mail (ca. 150-200 Wörter). Achten Sie auf den Textaufbau (Anrede, Einleitung, Hauptteil, Schluss) und eine angemessene Formulierung.
            </div>
          </div>
        `;
        
        // Render writing area in right panel
        const currentAnswer = state.answers[section.id] || '';
        const wordCount = countWords(currentAnswer);
        
        writingContainer.innerHTML = `
          <div class="writing-area">
            <textarea 
              class="writing-textarea" 
              placeholder="Schreiben Sie hier Ihre E-Mail..."
              oninput="window.schreibenApp.updateWritingAnswer('${section.id}', this.value)"
            >${currentAnswer}</textarea>
            <div class="word-counter">
              Wörter: <span class="count">${wordCount}</span>
            </div>
          </div>
        `;
      }

      function countWords(text) {
        return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      }

      function updateWritingAnswer(sectionId, text) {
        state.answers[sectionId] = text;
        try{ localStorage.setItem('schreibenAnswers', JSON.stringify({content: state.answers[sectionId], wordCount: (state.answers[sectionId]||'').trim().split(/\s+/).filter(Boolean).length})); }catch(e){}
        
        const wordCount = countWords(text);
        document.querySelector('.word-counter .count').textContent = wordCount;
      }

      function renderResults() {
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="writing-task"><h3>${section.title}</h3>`;
          
          const userAnswer = state.answers[section.id];
          const wordCount = countWords(userAnswer);
          
          resultsHTML += `
            <div class="writing-requirements">
              <h4>Ihre Antwort (${wordCount} Wörter):</h4>
              <div style="white-space: pre-wrap; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e1e8f6; margin-top: 10px;">${userAnswer || 'Keine Antwort'}</div>
            </div>
          `;
          
          resultsHTML += `</div>`;
        });
        
        passageContentEl.innerHTML = resultsHTML;
        writingContainer.innerHTML = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-schreiben').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie wirklich von neu beginnen? Alle Antworten werden gelöschت.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-schreiben').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-schreiben').addEventListener('click', () => {
        if (confirm('Möchten Sie die Prüfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        showPage('ergebnisse-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._schreibenState = state;
        window.schreibenApp = {
        updateWritingAnswer
      };
    }

    // ===== ERGEBNISSE PAGE FUNCTIONALITY =====
    function initErgebnissePage() {
      const CONFIG = {
        totals: { 
          lesen: 105, 
          hoeren: 75, 
          schreiben: 45, 
          gesamt: 225 
        },
        counts: { 
          lesen: 40, 
          hoeren: 20 
        },
        hoerenCorrect: {
          "41": "falsch", "42": "richtig", "43": "falsch", "44": "richtig", "45": "falsch",
          "46": "falsch", "47": "richtig", "48": "falsch", "49": "richtig", "50": "falsch",
          "51": "falsch", "52": "falsch", "53": "richtig", "54": "falsch", "55": "richtig",
          "56": "richtig", "57": "falsch", "58": "falsch", "59": "falsch", "60": "richtig"
        },
        lesenCorrect: Object.assign({},
          {"text1": "i", "text2": "b", "text3": "a", "text4": "g", "text5": "c"},
          {"s2q1": "s2q1o2", "s2q2": "s2q2o1", "s2q3": "s2q3o3", "s2q4": "s2q4o1", "s2q5": "s2q5o1"},
          {"11": "A", "12": "B", "13": "C", "14": "D", "15": "E", "16": "F", "17": "G", "18": "H", "19": "J", "20": "K"},
          {"21": "aus", "22": "was", "23": "da", "24": "wird", "25": "wäre", "26": "konnte", "27": "denn", "28": "Beides", "29": "noch", "30": "auf"},
          {"31": "KAUM", "32": "MIT", "33": "SONDERN", "34": "OHNE", "35": "STATT", "36": "BESONDERS", "37": "ABER", "38": "SOLLTE", "39": "FÜR", "40": "SO"}
        )
      };

      function normalizeAnswer(a) {
        if (a === null || a === undefined) return '';
        let s = String(a).trim();
        if (s === '') return '';
        const low = s.toLowerCase();
        if (["richtig", "true", "yes", "ja"].includes(low)) return 'richtig';
        if (["falsch", "false", "no", "nein"].includes(low)) return 'falsch';
        return s;
      }

      function keyZeroToTen(k) {
        return k === '0' ? '10' : k;
      }

      function readExamResults() {
        try {
          const lesen = {};
          const hoeren = {};
          const schreiben = { content: '', wordCount: 0 };

          // 1) Try to read from in-memory states exposed by pages
          try {
            if (window._lesenState && window._lesenState.answers) {
              Object.keys(window._lesenState.answers).forEach(k => {
                lesen[k] = window._lesenState.answers[k];
              });
            }
          } catch (e) {}

          try {
            if (window._hoerenState && window._hoerenState.answers) {
              Object.keys(window._hoerenState.answers).forEach(sectionId => {
                const sec = window._hoerenState.answers[sectionId] || {};
                Object.keys(sec).forEach(q => {
                  hoeren[q] = sec[q];
                });
              });
            }
          } catch (e) {}

          try {
            if (window._schreibenState && window._schreibenState.answers) {
              const answers = window._schreibenState.answers;
              if (answers['s1']) {
                schreiben.content = answers['s1'];
              } else {
                const keys = Object.keys(answers);
                if (keys.length > 0) schreiben.content = answers[keys[0]] || '';
              }
              schreiben.wordCount = (schreiben.content && schreiben.content.trim()) ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0;
            }
          } catch (e) {}

          // 2) Fallback to localStorage if any part is still empty
          try {
            if (Object.keys(lesen).length === 0) {
              const storedL = localStorage.getItem('lesenAnswers');
              if (storedL) Object.assign(lesen, JSON.parse(storedL));
            }
          } catch (e) {}

          try {
            if (Object.keys(hoeren).length === 0) {
              const storedH = localStorage.getItem('hoerenAnswers');
              if (storedH) Object.assign(hoeren, JSON.parse(storedH));
            }
          } catch (e) {}

          try {
            if (!schreiben.content) {
              const storedS = localStorage.getItem('schreibenAnswers');
              if (storedS) {
                const obj = JSON.parse(storedS);
                schreiben.content = obj.content || '';
                schreiben.wordCount = obj.wordCount || (schreiben.content.trim() ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0);
              }
            }
          } catch (e) {}

          // final safe return
          return { hoeren, lesen, schreiben };
        } catch (e) {
          return { hoeren: {}, lesen: {}, schreiben: {} };
        }
      }

      function gradeHoeren(u) {
        const c = CONFIG.hoerenCorrect;
        let okCount = 0;
        const d = [];
        
        for (let q = 41; q <= 60; q++) {
          const k = String(q);
          const uA = normalizeAnswer(u[k] || '');
          const exp = normalizeAnswer(c[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.hoeren / CONFIG.counts.hoeren;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        }
        
        const total = Number((okCount * (CONFIG.totals.hoeren / CONFIG.counts.hoeren)).toFixed(2));
        return { okCount, total, details: d };
      }

      function gradeLesen(u) {
        const c = CONFIG.lesenCorrect;
        let okCount = 0;
        const d = [];
        
        Object.keys(c).forEach(k => {
          const exp = normalizeAnswer(c[k]);
          const uA = normalizeAnswer(u[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.lesen / CONFIG.counts.lesen;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        });
        
        const total = Number((okCount * (CONFIG.totals.lesen / CONFIG.counts.lesen)).toFixed(2));
        return { okCount, total, details: d };
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function buildTable(title, dets, total, max) {
        let h = `<h2>${title}</h2>
                <table class="section-table">
                  <thead>
                    <tr>
                      <th>Frage</th>
                      <th>Ihre Antwort</th>
                      <th>Richtige Antwort</th>
                      <th>Ergebnis</th>
                      <th>Punkte</th>
                    </tr>
                  </thead>
                  <tbody>`;
        
        dets.forEach(x => {
          h += `<tr>
                  <td>${x.frage}</td>
                  <td>${escapeHtml(x.user)}</td>
                  <td>${escapeHtml(x.correct)}</td>
                  <td>${x.richtig ? '✔️' : '✖️'}</td>
                  <td>${x.punkte}</td>
                </tr>`;
        });
        
        h += `</tbody>
              </table>
              <div class="small-muted">Teilpunkte: ${total.toFixed(2)} / ${max}</div>`;
        return h;
      }

      function renderResults() {
        const st = readExamResults() || { hoeren: {}, lesen: {}, schreiben: {} };
        const h = gradeHoeren(st.hoeren || {});
        const l = gradeLesen(st.lesen || {});
        const details = document.getElementById('details-ergebnisse');
        const tiles = document.getElementById('topTiles-ergebnisse');
        const sScoreRaw = localStorage.getItem('schreibenScore');
        const sScore = sScoreRaw ? Number(sScoreRaw) : 0; // Default score is now 0

        details.innerHTML = '';
        tiles.innerHTML = '';

        const tL = `<div class="results-tile">
                    <h3>Lesen</h3>
                    <div class="score">${l.total.toFixed(2)} / ${CONFIG.totals.lesen} Punkte</div>
                    <div class="small-muted">(${(l.total / CONFIG.totals.lesen * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tH = `<div class="results-tile">
                    <h3>Hören</h3>
                    <div class="score">${h.total.toFixed(2)} / ${CONFIG.totals.hoeren} Punkte</div>
                    <div class="small-muted">(${(h.total / CONFIG.totals.hoeren * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tS = `<div class="results-tile">
                    <h3>Schreiben</h3>
                    <div class="score" id="schreibenScoreDisplay">${sScore.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte</div>
                    <div class="small-muted">Manuelle Eingabe</div>
                  </div>`;
                  
        tiles.innerHTML = tL + tH + tS;

        details.innerHTML += buildTable('Hören — Detail', h.details, h.total, CONFIG.totals.hoeren);
        details.innerHTML += buildTable('Lesen — Detail', l.details, l.total, CONFIG.totals.lesen);

        let sHtml = '<h2>Schreiben — Ergebnis (manuell)</h2>';
        const txt = st.schreiben.content ? escapeHtml(st.schreiben.content) : '<span class="small-muted">Kein Text gefunden.</span>';
        const wc = st.schreiben.wordCount || '-';
        
        sHtml += `<div class="small-muted">Wörter: ${wc}</div>
                <div style="margin-top:10px;padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ff;min-height:80px">${txt}</div>
                <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                  Punkte (0–45): 
                  <input id="sInput" type="number" min="0" max="45" step="0.5" value="${sScore}"> 
                  <button id="saveS" class="results-btn">Speichern</button>
                </div>`;
                
        details.innerHTML += sHtml;

        const total = (l.total + h.total + sScore).toFixed(2);
        const percent = ((total / CONFIG.totals.gesamt) * 100).toFixed(2);
        
        document.getElementById('finalSummary-ergebnisse').innerHTML = `
          <div class="left">
            Gesamtpunktzahl: <strong>${total}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
            <span class="small-muted">Lesen + Hören + Schreiben</span>
          </div>
          <div class="right">
            Prozentsatz: <strong>${percent} %</strong>
          </div>`;

        document.getElementById('saveS').onclick = () => {
          const v = Number(document.getElementById('sInput').value) || 0;
          localStorage.setItem('schreibenScore', v);
          document.getElementById('schreibenScoreDisplay').textContent = `${v.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte`;
          
          const newTotal = (l.total + h.total + v).toFixed(2);
          const newPercent = ((newTotal / CONFIG.totals.gesamt) * 100).toFixed(2);
          
          document.getElementById('finalSummary-ergebnisse').innerHTML = `
            <div class="left">
              Gesamtpunktzahl: <strong>${newTotal}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
              <span class="small-muted">Lesen + Hören + Schreiben</span>
            </div>
            <div class="right">
              Prozentsatz: <strong>${newPercent} %</strong>
            </div>`;
        };
      }

      document.getElementById('calcBtn-ergebnisse').onclick = () => renderResults();
      document.getElementById('backBtn-ergebnisse').onclick = (e) => {
        e.preventDefault();
        showPage('start-page');
      };
      
      // Initialize results on page load
      renderResults();
    }
  </script>
</body>
</html>