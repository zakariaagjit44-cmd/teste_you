<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deutsch B2 Pr√ºfung - Komplett</title>
  <style>
    /* ===== GLOBAL STYLES ===== */
    :root {
      --primary-color: #1e3a5f;
      --secondary-color: #2c5282;
      --accent-color: #4da6ff;
      --light-color: #ebf8ff;
      --text-color: #2d3748;
      --white: #ffffff;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: var(--white);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    button {
      cursor: pointer;
    }
    
    /* ===== START PAGE STYLES ===== */
    .start-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 20px;
      min-height: 100vh;
    }
    
    .start-content {
      max-width: 600px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logo {
      margin-bottom: 20px;
    }
    
    .logo-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 18px;
      margin-bottom: 30px;
      opacity: 0.9;
    }
    
    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      color: var(--text-color);
    }
    
    .card h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .card p {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    select {
      width: 100%;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      border: 2px solid var(--accent-color);
      outline: none;
      background-color: var(--white);
      color: var(--text-color);
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }
    
    .timer-container {
      margin: 25px 0;
    }
    
    .timer-label {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .timer {
      font-size: 48px;
      font-weight: 700;
      color: var(--accent-color);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .progress-bar {
      height: 8px;
      width: 100%;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress {
      height: 100%;
      width: 100%;
      background-color: var(--accent-color);
      border-radius: 4px;
      transform: scaleX(1);
      transform-origin: left;
      transition: transform 1s linear;
    }
    
    .info-text {
      font-size: 14px;
      margin-top: 20px;
      opacity: 0.8;
    }
    
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      background-color: var(--accent-color);
      color: white;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn:hover {
      background-color: #3399ff;
    }
    
    /* ===== EXAM PAGE STYLES ===== */
    .exam-body {
      background: #f5f5f5;
      color: #333;
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Header Styles */
    header.topbar {
      background: #1e3a5f;
      color: #fff;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      min-height: 80px;
    }

    .brand {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .brand .logo {
      width: 80px;
      height: 40px;
      background: #e74c3c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 18px;
    }

    .meta .main-title {
      font-weight: 800;
      font-size: 18px;
    }

    .meta .sub-title {
      font-size: 13px;
      opacity: 0.9;
    }

    .timer {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      margin: 0 20px;
    }

    .buttons-grid {
      display: grid;
      grid-template-columns: repeat(2, auto);
      gap: 10px 20px;
    }

    .exam-btn {
      padding: 12px 20px;
      border-radius: 6px;
      border: none;
      background: #4da6ff;
      color: white;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
      min-width: 150px;
      text-align: center;
    }

    .exam-btn:hover {
      background: #336fbf;
    }
    
    .exam-btn.save {
      background: #4da6ff;
      color: #000;
    }
    
    .exam-btn.save:hover {
      background: #3399ff;
    }
    
    .exam-btn.submit {
      background: #4da6ff;
    }
    
    .exam-btn.submit:hover {
      background: #3399ff;
    }
    
    .exam-btn.result {
      background: #4da6ff;
    }
    
    .exam-btn.result:hover {
      background: #3399ff;
    }
    
    .exam-btn.next {
      background: #4da6ff;
      color: #fff;
    }
    
    .exam-btn.next:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset {
      background: #4da6ff;
    }
    
    .exam-btn.reset:hover {
      background: #3399ff;
    }
    
    .exam-btn.reset-section {
      background: #d35400;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
    }
    
    .exam-btn.reset-section:hover {
      background: #e67e22;
    }
    
    .exam-btn.no-match {
      background: #95a5a6;
      font-size: 12px;
      padding: 6px 10px;
      min-width: auto;
      margin-top: 5px;
    }
    
    .exam-btn.no-match:hover {
      background: #7f8c8d;
    }
    
    .exam-btn.no-match.selected {
      background: #e74c3c;
    }
    
    /* Top Tiles */
    .top-tiles {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 8px 12px;
      background: #1e3a5f;
      border-bottom: 1px solid #0f223a;
    }
    
    .tile {
      flex: 1;
      max-width: 180px;
      text-align: center;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #3b4a63;
      color: #fff;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    
    .tile:hover {
      background: #4a5b78;
    }
    
    .tile.active {
      background: #ffffff;
      color: #000;
      border-color: #bbb;
    }
    
    .tile.done {
      background: #2ecc71;
      color: #fff;
      border-color: #27ae60;
    }
    
    .tile.done::after {
      content: " ‚úÖ";
      margin-left: 5px;
    }
    
    .tile .points {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 11px;
      margin-top: 4px;
    }
    
    .tile.active .points {
      background: #e9eefc;
      color: #2c3e50;
    }
    
    /* Container Styles */
    .container {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-full {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .container-split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      max-width: 1200px;
      margin: 12px auto;
    }
    
    .left-panel {
      background: white;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .left-panel .passage {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.8;
    }
    
    .left-panel h2 {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .right-panel {
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 76vh;
      overflow: auto;
    }
    
    .main-panel {
      background: white;
      border-radius: 8px;
      padding: 25px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.06);
      max-height: 76vh;
      overflow: auto;
    }
    
    .panel-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1e3a5f;
      font-weight: 700;
    }
    
    /* Question Styles */
    .question-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .question-body {
      margin-top: 8px;
    }
    
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .option {
      background: #fbfdff;
      border: 1px solid #e1e8f6;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .option:hover {
      background: #f0f6ff;
    }
    
    .option.selected {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .option .radio {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #cfdff6;
      background: #fff;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .option.selected .radio {
      background: #3498db;
      border-color: #3498db;
      box-shadow: inset 0 -3px 0 rgba(0,0,0,0.05);
    }
    
    .text-container {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
      position: relative;
      min-height: 120px;
    }
    
    .text-container:hover {
      background: #f0f6ff;
    }
    
    .text-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #2c3e50;
    }
    
    .text-content {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    .title-slot {
      min-height: 40px;
      margin-top: 10px;
      padding: 8px;
      border: 2px dashed #c8d9f6;
      border-radius: 6px;
      background: #f8fbff;
    }
    
    .title-slot.has-title {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .title-slot.has-x {
      background: #f8d7da;
      border-color: #e74c3c;
      color: #c0392b;
      font-weight: bold;
    }
    
    .headings-bank {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 0;
    }
    
    .heading-item {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 8px;
      background: #f8fbff;
      cursor: grab;
    }
    
    .heading-item:hover {
      background: #e9f0ff;
    }
    
    .heading-item.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .result-correct {
      color: #27ae60;
      font-weight: bold;
    }
    
    .result-incorrect {
      color: #c0392b;
      font-weight: bold;
    }
    
    .result-item {
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .instructions {
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 15px;
      font-size: 15px;
      color: #2c3e50;
    }
    
    .all-questions {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .question-block {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .texts-list, .situations-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .text-item, .situation-item {
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .text-letter {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .situation-number {
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 8px;
    }
    
    .fill-blank-container {
      margin: 20px 0;
    }
    
    .blank-word {
      display: inline-block;
      min-width: 120px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      cursor: pointer;
      position: relative;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
    }
    
    .blank-word.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .options-popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 100;
      min-width: 150px;
    }
    
    .option-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f4fb;
    }
    
    .option-item:hover {
      background: #f0f6ff;
    }
    
    .option-item:last-child {
      border-bottom: none;
    }
    
    .horizontal-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .option-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .option-number {
      font-weight: bold;
      color: #2c3e50;
      min-width: 30px;
    }
    
    .option-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .option-btn {
      padding: 8px 16px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .option-btn:hover {
      background: #e9f0ff;
    }
    
    .option-btn.selected {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    
    .word-bank-vertical {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .bank-word-vertical {
      padding: 10px;
      border: 1px solid #dbe7fb;
      border-radius: 6px;
      background: #f8fbff;
      text-align: center;
      cursor: grab;
    }
    
    .bank-word-vertical.used {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
    }
    
    .blank-slot {
      display: inline-block;
      min-width: 100px;
      padding: 4px 8px;
      margin: 0 6px;
      background: #fff;
      min-height: 30px;
      vertical-align: middle;
      border: 1px solid #dbe7fb;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .blank-slot.has-answer {
      background: #e8fbe9;
      border-color: #2ecc71;
    }
    
    .footer-buttons {
      display: flex;
      gap: 10px;
    }
    
    .situation-item.used {
      opacity: 0.7;
      cursor: not-allowed;
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #333;
    }
    
    /* Listening Section Styles */
    .listening-task {
      margin-bottom: 10px;
    }
    
    .true-false-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .true-false-table th {
      background: #3498db;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
    }
    
    .true-false-table td {
      padding: 15px;
      border-bottom: 1px solid #e1e8f6;
      vertical-align: top;
    }
    
    .true-false-table tr:nth-child(even) {
      background: #f8f9fa;
    }
    
    .true-false-table tr:hover {
      background: #e3f2fd;
    }
    
    .answer-options {
      display: flex;
      gap: 25px;
    }
    
    .answer-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 10px 15px;
      border-radius: 4px;
      transition: background 0.2s;
      font-weight: 500;
    }
    
    .answer-option:hover {
      background: #e3f2fd;
    }
    
    .answer-option input {
      margin: 0;
      transform: scale(1.2);
    }

    .correct-answer {
      background: #d4edda !important;
      border-left: 4px solid #28a745;
    }
    
    .incorrect-answer {
      background: #f8d7da !important;
      border-left: 4px solid #dc3545;
    }
    
    /* Writing Section Styles */
    .writing-task {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e1e8f6;
      border-radius: 8px;
      background: #fbfdff;
    }
    
    .writing-prompt {
      font-size: 14px;
      color: #2c3e50;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .writing-requirements {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      margin-bottom: 15px;
    }
    
    .writing-requirements h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
    }
    
    .writing-requirements ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .writing-requirements li {
      margin-bottom: 5px;
      color: #2c3e50;
    }
    
    .writing-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .writing-textarea {
      flex: 1;
      min-height: 500px;
      padding: 15px;
      border: 2px solid #e1e8f6;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    
    .writing-textarea:focus {
      outline: none;
      border-color: #3498db;
    }
    
    .word-counter {
      margin-top: 10px;
      text-align: right;
      font-size: 13px;
      color: #7f8c8d;
      padding: 8px 0;
    }
    
    .word-counter .count {
      font-weight: bold;
      color: #2c3e50;
    }
    
    /* Results Page Styles */
    .results-body {
      background: #f7fafc;
      color: #0f1724;
      line-height: 1.6;
    }
    
    .results-header {
      background: #1e3a5f;
      color: #fff;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .results-logo {
      background: #fff;
      color: #1e3a5f;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 800;
    }
    
    .results-title {
      font-size: 18px;
      font-weight: 700;
    }
    
    .results-container {
      max-width: 1100px;
      margin: 22px auto;
      padding: 20px;
    }
    
    .results-tiles {
      display: flex;
      gap: 12px;
      margin: 18px 0;
    }
    
    .results-tile {
      flex: 1;
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
      border-left: 6px solid #1e3a5f;
    }
    
    .results-tile h3 {
      margin: 0;
      font-size: 16px;
      color: #1e3a5f;
    }
    
    .results-tile .score {
      font-size: 20px;
      font-weight: 800;
      margin-top: 8px;
    }
    
    .section-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    
    .section-table th,
    .section-table td {
      padding: 8px;
      border-bottom: 1px solid #e6eef8;
      text-align: left;
      font-size: 14px;
    }
    
    .summary {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .summary .left {
      font-weight: 700;
    }
    
    .summary .right {
      text-align: right;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      margin-top: 18px;
    }
    
    .results-btn {
      background: #4da6ff;
      border: none;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .results-btn:hover {
      background: #3a8ce0;
    }
    
    .button-like {
      text-decoration: none;
    }
    
    .small-muted {
      color: #6b7280;
      font-size: 13px;
    }
    
    input[type="number"] {
      width: 90px;
      padding: 8px;
      border: 1px solid #d7e6fb;
      border-radius: 6px;
    }
    
    .note {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    
    /* Footer */
    footer.controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border-top: 1px solid #e1e8f6;
      margin-top: 20px;
    }
    
    .status {
      font-size: 14px;
      color: #7f8c8d;
    }
    
    .ghost {
      background: transparent;
      border: 2px solid #2c3e50;
      color: #2c3e50;
    }
    
    .ghost:hover {
      background: #2c3e50;
      color: white;
    }

    /* Responsive Styles */
    @media (max-width: 980px) {
      .container {
        grid-template-columns: 1fr;
        padding: 12px;
      }
      
      .container-split {
        grid-template-columns: 1fr;
      }
      
      .right-panel {
        order: 2;
      }
      
      .top-tiles {
        padding-left: 8px;
        padding-right: 8px;
      }
      
      header.topbar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .buttons-grid {
        grid-template-columns: 1fr;
      }
      
      .answer-options {
        flex-direction: column;
        gap: 10px;
      }
      
      footer.controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .results-tiles {
        flex-direction: column;
      }
      
      .summary {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .controls {
        flex-direction: column;
      }
    }
    
    @media (max-width: 600px) {
      .start-content {
        padding: 25px 20px;
      }
      
      h1 {
        font-size: 28px;
      }
      
      .card {
        padding: 20px 15px;
      }
    }
  </style>
</head>
<body id="body">
  <!-- Start Page -->
  <div id="start-page" class="start-container">
    <div class="start-content">
      <div class="logo">
        <div class="logo-icon">üìù</div>
        <h1>Deutsch B2 Pr√ºfung</h1>
        <div class="subtitle">Bereiten Sie sich auf Ihre Pr√ºfung vor</div>
      </div>
      <div class="card">
        <h2>Pr√ºfungsbereich ausw√§hlen</h2>
        <p>W√§hlen Sie bitte den Bereich aus, den Sie √ºben m√∂chten. Die Pr√ºfung startet automatisch in <span id="time-display">30</span> Sekunden.</p>
        <select id="sectionSelect">
          <option value="lesen">Lesen</option>
          <option value="hoeren">H√∂ren</option>
          <option value="schreiben">Schreiben</option>
        </select>
        <div class="button-container">
          <button id="cancelBtn" class="btn">Abbrechen</button>
          <button id="startBtn" class="btn">Jetzt starten</button>
        </div>
      </div>
      <div class="timer-container">
        <div class="timer-label">Die Pr√ºfung startet in:</div>
        <div class="timer" id="countdown">30</div>
        <div class="progress-bar">
          <div class="progress" id="progress"></div>
        </div>
      </div>
      <div class="info-text">Stellen Sie sicher, dass Sie in einer ruhigen Umgebung sind und gen√ºgend Zeit haben.</div>
    </div>
  </div>

  <!-- Lesen Page -->
  <div id="lesen-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (√úbung)</div>
          <div class="sub-title">Lesen ‚Äî Testbeispiel</div>
        </div>
      </div>

      <div id="timer-lesen" class="timer" aria-live="polite">Verbleibende Zeit: 90:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-lesen" class="exam-btn reset">üîÑ Von neu beginnen</button>
        <button id="saveBtn-lesen" class="exam-btn save">üìã Speichern</button>
        <button id="resultBtn-lesen" class="exam-btn result">üìä Ergebnis</button>
        <button id="submitBtn-lesen" class="exam-btn submit">üèÅ Abgabe</button>
        <button class="exam-btn next" id="nextBtn-lesen">‚û°Ô∏è N√§chste Pr√ºfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-lesen" role="navigation" aria-label="Sections overview"></div>

    <div class="container">
      <main class="left-panel" id="leftPanel-lesen">
        <div class="passage" id="passage-lesen">
          <h2 id="passageTitle-lesen">Aufgabe</h2>
          <div id="passageContent-lesen"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-lesen" aria-labelledby="questionTitle-lesen">
        <div class="question-head">
          <div>
            <div id="sectionName-lesen" style="font-weight:800"></div>
            <div id="questionTitle-lesen" style="font-size:13px;color:#55607a">Frage</div>
          </div>
          <button id="resetSectionBtn-lesen" class="exam-btn reset-section" style="display:none;">Teil zur√ºcksetzen</button>
        </div>
        <div class="question-body" id="questionBody-lesen"></div>
        <div id="headingsBankContainer-lesen"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-lesen" class="exam-btn ghost">Zur√ºck</button>
        <button id="nextBtn-lesen" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-lesen">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- H√∂ren Page -->
  <div id="hoeren-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (√úbung)</div>
          <div class="sub-title">H√∂rverstehen ‚Äî Testbeispiel</div>
        </div>
      </div>

      <div id="timer-hoeren" class="timer" aria-live="polite">Verbleibende Zeit: 17:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-hoeren" class="exam-btn reset">üîÑ Von neu beginnen</button>
        <button id="saveBtn-hoeren" class="exam-btn save">üìã Speichern</button>
        <button id="resultBtn-hoeren" class="exam-btn result">üìä Ergebnis</button>
        <button id="submitBtn-hoeren" class="exam-btn submit">üèÅ Abgabe</button>
        <button class="exam-btn next" id="nextBtn-hoeren">‚û°Ô∏è N√§chste Pr√ºfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-hoeren" role="navigation" aria-label="Sections overview"></div>

    <div class="container-full">
      <main class="main-panel" id="mainPanel-hoeren">
        <div id="contentContainer-hoeren"></div>
      </main>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-hoeren" class="exam-btn ghost">Zur√ºck</button>
        <button id="nextBtn-hoeren" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-hoeren">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Schreiben Page -->
  <div id="schreiben-page" class="exam-page" style="display: none;">
    <header class="topbar" role="banner">
      <div class="brand">
        <div class="logo">telc</div>
        <div class="meta">
          <div class="main-title">Deutsch - B2 (√úbung)</div>
          <div class="sub-title">Schreiben ‚Äî Testbeispiel</div>
        </div>
      </div>

      <div id="timer-schreiben" class="timer" aria-live="polite">Verbleibende Zeit: 30:00</div>

      <div class="buttons-grid">
        <button id="resetBtn-schreiben" class="exam-btn reset">üîÑ Von neu beginnen</button>
        <button id="saveBtn-schreiben" class="exam-btn save">üìã Speichern</button>
        <button id="resultBtn-schreiben" class="exam-btn result">üìä Ergebnis</button>
        <button id="submitBtn-schreiben" class="exam-btn submit">üèÅ Abgabe</button>
        <button class="exam-btn next" id="nextBtn-schreiben">‚û°Ô∏è N√§chste Pr√ºfung</button>
      </div>
    </header>

    <div class="top-tiles" id="topTiles-schreiben" role="navigation" aria-label="Sections overview"></div>

    <div class="container-split">
      <main class="left-panel" id="leftPanel-schreiben">
        <div class="passage" id="passage-schreiben">
          <h2 id="passageTitle-schreiben">Aufgabe</h2>
          <div id="passageContent-schreiben"></div>
        </div>
      </main>

      <aside class="right-panel" id="rightPanel-schreiben">
        <div id="writingContainer-schreiben"></div>
      </aside>
    </div>

    <footer class="controls">
      <div class="footer-buttons">
        <button id="prevBtn-schreiben" class="exam-btn ghost">Zur√ºck</button>
        <button id="nextBtn-schreiben" class="exam-btn ghost">Weiter</button>
      </div>
      <div class="status"><span id="statusText-schreiben">Nicht gespeichert</span></div>
    </footer>
  </div>

  <!-- Ergebnisse Page -->
  <div id="ergebnisse-page" class="results-page" style="display: none;">
    <header class="results-header">
      <div class="results-logo">telc</div>
      <div class="results-title">Gesamtergebnis ‚Äî Deutsch B2</div>
    </header>

    <div class="results-container">
      <div class="results-tiles" id="topTiles-ergebnisse"></div>
      <div id="details-ergebnisse"></div>
      <div class="summary" id="finalSummary-ergebnisse"></div>
      <div class="controls">
        <a class="button-like" href="#" id="backBtn-ergebnisse">
          <button class="results-btn">üîÅ Zur√ºck zur Startseite</button>
        </a>
        <button id="calcBtn-ergebnisse" class="results-btn">‚úÖ Ergebnisse anzeigen</button>
      </div>
      <div class="note">Hinweis: Schreiben (45 Punkte) wird manuell eingegeben, falls nicht automatisch vorhanden.</div>
    </div>
  </div>

  <script>
    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      // Hide all pages
      document.getElementById('start-page').style.display = 'none';
      document.getElementById('lesen-page').style.display = 'none';
      document.getElementById('hoeren-page').style.display = 'none';
      document.getElementById('schreiben-page').style.display = 'none';
      document.getElementById('ergebnisse-page').style.display = 'none';
      
      // Change body class based on page
      document.getElementById('body').className = '';
      if (pageId === 'ergebnisse-page') {
        document.getElementById('body').className = 'results-body';
      } else if (pageId !== 'start-page') {
        document.getElementById('body').className = 'exam-body';
      }
      
      // Show selected page
      document.getElementById(pageId).style.display = 'block';
      
      // Initialize the page if needed
      if (pageId === 'lesen-page' && typeof initLesenPage === 'function') {
        initLesenPage();
      } else if (pageId === 'hoeren-page' && typeof initHoerenPage === 'function') {
        initHoerenPage();
      } else if (pageId === 'schreiben-page' && typeof initSchreibenPage === 'function') {
        initSchreibenPage();
      } else if (pageId === 'ergebnisse-page' && typeof initErgebnissePage === 'function') {
        initErgebnissePage();
      }
    }

    // ===== START PAGE FUNCTIONALITY =====
    let initialCounter = 30;
    let counter = initialCounter;
    let countdownInterval;
    let countdownRunning = false;
    let examStarted = false;
    const timerEl = document.getElementById("countdown");
    const timeDisplayEl = document.getElementById("time-display");
    const progressEl = document.getElementById("progress");
    const selectEl = document.getElementById("sectionSelect");
    const startBtn = document.getElementById("startBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    function startCountdown() {
      // prevent double-starts or starting after exam already began
      if (countdownRunning || examStarted) return;
      countdownRunning = true;
      // disable start button while counting
      try { startBtn.disabled = true; startBtn.setAttribute('aria-disabled','true'); } catch(e){}
      // reset counter & UI
      counter = initialCounter;
      timerEl.textContent = counter;
      timeDisplayEl.textContent = counter;
      progressEl.style.transform = "scaleX(0)";
      timerEl.style.color = "";

      countdownInterval = setInterval(() => {
        counter--;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
        const progressValue = (initialCounter - counter) / initialCounter;
        progressEl.style.transform = `scaleX(${progressValue})`;
        if (counter <= 0) {
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRunning = false;
          progressEl.style.transform = "scaleX(1)";
          // ensure exam starts only once
          if (!examStarted) {
            examStarted = true;
            startExam();
          }
          // safety: re-enable start button (page usually navigates away)
          try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
        }
      }, 1000);
    }

    function stopCountdown(reset = true) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownRunning = false;
      try { startBtn.disabled = false; startBtn.removeAttribute('aria-disabled'); } catch(e){}
      progressEl.style.transform = "scaleX(0)";
      if (reset) {
        counter = initialCounter;
        timerEl.textContent = counter;
        timeDisplayEl.textContent = counter;
      } else {
        timerEl.textContent = "Gestoppt";
      }
    }

    function startExam() {
      // guard to ensure startExam is triggered once
      if (!examStarted) examStarted = true;
      const selectedSection = selectEl.value;
      if (selectedSection === 'lesen') {
        showPage('lesen-page');
      } else if (selectedSection === 'hoeren') {
        showPage('hoeren-page');
      } else if (selectedSection === 'schreiben') {
        showPage('schreiben-page');
      }
    }

    // wire buttons: start will now start the countdown (not the exam directly)
    startBtn.addEventListener('click', startCountdown);

    cancelBtn.addEventListener('click', () => {
      stopCountdown(true);
      timerEl.textContent = "Abgebrochen";
      timerEl.style.color = "#e53e3e";
    });

    // NOTE: removed automatic startCountdown() on page load to prevent the timer starting twice

    // ===== LESEN PAGE FUNCTIONALITY =====
    function initLesenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-001",
        durationSec: 90 * 60,
        sections: [
          { 
            id: "s1", 
            title: "Leseverstehen, Teil 1", 
            points: 25,
            passageTitle: "Aufgabe: Ziehen Sie die passenden √úberschriften auf die Texte.",
            passage: "",
            questions: [],
            texts: [
              {
                id: "text1",
                content: "Marina Lux hat ein Hobby, mit dem sie im Kreis ihrer Freundinnen ziemlich allein steht: Sie programmiert in ihrer Freizeit. 'Mich hat immer schon interessiert, wie Computerprogramme eigentlich funktionieren', sagt die 17-J√§hrige. Au√üerdem habe sie gro√üen Spa√ü an logischem Denken. Ihr Informatiklehrer erz√§hlte ihr von einem Workshop in Berlin: Bei 'Jugend programmiert' traf Marina von letztem Freitag bis Sonntag mit gleichgesinnten Jungen und M√§dchen zwischen zw√∂lf und 18 Jahren zusammen, um gemeinsam Programme zu entwickeln. Dabei standen ihnen erfahrene Informatiker zur Seite. In 15 Gruppen entwickelten die jungen Nachwuchsprogrammierer ihre Projekte. Eine Jury verlieh Preise in vier Kategorien. Bewertet wurden die originellste Idee, die sauberste Umsetzung, die beste Pr√§sentation und die gr√∂√üte Relevanz f√ºr die Gesellschaft. Marinas Gruppe erhielt zwar keinen Preis, aber das Wochenende hat sich f√ºr sie auf jeden Fall gelohnt. Sie hat zwei M√§dchen kennengelernt, mit denen sie auch in Zukunft gemeinsam programmieren m√∂chte. Zu wissen, dass sie nicht allein ist mit ihrem Hobby, das ist f√ºr sie ein besonders wichtiges Ergebnis dieses Wochenendes, meint Marina.",
                correctAnswer: "g"
              },
              {
                id: "text2", 
                content: "'Jugend forscht' ist ein bundesweiter Nachwuchswettbewerb f√ºr junge Menschen bis zum Alter von 21 Jahren, bei dem besondere Leistungen in Mathematik, Technik, Naturwissenschaften und Informatik ausgezeichnet werden. Neben Geldpreisen werden auch einige Sonderpreise vergeben, die bei den Jugendlichen ganz besonders begehrt sind. Dazu geh√∂rt die Teilnahme an internationalen Wettbewerben, bei denen die jungen Forscher Fachleuten aus aller Welt ihre Projekte vorstellen k√∂nnen. Auch Einladungen zu Studienreisen und Kongressen im Ausland sind f√ºr viele Teilnehmer besonders attraktiv. Im Rahmen von 'Jugend forscht' wird sogar eine Reise zu Nobelpreisverleihung in Stockholm angeboten. Im Inland haben die Preistr√§ger die M√∂glichkeit, ein langes Praktikum an angesehenen Forschungsinstituten und bei wichtigen Unternehmen zu absolvieren. Dort bekommen die Jugendlichen im Arbeitsalltag eine gute Vorstellung davon, wie Forschungsarbeit funktioniert. Zus√§tzlich gibt es auch Abonnements f√ºr technische und naturwissenschaftliche Fachzeitschriften zu gewinnen. Auch Schulen und Projektbetreuer k√∂nnen teilnehmen. Bei diesem Wettbewerb haben junge Menschen die M√∂glichkeit, wertvolle Erfahrungen mit Forschungsprojekten zusammen. Mitmachen lohnt sich auf jeden Fall.",
                correctAnswer: "h"
              },
              {
                id: "text3",
                content: "Die Industriellenvereinigung beklagt in einer j√ºngsten Pressemitteilung den deutlichen Mangel an Fachkr√§ften in der Naturwissenschaften und den technischen Berufen. Dieser Fachkr√§ftemangel sei besonders ausgepr√§gt in den Bereichen Maschinenbau, Elektrotechnik, Werkstoffwissenschaften und Verfahrenstechnik, hei√üt es in dem Papier. Um dem entgegenzusteuern, ruft die Industriellenvereinigung unter anderem dazu auf, insbesondere M√§dchen und junge Frauen f√ºr solche Berufe zu gewinnen. Die Berufsorientierung der Schulen m√ºssen noch gezielter auf die vielf√§ltigen und interessanten Themenfelder sowie die guten Zukunftschancen technischer Berufe hinweisen. Erfolgreiche Frauen aus diesen Bereichen sollten sich zudem verst√§rkt als Vorbilder f√ºr Sch√ºlerInnen pr√§sentieren. In diesem Zusammenhang wird in der Pressemitteilung auch an die M√∂glichkeit erinnert, am bevorstehenden bundesweiten M√§dchenzukunftstag 'Girls' Day' an den Standorten namhafter Firmen Einblicke in den Arbeitsalltag in technischen Berufen zu bekommen. Die Industriellenvereinigung fordert die Unternehmen und Organisationen auf, ihre T√ºren f√ºr potenzielle Talente zu √∂ffnen und sich Fachkr√§fte f√ºr die Zukunft zu sichern.",
                correctAnswer: "d"
              },
              {
                id: "text4",
                content: "Im Kulturzentrum war gestern Abend Tobias Meyer zu Gast. Die Organisatoren hatten den bekannten Autor zahlreicher Sachb√ºcher √ºber Erziehung und Bildung eingeladen, zum Thema Berufsorientierung zu sprechen. In seinem Vortrag ging Meyer auf zwei wesentliche Aspekte von Berufsorientierung ein. Zum einen versteht er Berufsorientierung als eine Entwicklung, die eng mit dem pers√∂nlichen und sozialen Beziehungen eines jungen Menschen zusammenh√§ngt. Die Orientierung auf einen Beruf hin wertet er als einen Teil der Pers√∂nlichkeitsentwicklung. In engem Zusammenhang damit sieht er die Berufsvorbilder, an denen sich Jugendliche orientieren: Diese h√§ngen ebenso wie die Erwartungen, die an einen Beruf gestellt w√ºrden, stark von der sozialen Umgebung ab. Zudem spielten lokale wirtschaftliche Umst√§nde eine Rolle bei der Berufsorientierung. Meyer zeigte anhand konkreter Beispiele, wie gro√üe Unternehmen vor Ort die Berufswahl junger Menschen entscheidend beeinflussen k√∂nnen. Anschlie√üend ging Meyer auf einen zweiten wesentlichen Aspekt, n√§mlich Berufsorientierung im Rahmen der Schulen, ein. Hier k√∂nnten entscheidende Impulse gesetzt werden, indem Talente und St√§rken erkannt und bereits sehr fr√ºh gef√∂rdert w√ºrden.",
                correctAnswer: "i"
              },
              {
                id: "text5",
                content: "Wie eine repr√§sentative Umfrage unter Studenten k√ºrzlich zeigte, erfreut sich die Automobilindustrie nach wie vor gro√üer Beliebtheit bei Studierenden der Fachgebiete Wirtschaft und Technik. Gefragt nach der den f√ºnf attraktivsten zuk√ºnftigen Arbeitgebern, namten Wirtschaftsstudenten vier f√ºhrende Automobilkonzerne und eine InternetSuchmaschine; k√ºnftige Ingenieure nannten sogar ausschlie√ülich Automobilunternehmen. Auch f√ºr Studenten der Informatik gewinnt die Automobilindustrie zunehmend an Attraktivit√§t - wenig verwunderlich angesichts der rasch zunehmenden Bedeutung, die der Elektronik in Fahrzeugen zukommt. Die Branche punktet bei jungen Absolventen mit vielen spannenden Themen: Wie wird die Mobilit√§t der Zukunft aussehen? Welche alternative Antriebe wird es geben? Die Automobilindustrie bietet viel Raum f√ºr Innovationen und somit gute Chancen f√ºr motivierte Berufseinsteiger. Doch ausschlaggebend sind nicht nur solide Berufsaussichten. Wie die Befragung ergab, spielt auch der emotionalale Faktor eine Rolle: Viele Studierende sind einfach begeistert vom Thema Auto.",
                correctAnswer: "b"
              }
            ],
            headings: [
              {id: "a", text: "Immer mehr Jugendliche werden Programmierer"},
              {id: "b", text: "Studienabsolventen technischer F√§cher sehen ihre Zukunft meist in der Fahrzeugbranche"},
              {id: "c", text: "Diskussion √ºber schulische Berufsorientierung"},
              {id: "d", text: "Mehr Bem√ºhungen um weiblichen Nachwuchs gefordert"},
              {id: "e", text: "Immer mehr Frauen ergreifen technische Berufe"},
              {id: "f", text: "Immer mehr Jugendliche werden Programmierer"},
              {id: "g", text: "F√∂rderwochenende f√ºr junge Softwareentwickler"},
              {id: "h", text: "Spannende Gewinne f√ºr wissenschaftliche Nachwuchstalente"},
              {id: "i", text: "Berufswahl: Jugendliche werden stark von ihrem gesellschaftlichen Umfeld gepr√§gt"},
              {id: "j", text: "Verleihung des Jugendnobelpreises in Stockholm"}
            ]
          },
          { 
            id: "s2", 
            title: "Leseverstehen, Teil 2", 
            points: 25,
            passageTitle: "Familiengl√ºck oder Generationskonflikte?",
            passage: `In der √∂ffentlichen Beschreibung kennt man die Familie oft als Problemzone. Bestsellerautoren suggerieren der √ñffentlichkeit, Eltern seien zum Erziehen heute kam noch in der Lage; Berichte √ºber steigende Scheidungsraten, Verwahrlosung und Jugendkriminalit√§t verst√§rken ebenfalls den Eindruck, um die Familien sei es nicht gut bestellt. Tats√§chlich hat sich Erziehung in den letzten Jahrzehnten grundlegend gewandelt. In vielerlei Hinsicht allerdings eher zum Guten als zum Schlechten. Wie lebt es sich heute in der Familie? Ausgesprochen gut, in den meisten F√§llen sogar recht kuschelig. Das legen zumindest Umfragen und Statistiken √ºber die Familienwirklichkeit nahe. Sie zeigen ein erfreulich positives Bild, nach dem sich die Familie in den vergangenen Jahrzehnten sehr gut entwickelt hat. Das gilt f√ºr die materiellen Bedingungen, in denen die meisten Eltern und Kinder heute leben, wie auch f√ºr das Ansehen, das die Familie in der Gesellschaft genie√üt. Den gr√∂√üten Fortschritt habe aber das gemeinsame Zusammenleben gemacht, sagen Experten: "Es gibt kaum noch wirkliche Konflikte zwischen den Generationen."

Dass heute 67 Prozent der 16‚Äì bis 29‚ÄìJ√§hrigen angeben, sie h√§tten eine gl√ºckliche Kindheit, w√§hrend es bei den √ºber 60‚ÄìJ√§hrigen nur 50 Prozent sind, kann zwar sicher nicht nur auf den Wandel der Erziehung zur√ºckgef√ºhrt werden. Schlie√ülich war die Kindheit vieler von ihnen noch von Krieg und Not gepr√§gt, w√§hrend die J√ºngeren in Wohlstand und Sicherheit aufwuchsen. Aber fast alle Jugendlichen geben heute an, dass sie ein gutes Verh√§ltnis zu den Eltern haben. Au√üerdem orientieren sie sich stark an ihrer Familie, Gest√ºtzt unter anderem auf den emotionalen R√ºckhalt der Eltern blicken die allermeisten Jugendlichen optimistisch nach vorn. Fast 75 Prozent der Befragten w√ºrden ihre eigenen Kinder genau so erziehen, wie sie selbst erzogen wurden. Genauso viele glauben, dass man eine Familie braucht, um wirklich gl√ºcklich leben zu k√∂nnen. Die Eltern sehen es √ºbrigens kaum anders. Von ihnen berichten 74 Prozent von Harmonie, W√§rme und Geborgenheit im Zusammenlebe.

Vor 40 Jahren fanden viele Jugendliche ihre Eltern noch spielig, und Eltern konnten sich erregen √ºber die Frisuren oder den Musikgeschmack des Nachwuchses. Heute gleichen sich die Lebensstile und die Wertvorstellungen. So entspannt ist der Umgang zwischen Jung und Alt geworden, dass man es schon wieder bedenklich finden kann. Ist es denn normal, dass Kinder als wichtigstes Vorbild die eigene Mutter nennen? Selbst Oma und Opa findet nur noch jeder f√ºnfte Teenager altmodisch.

Gerade Gro√üeltern haben noch nie zuvor f√ºr ihre Enken eine so gro√üe Bedeutung. Dank besserer Gesundheit und steigender Lebenserwartung verbringen sie mehr Zeit als fr√ºher mit ihren Enkeln. Der Kontakt ist pers√∂nlicher und er h√§lt l√§nger an. Heute sieht rund ein Drittel der Jugendlichen Oma und Opa mindestens einmal pro Woche, ein weiteres Drittel telefoniert wenigstens mit ihnen.

Mit den Lebenseinstellungen wandelten sich die Erziehungsvorstellungen. Erwachsene nehmen mehr R√ºcksicht auf die Bed√ºrfnisse von Kindern. Statt eines autorit√§ren Umgangs mit den Kindern pflegen die meisten Familien den Verhandlungssitl, wie es P√§dagogen nennen. Der ist nicht selten anstrengend und wird mitunter √ºbertrieben, ist aber am Ende zielf√ºhrender als die famili√§ren Kleinkriege, die fr√ºher das Klima in vielen Familie bestimmten. Besonders V√§ter profitieren von der neuen N√§he zu ihren Kindern. Sie spielen heute h√§ufiger mit ihnen als fr√ºher oder lesen ihnen vor ‚Äì auch wenn weiterhin die M√ºtter den Gro√üteil der Familienarbeit leisten.

Das f√ºhrt zu Stress, da M√ºtter mit Kindern heute doppelt so h√§ufig berufst√§tig sind wie noch vor 40 Jahren. Trotzdem haben sie nicht weniger Zeit f√ºr ihre Kinder, weil sie den Haushalt dank moderner Technik schneller erledigen. 1990 verbrachten Eltern mit ihren unter sechsj√§hrigen S√∂hnen und T√∂chtern pro Tag vier Stunden und 52 Minuten. Heute ist es eine Dreiviertelstunde more.

Auch der Eindruck, dass Familien sich nicht mehr t√§glich um den gedeckten Tisch versammeln, um sich untereinander auszutauschen, stimmt nicht, haben Ern√§hrungsforscher ermittelt. Heute dauern die bewusst inszenierten Zusammentreffen von Jung und Alt um Suppensch√ºssel oder Nudeltopf sogar l√§nger als noch vor 20 Jahren.`,
            questions: [
              {
                id: "s2q1",
                type: "single",
                text: "Etwa die H√§lfte der Senioren √ºber 60 gibt an, dass sie",
                options: [
                  {id: "s2q1o1", text: "ihre Kinder strenger erziehen w√ºrden."},
                  {id: "s2q1o2", text: "die ge√§nderten Erziehungsmethoden begr√º√üen."},
                  {id: "s2q1o3", text: "als Kind gl√ºcklich w√§ren."}
                ],
                correctAnswer: "s2q1o3"
              },
              {
                id: "s2q2",
                type: "single", 
                text: "Die meisten Jugendlichen",
                options: [
                  {id: "s2q2o1", text: "verstehen sich mit ihren Eltern gut."},
                  {id: "s2q2o2", text: "haben keine Meinung zu Erziehungsfragen."},
                  {id: "s2q2o3", text: "denken, dass man auch ohne Familie gl√ºcklich sein kann."}
                ],
                correctAnswer: "s2q2o1"
              },
              {
                id: "s2q3",
                type: "single",
                text: "Heute gibt es zwischen Eltern und Kindern",
                options: [
                  {id: "s2q3o1", text: "Konflikte wegen unterschiedlicher Werte."},
                  {id: "s2q3o2", text: "kaum Unterschiede in der Lebensart."},
                  {id: "s2q3o3", text: "immer wieder Probleme wegen zu engen Wohnraums."}
                ],
                correctAnswer: "s2q3o2"
              },
              {
                id: "s2q4",
                type: "single",
                text: "M√ºtter haben heute mehr Zeit f√ºr ihre Kinder, weil",
                options: [
                  {id: "s2q4o1", text: "sie in der Arbeit weniger Stress haben."},
                  {id: "s2q4o2", text: "Ger√§te die Hausarbeit leichter machen."},
                  {id: "s2q4o3", text: "die Gro√üeltern ihnen Arbeit abnehmen."}
                ],
                correctAnswer: "s2q4o2"
              },
              {
                id: "s2q5", 
                type: "single",
                text: "In der √ñffentlichkeit",
                options: [
                  {id: "s2q5o1", text: "wird der Wandel in der Erziehung nicht wahrgenommen."},
                  {id: "s2q5o2", text: "ist das Thema Familie nicht interessant."},
                  {id: "s2q5o3", text: "entsteht oft ein falsches Bild der Familie."}
                ],
                correctAnswer: "s2q5o3"
              }
            ]
          },
          { 
            id: "s3", 
            title: "Leseverstehen, Teil 3", 
            points: 25,
            passageTitle: "Aufgabe: Lesen Sie die zehn Situationen (11-20) und die zw√∂lf Texte (A-L). Welcher Text passt zu welcher Situation? Sie k√∂nnen jeden Text nur einmal verwenden. Manchmal passt kein Text. W√§hlen Sie dann 'x'.",
            passage: "",
            questions:[],
            texts: [
              {id: "A", text: "Das Vorstellungsgespr√§ch ist eine wichtige H√ºrde bei der Suche nach einem Arbeitsplatz. In der Regel fangen sie mit Smalltalk an: Man redet √ºber das Wetter, den Verkehr und √Ñhnliches. Doch dabei kommt es schon auf das 'Wie?' an. Wer viel kritisiert, hat schon verloren. Bei der Vorstellung ihrer Person sollten Bewerber darauf achten, dass sie ihre F√§higkeit und den Nutzen, den ihr potentiell zuk√ºnftiger Arbeitgeber von ihnen hat, in den Vordergrund stellen, Fragen nach Gesundheit, Familienplanung, Schwangerschaft oder Geld geh√∂ren nicht ins Bewerbungsgespr√§ch. Sollten Sie dennoch gestellt werden, ist man nicht verpflichtet, diese wahrheitsgem√§√ü zu beantworten.", correctAnswer: "11"},
              {id: "B", text: "Die Postbank gibt Bewerbern um einen Ausbildungsplatz ein Thema f√ºr ein Projekt, das sie ausarbeiten und dann pr√§sentieren sollen. Nur wer diese H√ºrde nehmen kann und Engagement beweist, hat Chancen, aufgenommen zu werden. Schlie√ülich sollen die Bewerber zeigen, dass sie belastbar und entscheidungsf√§hig sind. Der Bewerber muss sich selbstst√§ndig mit dem Thema auseinandersetzen und es in der vorgegebenen Zeit bearbeiten. Die Ergebnisse werden dann in einem Assessment-Center vorgestellt und diskutiert.", correctAnswer: "12"},
              {id: "C", text: "Die Zahl der Arbeitslosen in Deutschland ist im vergangenen Monat auf den niedrigsten Stand seit 20 Jahren gesunken. Die Arbeitslosenquote liegt jetzt bei 5,8 Prozent. Das ist ein R√ºckgang um 0,3 Prozentpunkte im Vergleich zum Vormonat. Besonders erfreulich ist die Entwicklung in den neuen Bundesl√§ndern, wo die Arbeitslosigkeit st√§rker als im Westen zur√ºckgeht. Die Bundesagentur f√ºr Arbeit f√ºhrt diesen positiven Trend auf die gute Konjunktur und die gestiegene Zahl der sozialversicherungspflichtigen Besch√§ftigungsverh√§ltnisse zur√ºck.", correctAnswer: null},
              {id: "D", text: "Wenn Sie sich f√ºr eine Stelle bewerben, sollten Sie darauf achten, dass Ihre Bewerbungsunterlagen vollst√§ndig sind. Dazu geh√∂ren ein individuell gestaltetes Anschreiben, ein tabellarischer Lebenslauf, Kopien Ihrer Zeugnisse und gegebenenfalls Arbeitsproben. Das Anschreiben sollte nicht l√§nger als eine Seite sein und auf die ausgeschriebene Stelle zugeschnitten sein. Der Lebenslauf sollte l√ºckenlos sein und Ihre wichtigsten Stationen und Qualifikationen enthalten. Fehlende Unterlagen k√∂nnen dazu f√ºhren, dass Ihre Bewerbung nicht ber√ºcksichtigt wird.", correctAnswer: "13"},
              {id: "E", text: "Das Assessment-Center ist ein mehrstufiges Auswahlverfahren, bei dem mehrere Bewerber gleichzeitig gepr√ºft werden. Typische Aufgaben sind Gruppendiskussionen, Pr√§sentationen, Rollenspiele und Postkorb√ºbungen. Dabei werden nicht nur fachliche Kompetenzen, sondern auch soziale F√§higkeiten wie Teamf√§higkeit, Kommunikationsst√§rke und Stressresistenz bewertet. Die Teilnehmer sollten sich nat√ºrlich verhalten, aber auch ihre St√§rken gezielt einsetzen. Vorbereitung ist wichtig, aber Authentizit√§t ist entscheidend.", correctAnswer: "14"},
              {id: "F", text: "Die Bundesagentur f√ºr Arbeit bietet verschiedene Leistungen f√ºr Arbeitsuchende an. Dazu geh√∂ren Beratung, Vermittlung in Arbeit, F√∂rderung von Weiterbildungen und finanzielle Unterst√ºtzung. Arbeitslose k√∂nnen sich in den Arbeitsagenturen pers√∂nlich beraten lassen oder das Online-Portal der Bundesagentur nutzen. Dort finden sich auch Stellenangebote und Informationen zu Fortbildungsm√∂glichkeiten. Bei l√§ngerer Arbeitslosigkeit kann Arbeitslosengeld beantragt werden.", correctAnswer: "15"},
              {id: "G", text: "Ein Praktikum kann der Einstieg in den Beruf sein. Viele Unternehmen nutzen Praktika, um potenzielle neue Mitarbeiter kennenzulernen. F√ºr Bewerber bietet ein Praktikum die M√∂glichkeit, Berufserfahrung zu sammeln, Kontakte zu kn√ºpfen und sich f√ºr eine sp√§tere Festanstellung zu empfehlen. Wichtig ist, dass das Praktikum zum Berufswunsch passt und dass man sich w√§hrend dieser Zeit engagiert zeigt. Ein positives Praktikumszeugnis kann bei sp√§teren Bewerbungen von Vorteil sein.", correctAnswer: "16"},
              {id: "H", text: "Die Digitalisierung ver√§ndert die Arbeitswelt grundlegend. Immer mehr T√§tigkeiten werden automatisiert, neue Berufe entstehen, andere verschwinden. Arbeitnehmer m√ºssen sich kontinuierlich weiterbilden, um mit den Ver√§nderungen Schritt halten zu k√∂nnen. Flexible Arbeitszeiten, Homeoffice und virtuelle Teams werden immer h√§ufiger. Diese Entwicklung bietet neue Chancen, stellt aber auch neue Anforderungen an die Besch√§ftigten. Lebenslanges Lernen wird zur Notwendigkeit.", correctAnswer: null},
              {id: "I", text: "Bei der Vorbereitung auf ein Vorstellungsgespr√§ch ist es wichtig, sich √ºber das Unternehmen zu informieren. Dazu geh√∂ren die Unternehmensgeschichte, die Produkte oder Dienstleistungen, die Unternehmensphilosophie und die aktuellen Entwicklungen. Auch die Branche und die Wettbewerber sollten bekannt sein. Diese Informationen helfen, im Gespr√§ch kompetent aufzutreten und zu zeigen, dass man sich ernsthaft mit der Stelle auseinandergesetzt hat. Vorbereitete Fragen an den Gespr√§chspartner zeigen Interesse.", correctAnswer: "17"},
              {id: "J", text: "Die Probezeit dauert in der Regel sechs Monate. In dieser Zeit k√∂nnen sowohl Arbeitgeber als auch Arbeitnehmer das Arbeitsverh√§ltnis ohne Angabe von Gr√ºnden k√ºndigen. Die K√ºndigungsfrist betr√§gt dann zwei Wochen. Die Probezeit dient dazu, festzustellen, ob der Arbeitnehmer f√ºr die Stelle geeignet ist und ob er sich in das Unternehmen integrieren kann. Auch der Arbeitnehmer sollte pr√ºfen, ob der Job und das Unternehmen seinen Erwartungen entsprechen.", correctAnswer: "18"},
              {id: "K", text: "Weiterbildung ist in der heutigen Arbeitswelt unverzichtbar. Wer sich nicht regelm√§√üig fortbildet, riskiert, den Anschluss zu verlieren. Viele Arbeitgeber unterst√ºtzen ihre Mitarbeiter bei Weiterbildungen, sei es durch finanzielle Zusch√ºsse oder durch Freistellung. Auch f√ºr Arbeitsuchende gibt es F√∂rderm√∂glichkeiten durch die Arbeitsagentur. Wichtig ist, dass die Weiterbildung zum Beruf passt und die Karrierechancen verbessert.", correctAnswer: "19"},
              {id: "L", text: "Das Arbeitszeugnis ist ein wichtiges Dokument f√ºr jede berufliche Bewerbung. Es sollte die T√§tigkeiten und Leistungen des Arbeitnehmers beschreiben und eine Beurteilung enthalten. Formulierungen in Zeugnissen sind oft codiert. 'Stets zu unserer vollsten Zufriedenheit' ist die beste Note, w√§hrend 'zu unserer Zufriedenheit' only durchschnittlich ist. Arbeitnehmer haben einen Anspruch auf ein Zeugnis beim Ausscheiden aus dem Unternehmen. Es sollte wahrheitsgem√§√ü sein, aber auch wohlwollend formuliert.", correctAnswer: "20"}
            ],
            situations: [
              {id: "11", text: "Sie wollen wissen, welche Fragen in einem Vorstellungsgespr√§ch nicht gestellt werden d√ºrfen."},
              {id: "12", text: "Sie m√ºssen f√ºr eine Bewerbung ein Projekt selbstst√§ndig bearbeiten und pr√§sentieren."},
              {id: "13", text: "Sie m√∂chten wissen, welche Unterlagen zu einer vollst√§ndigen Bewerbung geh√∂ren."},
              {id: "14", text: "Sie sollen an einem Auswahlverfahren teilnehmen, bei dem mehrere Kandidaten gemeinsam gepr√ºft werden."},
              {id: "15", text: "Sie sind arbeitslos und suchen Informationen √ºber finanzielle Unterst√ºtzung."},
              {id: "16", text: "Sie suchen nach einer M√∂glichkeit, Berufserfahrung zu sammeln und Kontakte zu kn√ºpfen."},
              {id: "17", text: "Sie bereiten sich auf ein Vorstellungsgespr√§ch vor und wollen sich √ºber das Unternehmen informieren."},
              {id: "18", text: "Sie haben eine neue Stelle angefangen und wollen wissen, wie lange die Probezeit dauert."},
              {id: "19", text: "Sie m√∂chten sich beruflich weiterbilden und suchen nach F√∂rderm√∂glichkeiten."},
              {id: "20", text: "Sie scheiden aus einem Unternehmen aus und wollen ein Arbeitszeugnis erhalten."}
            ]
          },
          { 
            id: "s4", 
            title: "Sprachbausteine, Teil 1", 
            points: 15,
            passageTitle: "Aufgabe: Erg√§nzen Sie den Text. W√§hlen Sie f√ºr jede L√ºcke das passende Wort.",
            passage: "",
            questions:[],
            fillBlanks: [
              {
                id: "21",
                options: ["wegen", "von", "auf"],
                correctAnswer: "auf"
              },
              {
                id: "22",
                options: ["zu", "aus", "ab"],
                correctAnswer: "ab"
              },
              {
                id: "23",
                options: ["kaum", "fast", "ein bisschen"],
                correctAnswer: "ein bisschen"
              },
              {
                id: "24",
                options: ["unterrichten", "machen", "lernen"],
                correctAnswer: "machen"
              },
              {
                id: "25",
                options: ["√ºber", "f√ºr", "an"],
                correctAnswer: "an"
              },
              {
                id: "26",
                options: ["irgendwo", "irgendjemanden", "irgendetwas"],
                correctAnswer: "irgendjemanden"
              },
              {
                id: "27",
                options: ["falls", "dass", "daf√ºr"],
                correctAnswer: "dass"
              },
              {
                id: "28",
                options: ["schon", "noch", "bevor"],
                correctAnswer: "schon"
              },
              {
                id: "29",
                options: ["zu", "am", "nach"],
                correctAnswer: "vor"
              },
              {
                id: "30",
                options: ["weniger", "viel", "mehr"],
                correctAnswer: "mehr"
              }
            ],
            fillText: `Liebe Familie Geissler, oder Dippold

vielen Dank f√ºr Ihre Antwort ________ (21) meine Bewerbung als Au-pair-M√§dchen. Danke sch√∂n auch f√ºr die Fotos von den Kindern. Ich bin schon sehr gespannt und freue mich sehr Ihre Familie im September kennenzulernen!

Im Juni schlie√üe ich meine Schulausbildung ________ (22) und m√∂chte auch noch mein Deutsch ________ (23) verbessern. Daf√ºr werde ich im Sommer noch einen Sprachkurs an einer Sommerschule in meiner Heimat ________ (24). Anschlie√üend fahre ich mit meiner Familie f√ºr drei Wachen in Urlaub ans Meer.

Ich habe noch eine Frage ________ (25) Sie. Sie schreiben, dass Sie f√ºr die Weihnachtsferien einen Skiurlaub planen, bei dem ich mitfahren kann, wenn ich m√∂chte. Ich habe aber keine Ski und Skibekleidung. Kann ich mir diese Sachen bei ________ (26) ausleihen? In meiner Heimat werde ich sie kaum jemals wieder brauchen. Aber ich bin immer offen f√ºr Neues und m√∂chte das Skilaufen gern einmal ausprobieren.

Danke sch√∂n, ________ (27) Sie mich am Flughafen abholen kommen. Ich habe meinen Flug ________ (28) gebucht. Am 2.9. werde ich sehr fr√ºh in Frankfurt laden, n√§mlich um 5:15 Uhr. Ich schlage ________ (29), dass wir uns erst gegen 7:30 Uhr in einem Caf√© treffen. Vielleicht komme ich ja mit Versp√§tung oder muss l√§nger auf mein Gep√§ck warten. Dann m√ºssen Sie nicht so fr√ºh da sein. nach Frankfurt

Bitte schreiben Sie mir, wenn Sie noch etwas √ºber mich wissen m√∂chten! Ich schicke einige Fotos mit der Mail, damit die Kinder schon ein bisschen ________ (30) von mir sehen.

Viele Gr√º√üe

Ihre Asja`
          },
          { 
            id: "s5", 
            title: "Sprachbausteine, Teil 2", 
            points: 15,
            passageTitle: "Aufgabe: Lesen Sie den Text und entscheiden Sie, welches Wort in welche L√ºcke passt. Sie k√∂nnen jedes Wort nur einmal verwenden. Nicht alle W√∂rter passen in den Text.",
            passage: "",
            questions:[],
            fillBlanks2: [
              {
                id: "31",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "RECHNEN"
              },
              {
                id: "32", 
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "G√úLTIG"
              },
              {
                id: "33",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "VOR"
              },
              {
                id: "34",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "SOLLTE"
              },
              {
                id: "35",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "SO"
              },
              {
                id: "36",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "ANPASSEN"
              },
              {
                id: "37",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "ZWAR"
              },
              {
                id: "38",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "STELLE"
              },
              {
                id: "39",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "STELLE"
              },
              {
                id: "40",
                options: ["ZWAR", "RECHNEN", "VOR", "GRAND", "STELLE", "KANN", "SOLLTE", "G√úLTIG", "SO", "GELTEN", "KEINORDNEN", "DARF", "ANPASSEN", "ANGEBEN", "ALLERDINGS"],
                correctAnswer: "ANGEBEN"
              }
            ],
            fillText2: `Die wichtigsten Regeln auf der Skipiste

Wer beim Skifahren fahrl√§ssig einen anderen Sportler verletzt oder gef√§hrdet, muss auch mit rechtlichen Folgen ________ (31) Das Strafgesetzbuch ist sowohl auf der Stra√üe als auch auf der Piste ________ (32) Laut Gesetz gibt es Freiheitsstrafen bis zu 3 Monaten oder eine entsprechende Geldstrafe. Bei schwerer K√∂rperverletzung sieht das Gesetz Freiheitsstrafen bis zu 6 Monaten ________ (33) Der deutsche Skiverband hat eine Pistenordnung erarbeitet, die bei gerichtlichen Entscheidungen angewandt wird. Jeder Wintersportler ________ (34) diese Regeln kennen:

Jeder Skifahrer muss sich stets ________ (35) verhalten, dass er keinen anderen gef√§hrdet oder sch√§digt. Er muss die Zeichen und Hinweisschilder an der Piste kennen und beachten. Er muss die eigene Geschwindigkeit und Fahrweise seinem K√∂nnen und dem Gel√§nde sowie den herrschenden Wetterverh√§ltnissen ________ (36)

Ein von hinten kommender Skifahrer muss seine Fahrspur so w√§hlen, dass er vor ihm fahrende Skifahrer nicht gef√§hrdet. √úberholen darf man rechts oder links, ________ (37) immer in einem Abstand, der dem √ºberholten Skifahrer genug Raum f√ºr seine Bewegungen l√§sst. Aufsteigende Skifahrer d√ºrfen nur den ________ (38) einer Abfahrtstrecke ben√ºtzen. Dasselbe gilt f√ºr einen Skifahrer, der zu Fu√ü absteigt. Bei schlechten Sichtverh√§ltnissen ist die Benutzung des Pistenrands verboten und der Skifahrer muss diesen verlassen. Niemand sollte sich an un√ºbersichtlichen oder engen Stellen aufhalten. Gest√ºrzte Skifahrer m√ºssen eine solche ________ (39) so schnell wie m√∂glich freimachen. Bei Unf√§llen ist jeder zur Hilfeleistung verpflichtet. Jeder Zeuge oder

Verantwortliche muss bei einem Unfall au√üerdem seine Personalien ________ (40) Durch Beachtung dieser Regeln ist die Sicherheit auf den Pisten deutlich gestiegen.`
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        questionIndex: 0, 
        answers: {}, 
        marked: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      const topTiles = document.getElementById('topTiles-lesen');
      const passageTitleEl = document.getElementById('passageTitle-lesen');
      const passageContentEl = document.getElementById('passageContent-lesen');
      const sectionNameEl = document.getElementById('sectionName-lesen');
      const questionTitleEl = document.getElementById('questionTitle-lesen');
      const questionBodyEl = document.getElementById('questionBody-lesen');
      const headingsBankContainer = document.getElementById('headingsBankContainer-lesen');
      const timerEl = document.getElementById('timer-lesen');
      const statusText = document.getElementById('statusText-lesen');
      const resultBtn = document.getElementById('resultBtn-lesen');
      const resetBtn = document.getElementById('resetBtn-lesen');
      const resetSectionBtn = document.getElementById('resetSectionBtn-lesen');

      /* ===== Timer Functions ===== */
      function startTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(()=>{
          if(state.remaining <= 0){
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer(){
        if(state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay(){
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Reset Section Function ===== */
      function resetCurrentSection() {
        const currentSection = exam.sections[state.sectionIndex];
        
        if (confirm(`M√∂chten Sie wirklich den Teil "${currentSection.title}" zur√ºcksetzen? Alle Antworten in diesem Teil werden gel√∂scht.`)) {
          if (currentSection.id === 's1') {
            currentSection.texts.forEach(text => {
              delete state.answers[text.id];
            });
          } else if (currentSection.id === 's2') {
            currentSection.questions.forEach(question => {
              delete state.answers[question.id];
            });
          } else if (currentSection.id === 's3') {
            currentSection.situations.forEach(situation => {
              delete state.answers[situation.id];
            });
          } else if (currentSection.id === 's4') {
            currentSection.fillBlanks.forEach(blank => {
              delete state.answers[blank.id];
            });
          } else if (currentSection.id === 's5') {
            currentSection.fillBlanks2.forEach(blank => {
              delete state.answers[blank.id];
            });
          }
          
          renderAll();
        }
      }

      /* ===== Render ===== */
      function renderTopTiles(){ 
        topTiles.innerHTML=''; 
        exam.sections.forEach((sec,idx)=>{ 
          const div=document.createElement('div'); 
          div.className='tile'+(idx===state.sectionIndex?' active':'')+(isSectionDone(sec)?' done':''); 
          div.innerHTML=`<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick=()=>{state.sectionIndex=idx; state.questionIndex=0; state.showResults=false; renderAll();}; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section){
        if(section.id==='s1') return section.texts.every(t=>state.answers[t.id]);
        if(section.id==='s2') return section.questions.every(q=>state.answers[q.id]);
        if(section.id==='s3') return section.situations.every(h=>state.answers[h.id] || state.answers[h.id] === 'X');
        if(section.id==='s4') return section.fillBlanks.every(b=>state.answers[b.id]);
        if(section.id==='s5') return section.fillBlanks2.every(b=>state.answers[b.id]);
        return false;
      }

      function renderAll(){
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        sectionNameEl.textContent = section.title;
        passageTitleEl.textContent = section.passageTitle;
        
        resetSectionBtn.style.display = 'block';
        
        if(state.showResults){
          renderResults();
          return;
        }
        
        if(section.id === 's1'){
          renderPart1();
        } else if(section.id === 's2'){
          renderPart2();
        } else if(section.id === 's3'){
          renderPart3();
        } else if(section.id === 's4'){
          renderSprachbausteine1();
        } else if(section.id === 's5'){
          renderSprachbausteine2();
        }
      }

      function renderPart1(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `<div class="instructions">Ziehen Sie die passenden √úberschriften auf die Texte. Sie k√∂nnen jede √úberschrift nur einmal verwenden.</div>`;
        
        section.texts.forEach((text, idx) => {
          const letter = String.fromCharCode(97 + idx);
          const selectedHeading = state.answers[text.id];
          
          textsHTML += `
            <div class="text-container">
              <div class="text-title">Text ${letter.toUpperCase()}</div>
              <div class="text-content">${text.content}</div>
              <div class="title-slot ${selectedHeading ? 'has-title' : ''}" data-text-id="${text.id}">
                ${selectedHeading ? getHeadingTextById(selectedHeading) : 'Ziehen Sie hier eine √úberschrift hin'}
              </div>
            </div>
          `;
        });
        
        passageContentEl.innerHTML = textsHTML;
        
        let headingsHTML = `<div class="headings-bank">`;
        section.headings.forEach(heading => {
          const isUsed = section.texts.some(text => state.answers[text.id] === heading.id);
          
          headingsHTML += `
            <div class="heading-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-heading-id="${heading.id}">
              ${heading.id}) ${heading.text}
            </div>
          `;
        });
        
        headingsHTML += `</div>`;
        
        headingsBankContainer.innerHTML = headingsHTML;
        
        setupDragAndDrop();
        
        questionBodyEl.innerHTML = '';
        questionTitleEl.textContent = '';
      }

      function getHeadingTextById(id){
        const section = exam.sections[state.sectionIndex];
        const heading = section.headings.find(h => h.id === id);
        return heading ? `${heading.id}) ${heading.text}` : '';
      }

      function setupDragAndDrop(){
        const headingItems = document.querySelectorAll('.heading-item:not(.used)');
        const titleSlots = document.querySelectorAll('.title-slot');
        
        headingItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.headingId);
          });
        });
        
        titleSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            slot.style.background = slot.classList.contains('has-title') ? '#e8fbe9' : '#f8fbff';
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const headingId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === headingId) {
                delete state.answers[key];
              }
            });
            
            state.answers[textId] = headingId;
            renderAll();
          });
        });
      }

      function renderPart2(){
        const section = exam.sections[state.sectionIndex];
        
        passageContentEl.innerHTML = `<div class="passage">${section.passage}</div>`;
        
        let questionsHTML = `<div class="all-questions">`;
        
        section.questions.forEach((question, idx) => {
          const questionNumber = idx + 1;
          const userAnswer = state.answers[question.id];
          
          questionsHTML += `
            <div class="question-block">
              <div class="question-text">${questionNumber}. ${question.text}</div>
              <div class="options">
                ${question.options.map(opt => `
                  <div class="option ${userAnswer === opt.id ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectOption('${question.id}', '${opt.id}')">
                    <div class="radio"></div>
                    <div>${opt.text}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        questionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = questionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function renderPart3(){
        const section = exam.sections[state.sectionIndex];
        
        let textsHTML = `
          <div class="instructions">Ziehen Sie die passenden Situationen auf die Texte. Sie k√∂nnen jede Situation nur einmal verwenden. Manchmal passt keine Situation.</div>
          <div class="texts-list">
            <h3>Texte (A-L)</h3>
        `;
        
        section.texts.forEach(text => {
          const userAnswer = Object.keys(state.answers).find(key => state.answers[key] === text.id);
          const selectedSituation = userAnswer ? section.situations.find(h => h.id === userAnswer) : null;
          
          textsHTML += `
            <div class="text-item" data-text-id="${text.id}">
              <div class="text-letter">${text.id})</div>
              <div class="text-content">${text.text}</div>
              <div class="title-slot ${userAnswer ? 'has-title' : ''} ${userAnswer === 'X' ? 'has-x' : ''}" data-text-id="${text.id}">
                ${selectedSituation ? selectedSituation.text : (userAnswer === 'X' ? 'X - Keine passende Situation' : 'Ziehen Sie hier eine Situation hin')}
              </div>
            </div>
          `;
        });
        
        textsHTML += `</div>`;
        
        passageContentEl.innerHTML = textsHTML;
        
        let situationsHTML = `
          <div class="situations-list">
            <h3>Situationen (11-20)</h3>
        `;
        
        section.situations.forEach((situation, idx) => {
          const situationNumber = parseInt(situation.id);
          const isUsed = state.answers[situation.id];
          const isX = state.answers[situation.id] === 'X';
          
          situationsHTML += `
            <div class="situation-item ${isUsed ? 'used' : ''}" draggable="${!isUsed}" data-situation-id="${situation.id}">
              <div class="situation-number">${situationNumber}.</div>
              <div class="situation-text">${situation.text}</div>
              ${!isUsed ? `<button class="exam-btn no-match ${isX ? 'selected' : ''}" onclick="window.lesenApp.markNoMatch('${situation.id}')">X - Kein passender Text</button>` : ''}
            </div>
          `;
        });
        
        situationsHTML += `</div>`;
        
        questionBodyEl.innerHTML = situationsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
        
        setupPart3DragAndDrop();
      }

      function markNoMatch(situationId) {
        Object.keys(state.answers).forEach(key => {
          if(state.answers[key] === situationId) {
            delete state.answers[key];
          }
        });
        
        state.answers[situationId] = 'X';
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function setupPart3DragAndDrop(){
        const situationItems = document.querySelectorAll('.situation-item:not(.used)');
        const textSlots = document.querySelectorAll('.text-item .title-slot');
        
        situationItems.forEach(item => {
          item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.situationId);
          });
        });
        
        textSlots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.style.background = '#e8f4ff';
          });
          
          slot.addEventListener('dragleave', (e) => {
            const hasTitle = slot.classList.contains('has-title');
            const hasX = slot.classList.contains('has-x');
            slot.style.background = hasTitle ? '#e8fbe9' : (hasX ? '#f8d7da' : '#f8fbff');
          });
          
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const situationId = e.dataTransfer.getData('text/plain');
            const textId = slot.dataset.textId;
            
            Object.keys(state.answers).forEach(key => {
              if(state.answers[key] === situationId) {
                delete state.answers[key];
              }
            });
            
            state.answers[situationId] = textId;
            renderAll();
          });
        });
      }

      function renderSprachbausteine1(){
        const section = exam.sections[state.sectionIndex];
        
        let textWithBlanks = section.fillText;
        
        const blankPlaceholders = [];
        section.fillBlanks.forEach(blank => {
          blankPlaceholders.push(`BLANK_${blank.id}`);
        });
        
        let tempText = textWithBlanks;
        blankPlaceholders.forEach((placeholder, index) => {
          tempText = tempText.replace('________', placeholder);
        });
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          const displayText = userAnswer ? userAnswer : '________';
          tempText = tempText.replace(`BLANK_${blank.id}`, `<span class="blank-word ${userAnswer ? 'has-answer' : ''}" data-blank-id="${blank.id}">${displayText}</span>`);
        });
        
        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede L√ºcke und w√§hlen Sie das passende Wort aus. Sie k√∂nnen die L√ºcken in beliebiger Reihenfolge ausf√ºllen.</div>
          <div class="fill-blank-container">${tempText}</div>
        `;
        
        document.querySelectorAll('.blank-word').forEach(blank => {
          blank.addEventListener('click', (e) => {
            showOptionsPopup(e.target);
          });
        });
        
        let optionsHTML = `<div class="horizontal-options" style="gap: 8px;">`;
        
        section.fillBlanks.forEach(blank => {
          const userAnswer = state.answers[blank.id];
          
          optionsHTML += `
            <div class="option-row" style="padding: 8px; margin-bottom: 5px;">
              <div class="option-number">${blank.id}</div>
              <div class="option-buttons">
                ${blank.options.map(opt => `
                  <div class="option-btn ${userAnswer === opt ? 'selected' : ''}" 
                       onclick="window.lesenApp.selectSprachbausteine1('${blank.id}', '${opt}')" 
                       style="padding: 6px 12px; font-size: 12px;">
                    ${opt}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        optionsHTML += `</div>`;
        
        questionBodyEl.innerHTML = optionsHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';
      }

      function showOptionsPopup(blankElement){
        const existingPopup = document.querySelector('.options-popup');
        if(existingPopup) {
          existingPopup.remove();
        }
        
        const blankId = blankElement.getAttribute('data-blank-id');
        const section = exam.sections.find(s => s.id === 's4');
        const blank = section.fillBlanks.find(b => b.id === blankId);
        
        if(!blank) return;
        
        const popup = document.createElement('div');
        popup.className = 'options-popup';
        
        blank.options.forEach(opt => {
          const optionItem = document.createElement('div');
          optionItem.className = 'option-item';
          optionItem.textContent = opt;
          optionItem.onclick = () => {
            selectSprachbausteine1(blankId, opt);
            popup.remove();
          };
          popup.appendChild(optionItem);
        });
        
        blankElement.appendChild(popup);
      }

      function selectSprachbausteine1(blankId, answer){
        state.answers[blankId] = answer;
        renderAll();
      }

      function renderSprachbausteine2(){
        const section = exam.sections[state.sectionIndex];
        // Build text but replace blanks with unique placeholders first (prevents ambiguous replacements)
        let textWithPlaceholders = section.fillText2;
        const placeholders = [];
        section.fillBlanks2.forEach(blank => {
          const ph = `BLANK_${blank.id}`;
          placeholders.push({id: blank.id, ph});
          // replace first occurrence of the visual underline with placeholder
          textWithPlaceholders = textWithPlaceholders.replace('________', ph);
        });

        // Now replace placeholders with actual span elements showing current answer (or underscore)
        placeholders.forEach(item => {
          const userAnswer = state.answers[item.id];
          const displayText = userAnswer ? userAnswer : '________';
          const span = `<span class="blank-slot ${userAnswer ? 'has-answer' : ''}" data-blank-id="${item.id}">${displayText}</span>`;
          textWithPlaceholders = textWithPlaceholders.replace(item.ph, span);
        });

        passageContentEl.innerHTML = `
          <div class="instructions">Klicken Sie auf jede L√ºcke und w√§hlen Sie das passende Wort aus. Sie k√∂nnen jedes Wort nur einmal verwenden.</div>
          <div class="fill-blank-container">${textWithPlaceholders}</div>
        `;

        // attach click handlers to slots
        document.querySelectorAll('.blank-slot').forEach(slot => {
          slot.addEventListener('click', (e) => {
            // use the element itself to open popup
            showSprachbausteine2Options(slot);
          });
        });

        // Build word bank on the right
        let wordBankHTML = `<div class="word-bank-vertical" style="gap: 8px;">`;
        const usedWords = Object.values(state.answers);
        // Use section.wordBank if present, otherwise derive from fillBlanks2 options
        const bank = section.wordBank && section.wordBank.length ? section.wordBank : (section.fillBlanks2[0] ? section.fillBlanks2[0].options : []);
        bank.forEach(word => {
          const isUsed = usedWords.includes(word);
          wordBankHTML += `
            <div class="bank-word-vertical ${isUsed ? 'used' : ''}" 
                 draggable="${!isUsed}" 
                 data-word="${word}"
                 ${!isUsed ? `onclick="window.lesenApp.selectSprachbausteine2FromBank('${word}')"` : ''}>
              ${word}
            </div>
          `;
        });
        wordBankHTML += `</div>`;
        questionBodyEl.innerHTML = wordBankHTML;
        questionTitleEl.textContent = '';
        headingsBankContainer.innerHTML = '';

        setupSprachbausteine2DragAndDrop();
      }

      // --- Added functions to handle drag/drop and clicks for Sprachbausteine Teil 2 ---
      let lastClickedSprachSlot = null;

      function setupSprachbausteine2DragAndDrop(){
        // bank words: make draggable if not used, attach dragstart
        const bankWords = Array.from(document.querySelectorAll('.bank-word-vertical'));
        bankWords.forEach(el => {
          const word = el.dataset.word;
          if(!el.classList.contains('used')){
            el.setAttribute('draggable','true');
          } else {
            el.setAttribute('draggable','false');
          }
          // ensure single attached listener
          el.removeEventListener('dragstart', el._dstart);
          el._dstart = (e) => {
            e.dataTransfer.setData('text/plain', word);
            // also set an indicator
            e.dataTransfer.setData('source', 'bank');
          };
          el.addEventListener('dragstart', el._dstart);

          // keep onclick behavior (select into clicked slot)
          el.removeEventListener('click', el._onclick);
          el._onclick = () => {
            if(el.classList.contains('used')) return;
            selectSprachbausteine2FromBank(word);
          };
          el.addEventListener('click', el._onclick);
        });

        // blank slots: allow drop
        const slots = Array.from(document.querySelectorAll('.blank-slot'));
        slots.forEach(slot => {
          slot.addEventListener('dragover', (e) => {
            e.preventDefault();
            slot.classList.add('drag-over');
          });
          slot.addEventListener('dragleave', (e) => {
            slot.classList.remove('drag-over');
          });
          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            slot.classList.remove('drag-over');
            const word = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html');
            if(!word) return;
            // Determine blank id
            const blankId = slot.dataset.blankId;
            if(!blankId) return;
            // If this word is already used in another slot, free it
            Object.keys(state.answers).forEach(k => {
              if(state.answers[k] === word){
                delete state.answers[k];
              }
            });
            // If slot had a previous answer, free that bank word
            const prev = state.answers[blankId];
            if(prev){
              const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
              if(prevEl){
                prevEl.classList.remove('used');
                prevEl.setAttribute('draggable','true');
                prevEl.addEventListener('click', prevEl._onclick);
              }
            }
            // mark bank word used
            const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
            if(bankEl){
              bankEl.classList.add('used');
              bankEl.setAttribute('draggable','false');
              // remove click to prevent double-placing
              bankEl.removeEventListener('click', bankEl._onclick);
            }
            // assign to state and re-render
            state.answers[blankId] = word;
            renderAll();
          });
        });
      }

      function showSprachbausteine2Options(slot){
        // highlight selected slot so click from bank knows target
        document.querySelectorAll('.blank-slot').forEach(s => s.classList.remove('selected-sprach'));
        slot.classList.add('selected-sprach');
        lastClickedSprachSlot = slot;
      }

      function selectSprachbausteine2FromBank(word){
        // choose target slot: prefer lastClicked, otherwise first empty
        let slot = lastClickedSprachSlot;
        if(!slot){
          slot = Array.from(document.querySelectorAll('.blank-slot')).find(s => {
            const id = s.dataset.blankId;
            return !state.answers[id];
          });
        }
        if(!slot) {
          // if none available, do nothing
          return;
        }
        const blankId = slot.dataset.blankId;
        // free previous occurrence of word
        Object.keys(state.answers).forEach(k => {
          if(state.answers[k] === word){
            delete state.answers[k];
          }
        });
        // free previous word in target slot
        const prev = state.answers[blankId];
        if(prev){
          const prevEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === prev);
          if(prevEl){
            prevEl.classList.remove('used');
            prevEl.setAttribute('draggable','true');
            if(prevEl._onclick) prevEl.addEventListener('click', prevEl._onclick);
          }
        }
        // mark selected bank word as used
        const bankEl = Array.from(document.querySelectorAll('.bank-word-vertical')).find(b=>b.dataset.word === word);
        if(bankEl){
          bankEl.classList.add('used');
          bankEl.setAttribute('draggable','false');
          if(bankEl._onclick) try{ bankEl.removeEventListener('click', bankEl._onclick); }catch(e){}
        }
        // assign value
        state.answers[blankId] = word;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        lastClickedSprachSlot = null;
        renderAll();
      }

      function selectOption(questionId, optionId){
        state.answers[questionId] = optionId;
        try{ localStorage.setItem('lesenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        renderAll();
      }

      function renderResults(){
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        let totalCorrect = 0;
        let totalQuestions = 0;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="result-item"><h3>${section.title}</h3>`;
          
          if(section.id === 's1'){
            section.texts.forEach(text => {
              totalQuestions++;
              const userAnswer = state.answers[text.id];
              const isCorrect = userAnswer === text.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Text ${text.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '‚úì' : '‚úó'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's2'){
            section.questions.forEach(question => {
              totalQuestions++;
              const userAnswer = state.answers[question.id];
              const isCorrect = userAnswer === question.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>${question.text}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '‚úì' : '‚úó'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's3'){
            section.situations.forEach(situation => {
              totalQuestions++;
              const userAnswer = state.answers[situation.id];
              const correctText = section.texts.find(t => t.correctAnswer === situation.id);
              const isCorrect = userAnswer === (correctText ? correctText.id : null);
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>Situation ${situation.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '‚úì' : '‚úó'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's4'){
            section.fillBlanks.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>L√ºcke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '‚úì' : '‚úó'}</span>` : ''}
                </div>
              `;
            });
          } else if(section.id === 's5'){
            section.fillBlanks2.forEach(blank => {
              totalQuestions++;
              const userAnswer = state.answers[blank.id];
              const isCorrect = userAnswer === blank.correctAnswer;
              if(isCorrect) totalCorrect++;
              
              resultsHTML += `
                <div>L√ºcke ${blank.id}: ${userAnswer || 'Nicht beantwortet'} 
                ${userAnswer ? `<span class="${isCorrect ? 'result-correct' : 'result-incorrect'}">${isCorrect ? '‚úì' : '‚úó'}</span>` : ''}
                </div>
              `;
            });
          }
          
          resultsHTML += `</div>`;
        });
        
        const percentage = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        resultsHTML += `<div class="result-item"><h3>Gesamtergebnis: ${totalCorrect}/${totalQuestions} (${percentage}%)</h3></div>`;
        
        passageContentEl.innerHTML = resultsHTML;
        questionBodyEl.innerHTML = '';
        sectionNameEl.textContent = 'Ergebnisse';
        questionTitleEl.textContent = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex > 0){
          state.sectionIndex--;
          state.questionIndex = 0;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        if(state.sectionIndex < exam.sections.length - 1){
          state.sectionIndex++;
          state.questionIndex = 0;
          renderAll();
        }
      });

      resultBtn.addEventListener('click', ()=>{
        state.showResults = !state.showResults;
        renderAll();
      });

      resetBtn.addEventListener('click', ()=>{
        if(confirm('M√∂chten Sie wirklich von neu beginnen? Alle Antworten werden gel√∂scht.')){
          state.answers = {};
          state.marked = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      resetSectionBtn.addEventListener('click', resetCurrentSection);

      document.getElementById('saveBtn-lesen').addEventListener('click', ()=>{
        statusText.textContent = 'Gespeichert';
        setTimeout(()=>{statusText.textContent = 'Nicht gespeichert'}, 2000);
      });

      document.getElementById('submitBtn-lesen').addEventListener('click', ()=>{
        if(confirm('M√∂chten Sie die Pr√ºfung wirklich abgeben?')){
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-lesen').addEventListener('click', ()=>{
        showPage('hoeren-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
      window._lesenState = state;
      window.lesenApp = {
        selectOption,
        markNoMatch,
        selectSprachbausteine1,
        selectSprachbausteine2FromBank
      };
    }

    // ===== H√ñREN PAGE FUNCTIONALITY =====
    function initHoerenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-h√∂rverstehen",
        durationSec: 17 * 60, // 17 minutes in seconds
        sections: [
          { 
            id: "h√∂rverstehen1", 
            title: "H√∂rverstehen, Teil 1", 
            points: 25,
            correctAnswers: { "41": "richtig", "42": "falsch", "43": "falsch", "44": "falsch", "45": "richtig" },
            questions: [
              {
                id: "41",
                text: "Kunden der Fluggesellschaft DL √§u√üern Unzufriedenheit"
              },
              {
                id: "42", 
                text: "Preise von S√º√üwaren wurden nicht gesenkt"
              },
              {
                id: "43",
                text: "Sonnenst√ºrme hatten negative Auswirkungen"
              },
              {
                id: "44",
                text: "Kein Kandidat konnte die Mehrheit auf seine Seite bringen"
              },
              {
                id: "45",
                text: "Tiefdruckgebiet 'Helena' kann Verkehrsprobleme verursachen"
              }
            ]
          },
          { 
            id: "h√∂rverstehen2", 
            title: "H√∂rverstehen, Teil 2", 
            points: 25,
            correctAnswers: { "46": "falsch", "47": "falsch", "48": "richtig", "49": "richtig", "50": "falsch", "51": "falsch", "52": "richtig", "53": "richtig", "54": "richtig", "55": "richtig" },
            questions: [
              {
                id: "46",
                text: "Herr Gasser und Frau Janke haben nicht zusammen Urlaub gemacht"
              },
              {
                id: "47",
                text: "Josef Gasser ist kein geb√ºrtiger Tiroler"
              },
              {
                id: "48", 
                text: "Bergbauern k√∂nnen kaum vom Verkauf ihrer Produkte leben"
              },
              {
                id: "49",
                text: "Steile H√§nge werden noch manuell bearbeitet"
              },
              {
                id: "50",
                text: "Josef Gasser findet nicht, dass man die Berglandschaft sich selbst √ºberlassen sollte"
              },
              {
                id: "51",
                text: "Eva Janke begeistert sich nicht mehr f√ºr Flugreisen"
              },
              {
                id: "52",
                text: "Ihren ersten Einsatz auf der Alm hat Frau Janke abgebrochen"
              },
              {
                id: "53",
                text: "F√ºr Frau Janke ist der Erholungswert trotz Anstrengung sehr hoch"
              },
              {
                id: "54",
                text: "Almhelfer k√∂nnen vielf√§ltige Aufgaben √ºbernehmen"
              },
              {
                id: "55",
                text: "√úber die Dauer des Aufenthalts kann man frei entscheiden"
              }
            ]
          },
          { 
            id: "h√∂rverstehen3", 
            title: "H√∂rverstehen, Teil 3", 
            points: 25,
            correctAnswers: { "56": "richtig", "57": "falsch", "58": "richtig", "59": "richtig", "60": "richtig" },
            questions: [
              {
                id: "56",
                text: "Tochter kann am Freitag verschiedene Sportarten testen"
              },
              {
                id: "57",
                text: "Keine Online-Anmeldung zum Blutspenden m√∂glich"
              },
              {
                id: "58",
                text: "Heute muss man auf den Bus ausweichen"
              },
              {
                id: "59",
                text: "Bad muss fr√ºher verlassen werden"
              },
              {
                id: "60",
                text: "F√ºr einen Termin muss man anrufen"
              }
            ]
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-hoeren');
      const contentContainer = document.getElementById('contentContainer-hoeren');
      const timerEl = document.getElementById('timer-hoeren');
      const statusText = document.getElementById('statusText-hoeren');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        const answers = state.answers[section.id];
        if (!answers) return false;
        
        // ÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ
        const answeredQuestions = Object.keys(answers).length;
        const totalQuestions = section.questions.length;
        
        return answeredQuestions === totalQuestions;
      }

      function renderAll() {
        renderTopTiles();
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderListeningSection();
      }

      function renderListeningSection() {
        const section = exam.sections[state.sectionIndex];
        const currentAnswers = state.answers[section.id] || {};
        
        let contentHTML = `
          <div class="panel-title">${section.title}</div>
          <div class="instructions">
            Sie h√∂ren die Nachrichten. Entscheiden Sie beim H√∂ren, ob die Aussagen richtig oder falsch sind. 
            Sie h√∂ren die Nachrichten nur einmal. Sie haben jetzt 30 Sekunden, um die Aussagen zu lesen.
          </div>
          
          <div class="listening-task">
            <table class="true-false-table">
              <thead>
                <tr>
                  <th style="width: 10%">Nr.</th>
                  <th style="width: 60%">Aussage</th>
                  <th style="width: 30%">Ihre Antwort</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        section.questions.forEach((question, index) => {
          const currentAnswer = currentAnswers[question.id] || '';
          contentHTML += `
            <tr>
              <td><strong>${question.id}</strong></td>
              <td class="question-text">${question.text}</td>
              <td>
                <div class="answer-options">
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="richtig" 
                      ${currentAnswer === 'richtig' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Richtig
                  </label>
                  <label class="answer-option">
                    <input 
                      type="radio" 
                      name="q${section.id}_${question.id}" 
                      value="falsch" 
                      ${currentAnswer === 'falsch' ? 'checked' : ''}
                      onchange="window.hoerenApp.updateListeningAnswer('${section.id}', '${question.id}', this.value)"
                    >
                    Falsch
                  </label>
                </div>
              </td>
            </tr>
          `;
        });
        
        contentHTML += `
              </tbody>
            </table>
          </div>
        `;
        
        contentContainer.innerHTML = contentHTML;
      }

      function updateListeningAnswer(sectionId, questionId, answer) {
        if (!state.answers[sectionId]) {
          state.answers[sectionId] = {};
        }
        state.answers[sectionId][questionId] = answer;
        try{ localStorage.setItem('hoerenAnswers', JSON.stringify(state.answers)); }catch(e){}
        
        
        // ÿ•ÿπÿßÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ®ŸÑÿßÿ∑ÿßÿ™ ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© "ÿ™ŸÖ"
        renderTopTiles();
      }

      function renderResults() {
        let resultsHTML = `<div class="panel-title">Ergebnisse - H√∂rverstehen</div>`;
        
        exam.sections.forEach(section => {
          const userAnswers = state.answers[section.id] || {};
          let correctCount = 0;
          
          resultsHTML += `
            <div class="listening-task">
              <h3>${section.title} (${section.points} Punkte)</h3>
              <table class="true-false-table">
                <thead>
                  <tr>
                    <th style="width: 10%">Nr.</th>
                    <th style="width: 50%">Aussage</th>
                    <th style="width: 15%">Ihre Antwort</th>
                    <th style="width: 15%">Richtige Antwort</th>
                    <th style="width: 10%">Punkte</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          section.questions.forEach((question) => {
            const userAnswer = userAnswers[question.id] || '-';
            const correctAnswer = section.correctAnswers[question.id];
            const gotCorrect = userAnswer === correctAnswer;
            const points = gotCorrect ? "1" : "0";
            
            if (gotCorrect) correctCount++;
            
            const rowClass = gotCorrect ? 'correct-answer' : 'incorrect-answer';
            
            resultsHTML += `
              <tr class="${rowClass}">
                <td><strong>${question.id}</strong></td>
                <td class="question-text">${question.text}</td>
                <td>${userAnswer}</td>
                <td>${correctAnswer}</td>
                <td><strong>${points}</strong></td>
              </tr>
            `;
          });
          
          const totalPoints = Math.round((correctCount / section.questions.length) * section.points);
          
          resultsHTML += `
                </tbody>
              </table>
              <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px;">
                <strong>Erreichte Punkte: ${correctCount}/${section.questions.length} richtig = ${totalPoints}/${section.points} Punkten</strong>
              </div>
            </div>
          `;
        });
        
        contentContainer.innerHTML = resultsHTML;
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-hoeren').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-hoeren').addEventListener('click', () => {
        if (confirm('M√∂chten Sie wirklich von neu beginnen? Alle Antworten werden gel√∂scht.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-hoeren').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-hoeren').addEventListener('click', () => {
        if (confirm('M√∂chten Sie die Pr√ºfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-hoeren').addEventListener('click', () => {
        showPage('schreiben-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._hoerenState = state;
        window.hoerenApp = {
        updateListeningAnswer
      };
    }

    // ===== SCHREIBEN PAGE FUNCTIONALITY =====
    function initSchreibenPage() {
      /* ===== Self-contained exam (embedded) ===== */
      const exam = {
        id: "exam-002",
        durationSec: 30 * 60, // 30 minutes in seconds
        sections: [
          { 
            id: "s1", 
            title: "Schreiben, Teil 1", 
            points: 45,
            passageTitle: "Aufgabe: Schreiben Sie eine E-Mail",
            passage: "",
            writingTask: {
              prompt: `M√∂chten Sie in Ihrer Freizeit mehr erleben? Neue Leute aus Mainz kennenlernen? Am Wochenende nie mehr allein sein? 
      Dann werden Sie Mitglied im Freizeitverein!
      Wir organisieren verschiedene Aktivit√§ten in Mainz und Umgebung:
      Wanderungen, Fahrradtouren, Museums- und Theaterbesuche, Spiele- und Kinoabende, Restaurantbesuche und Ausfl√ºge.
      Jede Woche stehen mindestens zwei unterschiedliche Angebote auf dem Programm.
      Ob Sport oder Kultur ‚Äì bei uns kommt jeder auf seine Kosten. Sie k√∂nnen viel Neues ausprobieren und lernen dabei nette Leute kennen.
      Unsere Mitglieder sind zwischen 26 und 85 Jahre alt. Bei uns ist jeder willkommen, ob Student oder Senior. 
      Sie finden bei uns neue Freunde und Bekannte, mit denen Sie viel erleben k√∂nnen. Probieren Sie es doch einfach mal aus!
      Die Mitgliedschaft kostet 20 Euro pro Monat.`,
              requirements: [
                "Erkl√§ren Sie, was Sie nach dem Lesen der Anzeige erwartet hatten.",
                "Erkl√§ren Sie, warum Sie mit dem Angebot des Freizeitvereins nicht zufrieden sind.",
                "Machen Sie Verbesserungsvorschl√§ge zum Programm.",
                "Erkl√§ren Sie, was Sie tun werden, wenn sich nichts √§ndert."
              ],
              wordCount: 0
            }
          }
        ]
      };

      /* ===== State & DOM refs ===== */
      let state = { 
        sectionIndex: 0, 
        answers: {}, 
        remaining: exam.durationSec,
        showResults: false,
        timerStarted: false,
        timerInterval: null
      };
      
      const topTiles = document.getElementById('topTiles-schreiben');
      const passageTitleEl = document.getElementById('passageTitle-schreiben');
      const passageContentEl = document.getElementById('passageContent-schreiben');
      const writingContainer = document.getElementById('writingContainer-schreiben');
      const timerEl = document.getElementById('timer-schreiben');
      const statusText = document.getElementById('statusText-schreiben');

      /* ===== Timer Functions ===== */
      function startTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        
        state.timerStarted = true;
        state.timerInterval = setInterval(() => {
          if (state.remaining <= 0) {
            clearInterval(state.timerInterval);
            timerEl.textContent = 'Zeit abgelaufen';
            return;
          }
          state.remaining--;
          updateTimerDisplay();
        }, 1000);
      }

      function resetTimer() {
        if (state.timerInterval) {
          clearInterval(state.timerInterval);
        }
        state.remaining = exam.durationSec;
        state.timerStarted = false;
        updateTimerDisplay();
        startTimer();
      }

      function updateTimerDisplay() {
        const min = Math.floor(state.remaining / 60);
        const sec = state.remaining % 60;
        timerEl.textContent = `Verbleibende Zeit: ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      /* ===== Render ===== */
      function renderTopTiles() { 
        topTiles.innerHTML = ''; 
        exam.sections.forEach((sec, idx) => { 
          const div = document.createElement('div'); 
          div.className = 'tile' + (idx === state.sectionIndex ? ' active' : '') + (isSectionDone(sec) ? ' done' : ''); 
          div.innerHTML = `<div>${sec.title}</div><div class="points">${sec.points} P</div>`; 
          div.onclick = () => { state.sectionIndex = idx; state.showResults = false; renderAll(); }; 
          topTiles.appendChild(div); 
        }); 
      }

      function isSectionDone(section) {
        return state.answers[section.id] && state.answers[section.id].length > 0;
      }

      function renderAll() {
        renderTopTiles();
        const section = exam.sections[state.sectionIndex];
        passageTitleEl.textContent = section.passageTitle;
        
        if (state.showResults) {
          renderResults();
          return;
        }
        
        renderWritingSection();
      }

      function renderWritingSection() {
        const section = exam.sections[state.sectionIndex];
        
        // Render the prompt in left panel
        passageContentEl.innerHTML = `
          <div class="writing-task">
            <div class="writing-prompt">${section.writingTask.prompt}</div>
            <div class="instructions" style="border:1px solid #e1e8f6; padding:10px; margin:10px 0; border-radius:6px; background:#ffffff;">Sie sind seit zwei Wochen Mitglied im Freizeitverein. Doch Sie sind nicht zufrieden. 
      Schreiben Sie eine Beschwerde.</div>
            <div class="writing-requirements">
              <h4>Schreiben Sie in Ihrer E-Mail:</h4>
              <ul>
                ${section.writingTask.requirements.map(req => `<li>${req}</li>`).join('')}
              </ul>
            </div>
            <div class="instructions">
              Schreiben Sie eine E-Mail (ca. 150-200 W√∂rter). Achten Sie auf den Textaufbau (Anrede, Einleitung, Hauptteil, Schluss) und eine angemessene Formulierung.
            </div>
          </div>
        `;
        
        // Render writing area in right panel
        const currentAnswer = state.answers[section.id] || '';
        const wordCount = countWords(currentAnswer);
        
        writingContainer.innerHTML = `
          <div class="writing-area">
            <textarea 
              class="writing-textarea" 
              placeholder="Schreiben Sie hier Ihre E-Mail..."
              oninput="window.schreibenApp.updateWritingAnswer('${section.id}', this.value)"
            >${currentAnswer}</textarea>
            <div class="word-counter">
              W√∂rter: <span class="count">${wordCount}</span>
            </div>
          </div>
        `;
      }

      function countWords(text) {
        return text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
      }

      function updateWritingAnswer(sectionId, text) {
        state.answers[sectionId] = text;
        try{ localStorage.setItem('schreibenAnswers', JSON.stringify({content: state.answers[sectionId], wordCount: (state.answers[sectionId]||'').trim().split(/\s+/).filter(Boolean).length})); }catch(e){}
        
        const wordCount = countWords(text);
        document.querySelector('.word-counter .count').textContent = wordCount;
      }

      function renderResults() {
        let resultsHTML = `<h2>Ergebnisse</h2>`;
        
        exam.sections.forEach(section => {
          resultsHTML += `<div class="writing-task"><h3>${section.title}</h3>`;
          
          const userAnswer = state.answers[section.id];
          const wordCount = countWords(userAnswer);
          
          resultsHTML += `
            <div class="writing-requirements">
              <h4>Ihre Antwort (${wordCount} W√∂rter):</h4>
              <div style="white-space: pre-wrap; background: white; padding: 15px; border-radius: 6px; border: 1px solid #e1e8f6; margin-top: 10px;">${userAnswer || 'Keine Antwort'}</div>
            </div>
          `;
          
          resultsHTML += `</div>`;
        });
        
        passageContentEl.innerHTML = resultsHTML;
        writingContainer.innerHTML = '';
      }

      /* ===== Event Listeners ===== */
      document.getElementById('prevBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex > 0) {
          state.sectionIndex--;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        if (state.sectionIndex < exam.sections.length - 1) {
          state.sectionIndex++;
          state.showResults = false;
          renderAll();
        }
      });

      document.getElementById('resultBtn-schreiben').addEventListener('click', () => {
        state.showResults = !state.showResults;
        renderAll();
      });

      document.getElementById('resetBtn-schreiben').addEventListener('click', () => {
        if (confirm('M√∂chten Sie wirklich von neu beginnen? Alle Antworten werden gel√∂schÿ™.')) {
          state.answers = {};
          state.showResults = false;
          resetTimer();
          renderAll();
        }
      });

      document.getElementById('saveBtn-schreiben').addEventListener('click', () => {
        statusText.textContent = 'Gespeichert';
        setTimeout(() => { statusText.textContent = 'Nicht gespeichert' }, 2000);
      });

      document.getElementById('submitBtn-schreiben').addEventListener('click', () => {
        if (confirm('M√∂chten Sie die Pr√ºfung wirklich abgeben?')) {
          state.showResults = true;
          renderAll();
        }
      });

      document.getElementById('nextBtn-schreiben').addEventListener('click', () => {
        showPage('ergebnisse-page');
      });

      /* ===== Initialize ===== */
      updateTimerDisplay();
      renderAll();
      startTimer();
      
      // Expose functions to global scope for event handlers
        window._schreibenState = state;
        window.schreibenApp = {
        updateWritingAnswer
      };
    }

    // ===== ERGEBNISSE PAGE FUNCTIONALITY =====
    function initErgebnissePage() {
      const CONFIG = {
        totals: { 
          lesen: 105, 
          hoeren: 75, 
          schreiben: 45, 
          gesamt: 225 
        },
        counts: { 
          lesen: 40, 
          hoeren: 20 
        },
        hoerenCorrect: {
          "41": "richtig", "42": "falsch", "43": "falsch", "44": "falsch", "45": "richtig",
          "46": "falsch", "47": "falsch", "48": "richtig", "49": "richtig", "50": "falsch",
          "51": "falsch", "52": "richtig", "53": "richtig", "54": "richtig", "55": "richtig",
          "56": "richtig", "57": "falsch", "58": "richtig", "59": "richtig", "60": "richtig"
        },
        lesenCorrect: Object.assign({},
          {"text1": "g", "text2": "h", "text3": "d", "text4": "i", "text5": "b"},
          {"s2q1": "s2q1o3", "s2q2": "s2q2o1", "s2q3": "s2q3o2", "s2q4": "s2q4o2", "s2q5": "s2q5o3"},
          {"11": "A", "12": "B", "13": "D", "14": "E", "15": "F", "16": "G", "17": "I", "18": "J", "19": "K", "20": "L"},
          {"21": "auf", "22": "ab", "23": "ein bisschen", "24": "machen", "25": "an", "26": "irgendjemanden", "27": "dass", "28": "schon", "29": "vor", "30": "mehr"},
          {"31": "RECHNEN", "32": "G√úLTIG", "33": "VOR", "34": "SOLLTE", "35": "SO", "36": "ANPASSEN", "37": "ZWAR", "38": "STELLE", "39": "STELLE", "40": "ANGEBEN"}
        )
      };

      function normalizeAnswer(a) {
        if (a === null || a === undefined) return '';
        let s = String(a).trim();
        if (s === '') return '';
        const low = s.toLowerCase();
        if (["richtig", "true", "yes", "ja"].includes(low)) return 'richtig';
        if (["falsch", "false", "no", "nein"].includes(low)) return 'falsch';
        return s;
      }

      function keyZeroToTen(k) {
        return k === '0' ? '10' : k;
      }

      function readExamResults() {
        try {
          const lesen = {};
          const hoeren = {};
          const schreiben = { content: '', wordCount: 0 };

          // 1) Try to read from in-memory states exposed by pages
          try {
            if (window._lesenState && window._lesenState.answers) {
              Object.keys(window._lesenState.answers).forEach(k => {
                lesen[k] = window._lesenState.answers[k];
              });
            }
          } catch (e) {}

          try {
            if (window._hoerenState && window._hoerenState.answers) {
              Object.keys(window._hoerenState.answers).forEach(sectionId => {
                const sec = window._hoerenState.answers[sectionId] || {};
                Object.keys(sec).forEach(q => {
                  hoeren[q] = sec[q];
                });
              });
            }
          } catch (e) {}

          try {
            if (window._schreibenState && window._schreibenState.answers) {
              const answers = window._schreibenState.answers;
              if (answers['s1']) {
                schreiben.content = answers['s1'];
              } else {
                const keys = Object.keys(answers);
                if (keys.length > 0) schreiben.content = answers[keys[0]] || '';
              }
              schreiben.wordCount = (schreiben.content && schreiben.content.trim()) ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0;
            }
          } catch (e) {}

          // 2) Fallback to localStorage if any part is still empty
          try {
            if (Object.keys(lesen).length === 0) {
              const storedL = localStorage.getItem('lesenAnswers');
              if (storedL) Object.assign(lesen, JSON.parse(storedL));
            }
          } catch (e) {}

          try {
            if (Object.keys(hoeren).length === 0) {
              const storedH = localStorage.getItem('hoerenAnswers');
              if (storedH) Object.assign(hoeren, JSON.parse(storedH));
            }
          } catch (e) {}

          try {
            if (!schreiben.content) {
              const storedS = localStorage.getItem('schreibenAnswers');
              if (storedS) {
                const obj = JSON.parse(storedS);
                schreiben.content = obj.content || '';
                schreiben.wordCount = obj.wordCount || (schreiben.content.trim() ? String(schreiben.content).trim().split(/\\s+/).filter(Boolean).length : 0);
              }
            }
          } catch (e) {}

          // final safe return
          return { hoeren, lesen, schreiben };
        } catch (e) {
          return { hoeren: {}, lesen: {}, schreiben: {} };
        }
      }

      function gradeHoeren(u) {
        const c = CONFIG.hoerenCorrect;
        let okCount = 0;
        const d = [];
        
        for (let q = 41; q <= 60; q++) {
          const k = String(q);
          const uA = normalizeAnswer(u[k] || '');
          const exp = normalizeAnswer(c[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.hoeren / CONFIG.counts.hoeren;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        }
        
        const total = Number((okCount * (CONFIG.totals.hoeren / CONFIG.counts.hoeren)).toFixed(2));
        return { okCount, total, details: d };
      }

      function gradeLesen(u) {
        const c = CONFIG.lesenCorrect;
        let okCount = 0;
        const d = [];
        
        Object.keys(c).forEach(k => {
          const exp = normalizeAnswer(c[k]);
          const uA = normalizeAnswer(u[k] || '');
          const ok = (uA !== '' && uA.toLowerCase() === exp.toLowerCase());
          if (ok) okCount++;
          const ptsPer = CONFIG.totals.lesen / CONFIG.counts.lesen;
          d.push({
            frage: k,
            user: uA || '-',
            correct: exp || '-',
            richtig: ok,
            punkte: ok ? ptsPer.toFixed(2) : '0'
          });
        });
        
        const total = Number((okCount * (CONFIG.totals.lesen / CONFIG.counts.lesen)).toFixed(2));
        return { okCount, total, details: d };
      }

      function escapeHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function buildTable(title, dets, total, max) {
        let h = `<h2>${title}</h2>
                <table class="section-table">
                  <thead>
                    <tr>
                      <th>Frage</th>
                      <th>Ihre Antwort</th>
                      <th>Richtige Antwort</th>
                      <th>Ergebnis</th>
                      <th>Punkte</th>
                    </tr>
                  </thead>
                  <tbody>`;
        
        dets.forEach(x => {
          h += `<tr>
                  <td>${x.frage}</td>
                  <td>${escapeHtml(x.user)}</td>
                  <td>${escapeHtml(x.correct)}</td>
                  <td>${x.richtig ? '‚úîÔ∏è' : '‚úñÔ∏è'}</td>
                  <td>${x.punkte}</td>
                </tr>`;
        });
        
        h += `</tbody>
              </table>
              <div class="small-muted">Teilpunkte: ${total.toFixed(2)} / ${max}</div>`;
        return h;
      }

      function renderResults() {
        const st = readExamResults() || { hoeren: {}, lesen: {}, schreiben: {} };
        const h = gradeHoeren(st.hoeren || {});
        const l = gradeLesen(st.lesen || {});
        const details = document.getElementById('details-ergebnisse');
        const tiles = document.getElementById('topTiles-ergebnisse');
        const sScoreRaw = localStorage.getItem('schreibenScore');
        const sScore = sScoreRaw ? Number(sScoreRaw) : 0; // Default score is now 0

        details.innerHTML = '';
        tiles.innerHTML = '';

        const tL = `<div class="results-tile">
                    <h3>Lesen</h3>
                    <div class="score">${l.total.toFixed(2)} / ${CONFIG.totals.lesen} Punkte</div>
                    <div class="small-muted">(${(l.total / CONFIG.totals.lesen * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tH = `<div class="results-tile">
                    <h3>H√∂ren</h3>
                    <div class="score">${h.total.toFixed(2)} / ${CONFIG.totals.hoeren} Punkte</div>
                    <div class="small-muted">(${(h.total / CONFIG.totals.hoeren * 100).toFixed(2)} %)</div>
                  </div>`;
                  
        const tS = `<div class="results-tile">
                    <h3>Schreiben</h3>
                    <div class="score" id="schreibenScoreDisplay">${sScore.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte</div>
                    <div class="small-muted">Manuelle Eingabe</div>
                  </div>`;
                  
        tiles.innerHTML = tL + tH + tS;

        details.innerHTML += buildTable('H√∂ren ‚Äî Detail', h.details, h.total, CONFIG.totals.hoeren);
        details.innerHTML += buildTable('Lesen ‚Äî Detail', l.details, l.total, CONFIG.totals.lesen);

        let sHtml = '<h2>Schreiben ‚Äî Ergebnis (manuell)</h2>';
        const txt = st.schreiben.content ? escapeHtml(st.schreiben.content) : '<span class="small-muted">Kein Text gefunden.</span>';
        const wc = st.schreiben.wordCount || '-';
        
        sHtml += `<div class="small-muted">W√∂rter: ${wc}</div>
                <div style="margin-top:10px;padding:12px;background:#fff;border-radius:8px;border:1px solid #eef6ff;min-height:80px">${txt}</div>
                <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
                  Punkte (0‚Äì45): 
                  <input id="sInput" type="number" min="0" max="45" step="0.5" value="${sScore}"> 
                  <button id="saveS" class="results-btn">Speichern</button>
                </div>`;
                
        details.innerHTML += sHtml;

        const total = (l.total + h.total + sScore).toFixed(2);
        const percent = ((total / CONFIG.totals.gesamt) * 100).toFixed(2);
        
        document.getElementById('finalSummary-ergebnisse').innerHTML = `
          <div class="left">
            Gesamtpunktzahl: <strong>${total}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
            <span class="small-muted">Lesen + H√∂ren + Schreiben</span>
          </div>
          <div class="right">
            Prozentsatz: <strong>${percent} %</strong>
          </div>`;

        document.getElementById('saveS').onclick = () => {
          const v = Number(document.getElementById('sInput').value) || 0;
          localStorage.setItem('schreibenScore', v);
          document.getElementById('schreibenScoreDisplay').textContent = `${v.toFixed(2)} / ${CONFIG.totals.schreiben} Punkte`;
          
          const newTotal = (l.total + h.total + v).toFixed(2);
          const newPercent = ((newTotal / CONFIG.totals.gesamt) * 100).toFixed(2);
          
          document.getElementById('finalSummary-ergebnisse').innerHTML = `
            <div class="left">
              Gesamtpunktzahl: <strong>${newTotal}</strong> / ${CONFIG.totals.gesamt} Punkte<br>
              <span class="small-muted">Lesen + H√∂ren + Schreiben</span>
            </div>
            <div class="right">
              Prozentsatz: <strong>${newPercent} %</strong>
            </div>`;
        };
      }

      document.getElementById('calcBtn-ergebnisse').onclick = () => renderResults();
      document.getElementById('backBtn-ergebnisse').onclick = (e) => {
        e.preventDefault();
        showPage('start-page');
      };
      
      // Initialize results on page load
      renderResults();
    }
  </script>
</body>
</html>